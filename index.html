<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø®Ø¯Ù…Ø© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ - Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-section: #1e293b;
            --text-main: white;
            --border-color: #334155;
            --input-bg: #0f172a;
            --primary: #6366f1;
            --accent: #fbbf24;
            --success: #10b981;
            --error: #ef4444;
        }

        [data-theme="light"] {
            --bg-body: #f1f5f9;
            --bg-section: #ffffff;
            --text-main: #1e293b;
            --border-color: #cbd5e1;
            --input-bg: #f8fafc;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 10px; transition: 0.3s; user-select: none; }
        
        .verse-container { background: linear-gradient(135deg, #312e81 0%, #4338ca 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px; text-align: center; border: 2px solid #6366f1; box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative; overflow: hidden; }
        .verse-text { font-size: 18px; font-weight: bold; color: #fef3c7; line-height: 1.6; margin-bottom: 8px; }
        .verse-ref { font-size: 14px; color: #c7d2fe; font-style: italic; }

        .overlay { position: fixed; inset: 0; background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
        .login-box { background: #1e293b; padding: 30px; border-radius: 20px; text-align: center; border: 2px solid #6366f1; width: 85%; max-width: 350px; }
        
        #mainContent { display: none; }
        
        #adminAlert { display: none; background: #b91c1c; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #ef4444; animation: flash 2s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .section { background: var(--bg-section); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 10px; }
        .card-stat { background: #0f172a; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .bar-wrap { height: 60px; background: #334155; border-radius: 5px; overflow: hidden; margin: 5px 0; display: flex; align-items: flex-end; }
        .bar { width: 100%; transition: height 1s; }
        .bg-high { background: linear-gradient(to top, #16a34a, #4ade80); }
        .bg-mid { background: linear-gradient(to top, #ca8a04, #facc15); }
        .bg-low { background: linear-gradient(to top, #dc2626, #f87171); }

        textarea, input[type="text"], input[type="password"], select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-main); box-sizing: border-box; margin-bottom: 10px; outline: none; }
        .btn { background: #6366f1; color: white; padding: 12px; width: 100%; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        
        .chat-display { height: 180px; overflow-y: auto; background: var(--input-bg); padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .chat-msg { background: var(--bg-section); padding: 8px 10px; border-radius: 10px; margin-bottom: 6px; font-size: 13px; border-right: 3px solid #6366f1; word-wrap: break-word; color: var(--text-main); }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© */
        .quiz-icon-btn { 
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            color: #0f172a; padding: 20px; border-radius: 15px; text-align: center;
            cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
            display: block; margin-bottom: 10px; transition: 0.3s; border: none; width: 100%;
        }
        .quiz-icon-btn:hover { transform: scale(1.02); }

        .question-card { background: var(--bg-body); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .option-label { display: block; background: var(--border-color); padding: 10px; margin: 5px 0; border-radius: 8px; cursor: pointer; }
        
        .switch-container { display: flex; justify-content: space-between; align-items: center; background: #334155; padding: 10px 15px; border-radius: 12px; margin-bottom: 15px; color: white; }
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #1e293b; transition: .4s; border-radius: 34px; border: 1px solid #475569; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 4px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ec4899; }
        input:checked + .slider:before { transform: translateX(22px); }

        .mood-container { display: flex; justify-content: space-around; margin: 15px 0; }
        .mood-btn { font-size: 28px; cursor: pointer; transition: 0.2s; opacity: 0.5; }
        .mood-btn.active { opacity: 1; transform: scale(1.2); border-bottom: 2px solid #ec4899; }

        #prayerTimer { display: none; background: #312e81; padding: 15px; border-radius: 15px; border: 2px solid #818cf8; margin-top: 15px; text-align: center; }
        .prayer-counter { font-size: 45px; font-weight: bold; color: #fbbf24; margin: 5px 0; }
        .prayer-text-display { font-size: 17px; font-weight: bold; color: #fef3c7; min-height: 60px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; text-align: center; }
        
        .theme-toggle-btn { position: absolute; top: 10px; left: 10px; background: rgba(99, 102, 241, 0.2); border: 1px solid #6366f1; color: var(--text-main); padding: 5px 10px; border-radius: 10px; font-size: 12px; cursor: pointer; z-index: 10; }
    </style>
</head>
<body>

    <div id="loginScreen" class="overlay">
        <div class="login-box">
            <h3 style="margin:0 0 10px 0; color:#818cf8;">â€  Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø®Ø¯ÙˆÙ…ÙŠÙ† â€ </h3>
            <input type="password" id="passInputUser" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
            <button class="btn" onclick="checkAccess()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="mainContent">
        <button class="theme-toggle-btn" onclick="toggleTheme()" id="themeBtn">â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­</button>

        <div class="main-title" style="text-align: center; margin-bottom: 15px;">
            <h2 style="margin:0; color: #818cf8;">Ø®Ø¯Ù…Ø© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</h2>
            <small>ÙƒÙ†ÙŠØ³Ø© Ø§Ù„Ø¹Ø°Ø±Ø§Ø¡ ÙˆØ£Ø¨ÙˆØ³ÙŠÙÙŠÙ† ÙˆØ§Ù„Ø´Ù‡ÙŠØ¯ Ø£Ø¨Ø³Ø®ÙŠØ±ÙˆÙ†</small>
        </div>

        <div class="verse-container">
            <div id="dailyVerse" class="verse-text">"Ø£ÙÙ†ÙØ§ Ù…ÙØ¹ÙÙƒÙÙ…Ù’ ÙƒÙÙ„Ù‘Ù Ø§Ù„Ø£ÙÙŠÙ‘ÙØ§Ù…Ù"</div>
            <div id="verseRef" class="verse-ref">(Ù…ØªÙ‰ 28: 20)</div>
        </div>

        <div id="adminAlert">
            <b style="display:block;">ğŸ“¢ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù† Ø§Ù„Ø®Ø¯Ø§Ù…:</b>
            <span id="alertText"></span>
        </div>

        <div id="quizSection" class="section" style="border: 2px solid var(--accent); display: none;">
            <button class="quiz-icon-btn" id="openQuizBtn" onclick="openQuizInterface()">ğŸ“– Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ù‚Ø¯Ø³ ğŸš€</button>
            
            <div id="quizFormArea" style="display:none;">
                <div style="background: rgba(251, 191, 36, 0.1); padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                    <label style="font-size: 12px; color: var(--accent);">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:</label>
                    <select id="userQuizName"><option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡...</option></select>
                </div>
                <div id="questionsList"></div>
                <button id="submitAllBtn" onclick="submitFullQuiz()" class="btn" style="background:var(--success); margin-top:10px;">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª âœ…</button>
            </div>

            <div id="quizDoneMsg" style="display:none; text-align:center; padding:20px;">
                <h3 style="color:var(--success);">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! â¤ï¸</h3>
            </div>
        </div>

        <div class="section">
            <h3 style="margin-top:0; color: #fbbf24;">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h3>
            <div id="leaderboard" class="grid"></div>
        </div>

        <div id="chatSection" class="section" style="border-right: 5px solid #6366f1;">
            <h3>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
            <div id="chatBox" class="chat-display"></div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                <button onclick="sendChat()" style="background:#6366f1; border:none; padding:0 15px; border-radius:10px; color:white;">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>

        <div class="switch-container">
            <span style="font-weight: bold;">ğŸŒ± Ø±ÙƒÙ† Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© Ø§Ù„Ù†ÙØ³ÙŠØ©</span>
            <label class="switch">
                <input type="checkbox" onchange="document.getElementById('psyArea').style.display = this.checked ? 'block' : 'none'">
                <span class="slider"></span>
            </label>
        </div>

        <div id="psyArea" class="section" style="display: none; border: 2px solid #ec4899;">
             <p style="text-align:center; font-size:13px;">Ù…Ø§ ØªØ®ÙØ´ Ø§Ø­Ù†Ø§ Ø¬Ù†Ø¨Ùƒ Ø¨Ù†Ø­Ø¨Ùƒ ÙˆØ§Ù†Øª ØºØ§Ù„ÙŠ Ø¹Ù„Ù‰ Ù‚Ù„Ø¨ Ø§Ù„Ù…Ø³ÙŠØ­.. â¤ï¸</p>
             <input type="text" id="psyNameInput" placeholder="Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="border: 1px dashed #ec4899; font-size: 13px;">
             <div class="mood-container">
                <span class="mood-btn" onclick="setMood(this, 'ğŸ˜­')">ğŸ˜­</span>
                <span class="mood-btn" onclick="setMood(this, 'ğŸ˜¥')">ğŸ˜¥</span>
                <span class="mood-btn" onclick="setMood(this, 'ğŸ˜Ÿ')">ğŸ˜Ÿ</span>
                <span class="mood-btn" onclick="setMood(this, 'ğŸ˜Œ')">ğŸ˜Œ</span>
                <span class="mood-btn" onclick="setMood(this, 'ğŸ˜Š')">ğŸ˜Š</span>
             </div>
             <select id="psyNeed">
                <option value="Ù…Ø¬Ø±Ø¯ ÙØ¶ÙØ¶Ø© ğŸ—£ï¸">ğŸ—£ï¸ Ù…Ø¬Ø±Ø¯ ÙØ¶ÙØ¶Ø©</option>
                <option value="ØµÙ„Ø§Ø© Ù…Ù† Ø£Ø¬Ù„ÙŠ ğŸ™">ğŸ™ ØµÙ„Ø§Ø© Ù…Ù† Ø£Ø¬Ù„ÙŠ</option>
                <option value="Ø¥Ù†Ù‚Ø§Ø° Ø³Ø±ÙŠØ¹ ğŸš¨">ğŸš¨ Ø¥Ù†Ù‚Ø§Ø° Ø³Ø±ÙŠØ¹</option>
                <option value="Ø¯Ø¹Ù… ÙˆØªÙˆØ¬ÙŠÙ‡ ğŸ¤">ğŸ¤ Ø¯Ø¹Ù… ÙˆØªÙˆØ¬ÙŠÙ‡</option>
            </select>
            <textarea id="psyMsg" placeholder="Ø§ÙƒØªØ¨ Ù…Ø§ Ø¨Ù‚Ù„Ø¨Ùƒ Ù‡Ù†Ø§..." style="height: 80px;"></textarea>
            <button class="btn" style="background:#ec4899; margin-bottom:15px;" onclick="sendPsyMsg()">Ø¥Ø±Ø³Ø§Ù„ ğŸ•Šï¸</button>

            <div id="psyChatContainer" style="margin-top: 5px; border-top: 1px dashed #ec4899; padding-top: 10px; margin-bottom: 15px;">
                <div id="psyLocalChat" style="height: 100px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 8px; font-size: 12px; margin-bottom: 8px;"></div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="psyChatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø³Ø±ÙŠØ©..." style="margin-bottom:0; font-size:12px; height: 35px;">
                    <button onclick="sendPsyChat()" style="background:#ec4899; border:none; padding:0 15px; border-radius:8px; color:white; font-size: 12px;">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>

            <button class="btn" style="background:#fbbf24; color:#000;" onclick="startPrayerSession()">âœ¨ ÙŠÙ„Ø§ Ù†ØµÙ„Ùˆ Ø³ÙˆØ§ (33 ØµÙ„Ø§Ø©) âœ¨</button>
            <div id="prayerTimer">
                <div class="prayer-text-display" id="activePrayer">Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡...</div>
                <div class="prayer-counter" id="pCountText">0</div>
                <button class="btn" style="background:#818cf8; height: 70px; font-size:18px;" onclick="countPrayer()">Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø¯ â”</button>
                <button class="btn" style="background:#ef4444; margin-top:10px; padding:5px; font-size: 12px;" onclick="endPrayer()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø©</button>
            </div>
        </div>

        <div class="section" style="border: 2px solid #818cf8;">
            <h3 style="color: #818cf8; margin-top:0;">â“ Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­</h3>
            <textarea id="quesMsg" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ùƒ Ù‡Ù†Ø§..." style="height: 60px;"></textarea>
            <button class="btn" style="background:#818cf8;" onclick="sendQuestion()">Ø¥Ø±Ø³Ø§Ù„ ğŸ•Šï¸</button>
        </div>
    </div>

<script>
    const config = { databaseURL: "https://jesus-bb0ba-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(config);
    const db = firebase.database();

    let psySessionID = localStorage.getItem('psy_session_id') || ("User_" + Date.now());
    localStorage.setItem('psy_session_id', psySessionID);

    let allQuestions = [], pCount = 0, currentMood = "ğŸ˜Œ";

    const bibleVerses = [
        { t: "Ù„Ø§Ù ØªÙØ®ÙÙÙ’ Ù„Ø£ÙÙ†Ù‘ÙÙŠ Ù…ÙØ¹ÙÙƒÙ. Ù„Ø§Ù ØªÙØªÙÙ„ÙÙÙ‘ÙØªÙ’ Ù„Ø£ÙÙ†Ù‘ÙÙŠ Ø¥ÙÙ„Ù‡ÙÙƒÙ. Ù‚ÙØ¯Ù’ Ø£ÙÙŠÙ‘ÙØ¯Ù’ØªÙÙƒÙ ÙˆÙØ£ÙØ¹ÙÙ†Ù’ØªÙÙƒÙ.", r: "Ø¥Ø´Ø¹ÙŠØ§Ø¡ 41: 10" },
        { t: "Ø§ÙØ³Ù’ØªÙØ·ÙÙŠØ¹Ù ÙƒÙÙ„Ù‘Ù Ø´ÙÙŠÙ’Ø¡Ù ÙÙÙŠ Ø§Ù„Ù’Ù…ÙØ³ÙÙŠØ­Ù Ø§Ù„Ù‘ÙØ°ÙÙŠ ÙŠÙÙ‚ÙÙˆÙ‘ÙÙŠÙ†ÙÙŠ.", r: "ÙÙŠÙ„Ø¨ÙŠ 4: 13" },
        { t: "ÙŠÙØ§ Ø§Ø¨Ù’Ù†ÙÙŠ Ø£ÙØ¹Ù’Ø·ÙÙ†ÙÙŠ Ù‚ÙÙ„Ù’Ø¨ÙÙƒÙØŒ ÙˆÙÙ„Ù’ØªÙÙ„Ø§ÙØ­ÙØ¸Ù’ Ø¹ÙÙŠÙ’Ù†ÙØ§ÙƒÙ Ø·ÙØ±ÙÙ‚ÙÙŠ.", r: "Ø£Ù…Ø«Ø§Ù„ 23: 26" }
    ];

    const prayers = ["ÙŠØ§Ø±Ø¨ ÙŠØ³ÙˆØ¹ Ø§Ù„Ù…Ø³ÙŠØ­ Ø§Ø±Ø­Ù…Ù†ÙŠ", "ÙŠØ§ ÙŠØ³ÙˆØ¹ Ø³Ø§Ø¹Ø¯Ù†ÙŠ Ø£Ø­Ø¨Ùƒ"];

    function checkAccess() {
        if(document.getElementById('passInputUser').value === "jesus") {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            initApp();
        } else { alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£!"); }
    }

    function initApp() {
        showRandomVerse();
        
        db.ref("settings/quizEnabled").on("value", snap => {
            document.getElementById('quizSection').style.display = snap.val() ? 'block' : 'none';
        });

        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        db.ref("points_data").on("value", snap => {
            const selector = document.getElementById('userQuizName');
            const leaderboard = document.getElementById('leaderboard');
            selector.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ --</option>';
            leaderboard.innerHTML = "";
            
            snap.forEach(child => {
                const d = child.val();
                selector.innerHTML += `<option value="${d.name}">${d.name}</option>`;
                leaderboard.innerHTML += `<div class="card-stat"><div style="font-weight:bold; color:#fbbf24;">${d.score}</div><div>${d.name}</div></div>`;
            });
        });

        db.ref("bible_quiz/questions").on("value", snap => {
            const list = document.getElementById('questionsList');
            list.innerHTML = "";
            allQuestions = [];
            let idx = 0;
            snap.forEach(child => {
                const q = child.val();
                allQuestions.push({...q, id: child.key});
                let html = `<div class="question-card"><div style="font-weight:bold; margin-bottom:10px; color:var(--accent);">${idx+1}. ${q.text}</div>`;
                if(q.type === 'choice' || q.type === 'truefalse') {
                    q.options.forEach(opt => {
                        html += `<label class="option-label"><input type="radio" name="q_${idx}" value="${opt}"> ${opt}</label>`;
                    });
                } else {
                    html += `<input type="text" id="ans_${idx}" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‡Ù†Ø§...">`;
                }
                html += `</div>`;
                list.innerHTML += html;
                idx++;
            });
        });

        db.ref("chat").limitToLast(15).on("value", snap => {
            const box = document.getElementById('chatBox'); box.innerHTML = "";
            snap.forEach(c => { box.innerHTML += `<div class="chat-msg"><b>${c.val().sender}:</b> ${c.val().text}</div>`; });
            box.scrollTop = box.scrollHeight;
        });

        db.ref("admin_announcement").on("value", snap => {
            const text = snap.val();
            document.getElementById('adminAlert').style.display = (text && text.trim() !== "") ? 'block' : 'none';
            document.getElementById('alertText').innerText = text;
        });
    }

    function openQuizInterface() {
        document.getElementById('openQuizBtn').style.display = 'none';
        document.getElementById('quizFormArea').style.display = 'block';
    }

    async function submitFullQuiz() {
        const myName = document.getElementById('userQuizName').value;
        if(!myName) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹!");

        let totalPoints = 0;
        allQuestions.forEach((q, idx) => {
            let userAns = "";
            if(q.type === 'choice' || q.type === 'truefalse') {
                const selected = document.querySelector(`input[name="q_${idx}"]:checked`);
                userAns = selected ? selected.value : "";
            } else {
                userAns = document.getElementById(`ans_${idx}`).value;
            }
            if(userAns.trim().toLowerCase() === q.correctAnswer.trim().toLowerCase()) {
                totalPoints += parseInt(q.points || 1);
            }
        });

        await db.ref("bible_quiz/submissions").push({ userName: myName, score: totalPoints, time: new Date().toLocaleString() });
        db.ref("points_data").once("value", snap => {
            snap.forEach(child => {
                if(child.val().name === myName) {
                    child.ref.update({ score: (child.val().score || 0) + totalPoints });
                }
            });
        });

        document.getElementById('quizFormArea').style.display = 'none';
        document.getElementById('quizDoneMsg').style.display = 'block';
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    }

    function sendChat() {
        const inp = document.getElementById('chatInput');
        if(inp.value.trim()) { db.ref("chat").push({sender: "Ù…Ø®Ø¯ÙˆÙ…", text: inp.value}); inp.value = ""; }
    }
    function setMood(el, mood) { 
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active'); currentMood = mood; 
    }
    function sendPsyMsg() {
        const txt = document.getElementById('psyMsg').value;
        db.ref("psychology/confessions").push({ sender: document.getElementById('psyNameInput').value || "Ø§Ø¨Ù† Ø§Ù„Ø·Ø§Ø¹Ø©", mood: currentMood, text: txt });
        alert("ÙˆØµÙ„Øª Ø±Ø³Ø§Ù„ØªÙƒ Ø¨Ø®ØµÙˆØµÙŠØ©.. â¤ï¸"); document.getElementById('psyMsg').value = "";
    }
    function startPrayerSession() { document.getElementById('prayerTimer').style.display = 'block'; pCount = 0; }
    function countPrayer() { 
        pCount++; 
        document.getElementById('pCountText').innerText = pCount;
        document.getElementById('activePrayer').innerText = prayers[pCount % prayers.length];
    }
    function endPrayer() { document.getElementById('prayerTimer').style.display = 'none'; alert("ØµÙ„Ø§Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø©!"); }
    function showRandomVerse() { 
        const v = bibleVerses[Math.floor(Math.random()*bibleVerses.length)];
        document.getElementById('dailyVerse').innerText = `"${v.t}"`;
        document.getElementById('verseRef').innerText = `(${v.r})`;
    }
    function toggleTheme() {
        const body = document.body;
        const isLight = body.getAttribute('data-theme') === 'light';
        body.setAttribute('data-theme', isLight ? 'dark' : 'light');
        document.getElementById('themeBtn').innerText = isLight ? "â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­" : "ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†";
    }
    function sendQuestion() {
        const txt = document.getElementById('quesMsg').value.trim();
        if(txt) { db.ref("psychology/questions").push({ sender: "Ù…Ø®Ø¯ÙˆÙ…", text: txt, time: new Date().toLocaleString('ar-EG') }); alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!"); document.getElementById('quesMsg').value = ""; }
    }
</script>
</body>
</html>
