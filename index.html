
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®Ø¯Ù…Ø© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</title>
    
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2904/2904979.png">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');

        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: #f8f9ff;
            --bg-card: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --accent-1: #667eea;
            --accent-2: #f093fb;
            --accent-3: #4facfe;
            --success: #48bb78;
            --warning: #ecc94b;
            --danger: #f56565;
            --shadow-sm: 0 2px 8px rgba(102,126,234,0.1);
            --shadow-md: 0 4px 16px rgba(102,126,234,0.15);
            --shadow-lg: 0 8px 32px rgba(102,126,234,0.2);
        }

        [data-theme="dark"] {
            --bg-secondary: #1a202c;
            --bg-card: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #cbd5e0;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Cairo', 'Segoe UI', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* ===== LOGIN ===== */
        #loginScreen {
            position: fixed; inset: 0;
            background: var(--bg-primary);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
            animation: fadeIn 0.5s ease;
        }
        .login-box {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 40px 30px;
            border-radius: 30px;
            text-align: center;
            width: 90%; max-width: 380px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.6s ease;
        }
        .login-box h3 {
            font-size: 26px; font-weight: 800;
            background: var(--bg-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
        }
        .login-icon { font-size: 56px; margin-bottom: 16px; animation: bounce 2s infinite; }
        .login-box p { color: #718096; font-size: 14px; margin-bottom: 22px; }

        /* ===== MAIN ===== */
        #mainContent { display: none; animation: fadeIn 0.5s ease; padding-bottom: 30px; }

        .theme-toggle-btn {
            position: fixed; top: 16px; left: 16px;
            background: var(--bg-card); color: var(--text-primary);
            border: none; padding: 10px 18px; border-radius: 50px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            box-shadow: var(--shadow-md); z-index: 100;
            transition: all 0.3s ease; font-family: 'Cairo', sans-serif;
        }
        .theme-toggle-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        /* ===== HEADER ===== */
        .main-header {
            background: var(--bg-primary);
            padding: 34px 20px 44px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative; overflow: hidden;
        }
        .main-header::before {
            content:'';
            position: absolute; inset: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="rgba(255,255,255,0.05)"/></svg>');
            animation: float 20s infinite linear;
        }
        .main-header h2 {
            color: white; font-size: 30px; font-weight: 800;
            margin-bottom: 6px; position: relative;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: titleGlow 3s ease-in-out infinite;
        }
        
        @keyframes titleGlow {
            0%, 100% {
                text-shadow: 0 2px 10px rgba(0,0,0,0.2),
                            0 0 20px rgba(255,255,255,0.3);
                transform: scale(1);
            }
            50% {
                text-shadow: 0 2px 10px rgba(0,0,0,0.2),
                            0 0 30px rgba(255,255,255,0.6),
                            0 0 40px rgba(255,255,255,0.4);
                transform: scale(1.02);
            }
        }
        
        .animated-title {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        
        .animated-title span {
            display: inline-block;
        }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙƒÙ†ÙŠØ³Ø© - Ø«Ø§Ø¨ØªØ© Ù…Ø¹ ØªÙˆÙ‡Ø¬ Ø®ÙÙŠÙ */
        .animated-title .word-1 {
            font-size: 36px;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
        }
        
        /* ÙƒÙ„Ù…Ø© "Ø®Ø¯Ù…Ø©" - Ù…ÙˆØ¬Ø© Ù…Ø¹ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… */
        .animated-title .word-2 {
            animation: waveText 3s ease-in-out infinite;
            transform-origin: center;
        }
        
        @keyframes waveText {
            0%, 100% {
                transform: translateY(0) scale(1);
                letter-spacing: 0px;
            }
            33% {
                transform: translateY(-8px) scale(1.08);
                letter-spacing: 2px;
            }
            66% {
                transform: translateY(4px) scale(0.95);
                letter-spacing: -1px;
            }
        }
        
        /* ÙƒÙ„Ù…Ø© "Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ" - ØªØ£Ø«ÙŠØ± Ù‚ÙˆØ³ Ù‚Ø²Ø­ Ù…ØªØ­Ø±Ùƒ Ù…Ø¹ Ù†Ø¨Ø¶ */
        .animated-title .word-3 {
            background: linear-gradient(90deg, 
                #fff 0%, 
                #fbbf24 25%, 
                #f093fb 50%, 
                #4facfe 75%, 
                #fff 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 300% 100%;
            animation: rainbowSlide 4s linear infinite, pulseBig 2s ease-in-out infinite;
            font-weight: 900;
        }
        
        @keyframes rainbowSlide {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 300% 50%;
            }
        }
        
        @keyframes pulseBig {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 5px rgba(251,191,36,0.3));
            }
            50% {
                transform: scale(1.12);
                filter: drop-shadow(0 0 15px rgba(251,191,36,0.8));
            }
        }
        
        /* Ø§Ø³Ù… Ø§Ù„ÙƒÙ†ÙŠØ³Ø© - ØªØ£Ø«ÙŠØ± ÙƒØªØ§Ø¨Ø© + ØªÙ„Ø§Ø´ÙŠ */
        .main-header small { 
            color: rgba(255,255,255,0.88); 
            font-size: 13px; 
            position: relative;
            display: inline-block;
            animation: typewriter 8s steps(40) infinite, fadeInOut 8s ease-in-out infinite;
            overflow: hidden;
            white-space: nowrap;
            border-left: 2px solid rgba(255,255,255,0.7);
            padding-left: 8px;
        }
        
        @keyframes typewriter {
            0%, 10% {
                width: 0;
            }
            50%, 90% {
                width: 100%;
            }
            100% {
                width: 0;
            }
        }
        
        @keyframes fadeInOut {
            0%, 10% {
                opacity: 0;
            }
            20%, 80% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        /* ===== VERSE ===== */
        .verse-container {
            background: var(--bg-primary);
            margin: -28px 15px 20px;
            padding: 24px; border-radius: 24px;
            box-shadow: var(--shadow-lg);
            position: relative; overflow: hidden;
            animation: slideUp 0.6s ease;
        }
        .verse-container::before {
            content:'âœ'; position: absolute;
            top: 8px; right: 18px;
            font-size: 90px; opacity: 0.1; color: white;
        }
        .verse-text { font-size: 17px; font-weight: 600; color: white; line-height: 1.8; margin-bottom: 10px; position: relative; }
        .verse-ref { font-size: 13px; color: rgba(255,255,255,0.8); font-weight: 600; position: relative; }

        /* ===== CONTAINER ===== */
        .container { padding: 0 15px; }

        /* ===== ADMIN ALERT ===== */
        #adminAlert {
            display: none;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white; padding: 18px; border-radius: 18px;
            margin: 18px 15px; box-shadow: var(--shadow-md);
            animation: shake 0.5s ease, pulse 2s infinite;
        }
        #adminAlert b { display: block; font-size: 17px; margin-bottom: 6px; }

        /* ===== SECTIONS ===== */
        .section {
            background: var(--bg-card);
            padding: 20px; border-radius: 22px;
            margin: 14px 0; box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            animation: slideUp 0.6s ease;
        }
        .section:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        .section-title {
            font-size: 19px; font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 14px;
            display: flex; align-items: center; gap: 10px;
        }
        .section-title .emoji { font-size: 22px; }

        /* ===== GRID / LEADERBOARD ===== */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: 10px; margin-top: 12px;
        }
        .card {
            background: #0f172a;
            padding: 10px; border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.3s ease;
        }
        .card:hover { 
            transform: translateY(-3px); 
            box-shadow: var(--shadow-md); 
            border-color: var(--accent-1);
            background: #1a2332;
        }
        
        /* ===== MINI BARS IN CARD ===== */
        .card-default-view {
            display: block;
        }
        .card-details-view {
            display: none;
        }
        .card.expanded .card-default-view {
            display: none;
        }
        .card.expanded .card-details-view {
            display: block;
        }
        
        .mini-bars-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 8px;
            height: 70px;
            margin: 8px 0;
            padding: 0 8px;
        }
        .mini-bar-col {
            flex: 1;
            max-width: 25px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }
        .mini-bar {
            width: 100%;
            border-radius: 6px 6px 0 0;
            transition: height 0.8s cubic-bezier(0.68,-0.55,0.265,1.55);
            position: relative;
            min-height: 3px;
        }
        .mini-bar.quiz {
            background: linear-gradient(180deg, #f093fb 0%, #f5576c 100%);
        }
        .mini-bar.prayer {
            background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%);
        }
        .mini-bar.attendance {
            background: linear-gradient(180deg, #43e97b 0%, #38f9d7 100%);
        }
        .mini-bar-label {
            font-size: 9px;
            color: #cbd5e0;
            margin-top: 3px;
            white-space: nowrap;
        }
        .mini-bar-value {
            font-size: 11px;
            font-weight: 700;
            color: #fbbf24;
            margin-top: 2px;
        }
        .bar-wrap {
            height: 62px;
            background: rgba(102,126,234,0.1);
            border-radius: 12px; overflow: hidden;
            margin: 8px 0; display: flex; align-items: flex-end;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.06);
        }
        .bar {
            width: 100%;
            transition: height 1s cubic-bezier(0.68,-0.55,0.265,1.55);
            border-radius: 12px 12px 0 0;
            position: relative;
        }
        .bar::after {
            content:''; position: absolute;
            top:0; left:0; right:0; height:30%;
            background: rgba(255,255,255,0.25);
            border-radius: 12px 12px 0 0;
        }
        .bg-high { background: linear-gradient(to top, #48bb78, #68d391); }
        .bg-mid  { background: linear-gradient(to top, #ecc94b, #f6e05e); }
        .bg-low  { background: linear-gradient(to top, #f56565, #fc8181); }

        /* ===== INPUTS ===== */
        textarea, input[type="text"], input[type="password"], select, input[type="number"] {
            width: 100%; padding: 14px; border-radius: 14px;
            border: 2px solid rgba(102,126,234,0.2);
            background: var(--bg-secondary); color: var(--text-primary);
            font-family: 'Cairo', sans-serif; font-size: 15px;
            margin-bottom: 11px; outline: none;
            transition: all 0.3s ease;
        }
        textarea:focus, input:focus, select:focus {
            border-color: var(--accent-1);
            box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
            transform: translateY(-1px);
        }

        /* ===== BUTTONS ===== */
        .btn {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white; padding: 14px 22px; border: none;
            border-radius: 14px; cursor: pointer;
            font-weight: 700; font-size: 15px;
            font-family: 'Cairo', sans-serif;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease; width: 100%;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn:active { transform: translateY(0); }
        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .btn-danger  { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .btn-gold    { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1a202c; }

        /* ===== QUIZ ===== */
        .quiz-card { border: 3px solid var(--accent-2); position: relative; overflow: hidden; }
        .quiz-card::before { content:'ğŸ“–'; position: absolute; top:-18px; left:-18px; font-size:110px; opacity:0.05; }
        .question-card {
            background: rgba(102,126,234,0.06);
            padding: 16px; border-radius: 14px;
            margin-bottom: 14px;
            border-right: 5px solid var(--accent-1);
        }
        .option-label {
            display: block; background: var(--bg-secondary);
            padding: 13px; margin: 7px 0; border-radius: 12px;
            cursor: pointer; border: 2px solid transparent;
            font-size: 14px; transition: all 0.3s ease; font-weight: 600;
        }
        .option-label:hover { border-color: var(--accent-1); background: rgba(102,126,234,0.08); }
        .option-label input { margin-left: 10px; width: 18px; height: 18px; }
        #quizTimerDisplay {
            font-size: 22px; font-weight: 800; color: white;
            text-align: center; margin-bottom: 18px; padding: 14px;
            border-radius: 14px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            box-shadow: var(--shadow-md); animation: pulse 2s infinite;
        }

        /* ===== CHAT ===== */
        .chat-display {
            height: 190px; overflow-y: auto;
            background: var(--bg-secondary);
            padding: 12px; border-radius: 14px; margin-bottom: 10px;
        }
        .chat-msg {
            background: var(--bg-card);
            padding: 10px 14px; border-radius: 14px;
            margin-bottom: 8px; font-size: 13px;
            border-right: 4px solid var(--accent-1);
            word-wrap: break-word;
            box-shadow: var(--shadow-sm);
            animation: slideInRight 0.3s ease;
        }
        .chat-msg.admin-msg { border-right-color: #fbbf24; background: rgba(251,191,36,0.08); }
        .chat-input-row { display: flex; gap: 8px; }
        .chat-input-row input { margin-bottom: 0; flex: 1; }
        .chat-input-row button {
            background: var(--accent-1); border: none;
            padding: 0 18px; border-radius: 14px; color: white;
            font-weight: 700; cursor: pointer; font-size: 15px;
            transition: all 0.3s;
        }
        .chat-input-row button:hover { background: #5a6fd6; }

        .clear-chat-btn {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white; border: none; border-radius: 8px;
            padding: 6px 14px; font-size: 12px; cursor: pointer;
            margin-bottom: 8px; font-weight: 600;
            font-family: 'Cairo', sans-serif;
            box-shadow: var(--shadow-sm); transition: 0.3s;
        }
        .clear-chat-btn:hover { transform: translateY(-1px); }

        /* ===== SWITCH ===== */
        .switch-container {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(102,126,234,0.08);
            padding: 14px 16px; border-radius: 16px;
            margin-bottom: 14px;
            border: 2px solid rgba(102,126,234,0.18);
            font-weight: 600; transition: 0.3s;
        }
        .switch-container:hover { background: rgba(102,126,234,0.13); }
        .switch { position: relative; display: inline-block; width: 50px; height: 27px; }
        .switch input { opacity:0; width:0; height:0; }
        .slider {
            position: absolute; cursor: pointer; inset: 0;
            background-color: #cbd5e0; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content:"";
            height: 21px; width: 21px;
            left: 3px; bottom: 3px;
            background: white; transition: .4s; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); }
        input:checked + .slider:before { transform: translateX(23px); }

        .switch-gold input:checked + .slider { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .switch-pink input:checked + .slider { background: linear-gradient(135deg, #ec4899, #f093fb); }

        /* ===== MOOD ===== */
        .mood-container { display: flex; justify-content: space-around; margin: 18px 0; gap: 8px; }
        .mood-btn {
            font-size: 34px; cursor: pointer; transition: all 0.3s;
            opacity: 0.4; filter: grayscale(100%);
            padding: 8px; border-radius: 14px;
        }
        .mood-btn:hover { transform: scale(1.1); opacity: 0.7; }
        .mood-btn.active {
            opacity: 1; transform: scale(1.25); filter: grayscale(0%);
            background: rgba(102,126,234,0.1);
        }

        /* ===== PSY AREA ===== */
        .psy-section { border: 2px solid #ec4899 !important; }
        .psy-section .section-title .emoji { color: #ec4899; }
        .psy-chat { height: 110px; overflow-y: auto; background: rgba(0,0,0,0.06); border-radius: 10px; padding: 8px; font-size: 12px; margin: 6px 0; }
        [data-theme="dark"] .psy-chat { background: rgba(255,255,255,0.05); }

        /* ===== PRAYER TIMER ===== */
        #prayerTimer {
            display: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 22px; border-radius: 22px;
            margin-top: 18px; text-align: center;
            box-shadow: var(--shadow-lg);
        }
        .prayer-counter { font-size: 56px; font-weight: 800; color: #fbbf24; margin: 12px 0; text-shadow: 0 3px 8px rgba(0,0,0,0.3); }
        .prayer-text-display {
            font-size: 17px; font-weight: 600; color: white;
            min-height: 64px; display: flex; align-items: center; justify-content: center;
            margin-bottom: 12px; background: rgba(0,0,0,0.2);
            border-radius: 14px; padding: 12px; text-align: center; line-height: 1.6;
        }
        .prayer-btn {
            background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3);
            color: white; padding: 18px; border-radius: 16px;
            font-size: 18px; font-weight: 700; cursor: pointer;
            width: 100%; font-family: 'Cairo', sans-serif;
            transition: all 0.3s;
        }
        .prayer-btn:hover { background: rgba(255,255,255,0.25); transform: translateY(-2px); }

        /* ===== LIBRARY ===== */
        .lib-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
        .lib-card {
            background: linear-gradient(135deg, #10b981, #059669);
            padding: 18px; border-radius: 18px; text-align: center;
            cursor: pointer; text-decoration: none; color: white;
            font-weight: 700; font-size: 14px;
            box-shadow: var(--shadow-md); transition: all 0.3s;
        }
        .lib-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .lib-card .lib-emoji { font-size: 28px; display: block; margin-bottom: 6px; }

        /* ===== MUTUAL PRAYER (ALTAR) ===== */
        .altar-section { border: 2px solid #fbbf24 !important; }
        .altar-header {
            text-align: center; color: #fbbf24; font-size: 20px; font-weight: 800;
            border-bottom: 1px solid rgba(251,191,36,0.3); padding-bottom: 10px; margin-bottom: 18px;
        }
        .altar-label {
            color: #fbbf24; font-weight: 700; display: block; margin-bottom: 6px; font-size: 15px;
        }
        .altar-hint {
            color: #4ade80; font-size: 12px; font-style: italic;
            margin-bottom: 6px; background: rgba(74,222,128,0.1);
            padding: 5px 10px; border-radius: 8px;
        }
        .altar-textarea {
            width: 100%; height: 58px;
            background: var(--bg-secondary); color: var(--text-primary);
            border: 2px solid rgba(251,191,36,0.3); border-radius: 12px;
            padding: 10px; resize: none; font-family: 'Cairo', sans-serif;
            font-size: 14px; outline: none; transition: 0.3s;
        }
        .altar-textarea:focus { border-color: #fbbf24; box-shadow: 0 0 0 3px rgba(251,191,36,0.15); }
        .altar-divider { border: 0; border-top: 1px solid rgba(102,126,234,0.15); margin: 16px 0; }
        .metania-row {
            display: flex; align-items: center; gap: 10px;
            background: rgba(102,126,234,0.06); padding: 10px;
            border-radius: 12px; margin-bottom: 10px;
            border: 2px solid rgba(102,126,234,0.15);
        }
        .metania-row input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; accent-color: var(--accent-1); }
        .metania-row input[type="number"] { margin-bottom:0; width: 80px; padding: 6px; text-align: center; }

        /* ===== JIHAD BALANCE ===== */
        .jihad-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .jihad-col-title {
            text-align: center; font-size: 13px; font-weight: 700;
            padding: 6px; border-radius: 10px; margin-bottom: 8px;
        }
        .jihad-col-title.positive { background: rgba(72,187,120,0.12); color: var(--success); }
        .jihad-col-title.negative { background: rgba(245,101,101,0.12); color: var(--danger); }
        .jihad-item {
            background: rgba(102,126,234,0.05); padding: 8px;
            border-radius: 10px; margin-bottom: 7px;
            border: 1px solid rgba(102,126,234,0.1);
        }
        .jihad-item-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;
        }
        .jihad-item-row span { font-size: 14px; }
        .jihad-btn {
            background: rgba(102,126,234,0.15); border: none; color: var(--text-primary);
            width: 28px; height: 28px; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: 700; transition: 0.2s;
        }
        .jihad-btn:hover { background: rgba(102,126,234,0.3); }
        .jihad-score { font-weight: 800; color: var(--warning); font-size: 16px; min-width: 24px; text-align: center; }
        .jihad-note {
            width: 100%; background: rgba(102,126,234,0.06);
            border: 1px solid rgba(102,126,234,0.15); border-radius: 6px;
            color: var(--text-secondary); padding: 5px 8px;
            font-size: 11px; outline: none; margin-top: 3px;
            font-family: 'Cairo', sans-serif; transition: 0.3s;
        }
        .jihad-note:focus { border-color: var(--accent-1); }
        .jihad-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px; grid-column: span 2; }
        .jihad-actions button, .jihad-actions a {
            flex: 1; min-width: 80px; padding: 12px; border-radius: 12px;
            font-weight: 700; font-size: 13px; cursor: pointer;
            text-decoration: none; text-align: center;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Cairo', sans-serif; transition: 0.3s; border: none;
        }
        .jihad-actions .btn-save { background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); color: white; box-shadow: var(--shadow-sm); }
        .jihad-actions .btn-wa { background: linear-gradient(135deg, #25d366, #128c7e); color: white; }
        .jihad-actions .btn-copy { background: rgba(102,126,234,0.1); color: var(--text-primary); border: 2px solid rgba(102,126,234,0.2); }
        .jihad-history-item {
            background: rgba(72,187,120,0.08); padding: 10px; border-radius: 10px;
            margin-bottom: 7px; border-right: 4px solid var(--success);
            position: relative; font-size: 14px;
        }
        .jihad-del-btn { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--danger); border: none; background: none; cursor: pointer; font-size: 16px; }

        /* ===== ATTENDANCE ===== */
        .attendance-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .attendance-row span { min-width: 58px; font-size: 14px; font-weight: 600; }
        .attendance-row input { margin-bottom: 0; flex: 1; }
        .attendance-row .btn { width: auto; padding: 10px 18px; flex-shrink: 0; }

        /* ===== QUESTION ===== */
        .question-section { border: 2px solid var(--accent-1) !important; }

        /* ===== ADMIN PANEL ===== */
        #adminPanel {
            display: none; background: var(--bg-card);
            padding: 22px; border-radius: 22px;
            border: 3px solid var(--success);
            margin-top: 18px; box-shadow: var(--shadow-lg);
        }
        .admin-item {
            background: rgba(72,187,120,0.07); padding: 14px;
            border-radius: 14px; margin-bottom: 10px;
            border-right: 5px solid var(--success);
        }
        .admin-item label { font-weight: 700; display: block; margin-bottom: 8px; }
        #prayerResultsList { max-height: 190px; overflow-y: auto; font-size: 13px; }
        .prayer-result-item { border-bottom: 1px solid rgba(102,126,234,0.12); padding: 7px 0; }
        .prayer-result-item small { color: var(--text-secondary); }

        /* ===== BADGE ===== */
        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white; padding: 4px 11px; border-radius: 18px;
            font-size: 11px; font-weight: 700;
            box-shadow: var(--shadow-sm);
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(102,126,234,0.08); border-radius: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--accent-1); border-radius: 6px; }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        @keyframes slideUp { from { opacity:0; transform:translateY(28px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideInRight { from { opacity:0; transform:translateX(16px); } to { opacity:1; transform:translateX(0); } }
        @keyframes slideDown { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
        @keyframes bounce { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-8px); } }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.8; } }
        @keyframes shake { 0%,100% { transform:translateX(0); } 25% { transform:translateX(-8px); } 75% { transform:translateX(8px); } }
        @keyframes float { from { transform:translateY(0); } to { transform:translateY(-100vh); } }
        @keyframes wave { 
            0%, 100% { transform: translateY(0) scale(1); } 
            25% { transform: translateY(-3px) scale(1.05); } 
            50% { transform: translateY(0) scale(1); } 
            75% { transform: translateY(3px) scale(0.95); } 
        }
        @keyframes fadeOutUp { 
            from { opacity: 1; transform: translateY(0); } 
            to { opacity: 0; transform: translateY(-30px); } 
        }

        /* ===== Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ´Ø¬ÙŠØ¹ ===== */
        .encouragement-popup {
            position: fixed;
            top: 80px;
            right: 20px;
            left: 20px;
            max-width: 400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            z-index: 10000;
            animation: slideDown 0.5s ease;
            border: 3px solid #fbbf24;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .encouragement-popup .close-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.3);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .encouragement-popup .close-btn:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }
        
        .encouragement-popup .message-content {
            color: white;
            font-size: 16px;
            line-height: 1.8;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
        }
        
        .encouragement-popup .from-tag {
            color: rgba(255,255,255,0.85);
            font-size: 13px;
            margin-top: 12px;
            text-align: center;
            font-weight: 600;
        }
        
        .encouragement-badge {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            z-index: 999;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(239,68,68,0.6);
            border: 2px solid white;
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 4px 15px rgba(239,68,68,0.6);
            }
            50% { 
                transform: scale(1.08); 
                box-shadow: 0 6px 25px rgba(239,68,68,0.9);
            }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-50px); }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .main-header h2 { font-size: 24px; }
            .verse-text { font-size: 15px; }
            .section-title { font-size: 17px; }
        }

        /* ========== Ù…Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©: Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª (Badges) ========== */
        .achievement-badge-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .achievement-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 700;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        @keyframes badgeAppear {
            from {
                opacity: 0;
                transform: scale(0.5) rotate(-10deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .badge-gold {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #78350f;
            box-shadow: 0 2px 8px rgba(251,191,36,0.3);
        }

        .badge-silver {
            background: linear-gradient(135deg, #e5e7eb, #9ca3af);
            color: #374151;
            box-shadow: 0 2px 8px rgba(156,163,175,0.3);
        }

        .badge-bronze {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #78350f;
            box-shadow: 0 2px 8px rgba(217,119,6,0.3);
        }

        .badge-blue {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 2px 8px rgba(59,130,246,0.3);
        }




        /* ========== ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ø­Ø³Ù‘Ù†Ø© ========== */
        .interactive-notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white;
            padding: 18px 30px;
            border-radius: 50px;
            box-shadow: 0 8px 30px rgba(102,126,234,0.4);
            z-index: 999;
            font-weight: 700;
            font-size: 16px;
            animation: notificationSlide 0.5s ease, notificationBounce 2s ease-in-out infinite;
            display: none;
        }

        @keyframes notificationSlide {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes notificationBounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-8px); }
        }

        /* ========== ØªØ­Ø³ÙŠÙ†Ø§Øª ØªØµÙ…ÙŠÙ… Ø¥Ø¶Ø§ÙÙŠØ© ========== */
        
        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø£Ø­Ù„Ù‰ ÙˆØ£Ù†Ø¹Ù… */
        .smooth-entrance {
            animation: smoothEntrance 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes smoothEntrance {
            from {
                opacity: 0;
                transform: scale(0.8) rotate(-5deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        /* Ø£Ù„ÙˆØ§Ù† Ø£ÙƒØ«Ø± Ø¬Ø§Ø°Ø¨ÙŠØ© */
        .gradient-text {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
        }

        /* ØªØ¬Ø§ÙˆØ¨ Ø£ÙØ¶Ù„ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        @media (max-width: 768px) {
            .achievement-badge-container {
                justify-content: center;
            }

            .level-number {
                font-size: 56px;
            }

            .level-title {
                font-size: 20px;
            }

            .progress-chart-container,
            .weekly-goals-container,
            .level-system-container {
                padding: 15px;
            }
        }

        /* ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ† Ù…Ø­Ø³Ù‘Ù† */
        [data-theme="dark"] .goal-item {
            background: var(--bg-card);
        }

        [data-theme="dark"] .progress-chart-container {
            background: var(--bg-card);
            border: 1px solid rgba(102,126,234,0.2);
        }
    </style>
</head>
<body>

<!-- ===================== LOGIN ===================== -->
<div id="loginScreen">
    <div class="login-box">
        <div class="login-icon">âœï¸</div>
        <h3>Ø®Ø¯Ù…Ø© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</h3>
        <p>Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„Ø¨Ø¯Ø¡</p>
        <input type="password" id="passInputUser" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" onkeyup="if(event.key==='Enter') checkAccess()">
        <button class="btn" onclick="checkAccess()">Ø¯Ø®ÙˆÙ„ ğŸš€</button>
        <p onclick="openAdmin()" style="font-size:11px; color:#a0aec0; margin-top:18px; cursor:pointer;">ğŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ø®Ø¯Ø§Ù…</p>
    </div>
</div>

<!-- ===================== MAIN ===================== -->
<div id="mainContent">
    <button class="theme-toggle-btn" onclick="toggleTheme()" id="themeBtn">â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­</button>

    <!-- Header -->
    <div class="main-header">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div id="userNameDisplay" style="font-size: 15px; font-weight: 800; color: #fbbf24; animation: wave 2s ease-in-out infinite; display: none; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
            <h2 class="animated-title" style="margin: 0; flex: 1; text-align: center;">
                <span class="word-1">â›ª</span>
                <span class="word-2">Ø®Ø¯Ù…Ø©</span>
                <span class="word-3">Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</span>
            </h2>
            <div style="width: 80px;"></div>
        </div>
        <small class="animated-subtitle">ÙƒÙ†ÙŠØ³Ø© Ø§Ù„Ø¹Ø°Ø±Ø§Ø¡ ÙˆØ£Ø¨ÙˆØ³ÙŠÙÙŠÙ† ÙˆØ§Ù„Ø´Ù‡ÙŠØ¯ Ø£Ø¨Ø³Ø®ÙŠØ±ÙˆÙ†</small>
    </div>

    <div class="container">
        <!-- Verse -->
        <div class="verse-container">
            <div id="dailyVerse" class="verse-text">âœ¨ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¢ÙŠØ© ØªØ¹Ø²ÙŠØ©...</div>
            <div id="verseRef" class="verse-ref"></div>
        </div>

        <!-- Name Selection for Encouragement Messages -->
        <div class="section" id="nameSelectionSection" style="border: 2px solid #fbbf24; background: rgba(251,191,36,0.05); display: none;">
            <div class="section-title"><span class="emoji">ğŸ‘¤</span> Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø¹Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†ØªØ§Ø¨Ø¹Ùƒ ÙˆÙ†Ø´Ø¬Ø¹Ùƒ! ğŸ’™</p>
            <select id="nameSelect">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ --</option>
            </select>
            <button class="btn btn-gold" onclick="confirmNameSelection()" style="margin-top: 10px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³Ù… âœ…</button>
        </div>

        <!-- Welcome Message (shown after name is selected) -->
        <div id="welcomeMessageSection" style="display:none; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(251,191,36,0.15)); border-radius: 20px; text-align: center; border: 2px solid #fbbf24; animation: slideDown 0.8s ease;">
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ‘‹</div>
            <div id="welcomeText" style="font-size: 22px; font-weight: 800; color: var(--text-primary); margin-bottom: 8px;"></div>
            <div style="font-size: 14px; color: var(--text-secondary);">Ø±Ø¨Ù†Ø§ ÙŠÙØ±Ø­ Ù‚Ù„Ø¨Ùƒ ÙˆÙŠÙ‚ÙˆÙŠÙƒ! ğŸ’™</div>
        </div>



        <!-- ========== Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª - ØµØºÙŠØ±Ø© Ø¹Ù„Ù‰ Ø¬Ù†Ø¨ ========== -->
        <div id="badgesSection" style="display:none; margin-bottom: 15px;">
            <div style="display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; background: rgba(102,126,234,0.05); border-radius: 12px;" id="userBadgesContainer">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>





        <!-- ØªÙ†Ø¨ÙŠÙ‡ ØªÙØ§Ø¹Ù„ÙŠ -->
        <div class="interactive-notification" id="interactiveNotification">
            <span id="notificationText"></span>
        </div>

        <!-- Admin Alert -->
        <div id="adminAlert">
            <b>ğŸ“¢ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù† Ø§Ù„Ø®Ø¯Ø§Ù…:</b>
            <span id="alertText"></span>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel">
            <div class="section-title" style="justify-content:center; color: var(--success);"><span class="emoji">ğŸ› ï¸</span> Ù„ÙˆØ­Ø© Ø§Ù„Ø®Ø¯Ø§Ù…</div>
            <div class="admin-item">
                <label>ğŸ“£ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù…:</label>
                <input type="text" id="newAdminAlert" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù†Ø§...">
                <button class="btn btn-success" onclick="updateAdminAlert()">Ù†Ø´Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ğŸ“¤</button>
            </div>
            <div class="admin-item">
                <label>ğŸ™ ÙƒÙ„Ù…Ø© ØªØ´Ø¬ÙŠØ¹ Ø¹Ù† Ø§Ù„ØµÙ„Ø§Ø©:</label>
                <textarea id="prayerEncouragementInput" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© ØªØ´Ø¬ÙŠØ¹ Ø¬Ù…ÙŠÙ„Ø© Ø¹Ù† Ø§Ù„ØµÙ„Ø§Ø©..." style="height: 80px;"></textarea>
                <button class="btn btn-gold" onclick="updatePrayerEncouragement()">Ø­ÙØ¸ Ø§Ù„ÙƒÙ„Ù…Ø© ğŸ’</button>
            </div>
            <div class="admin-item">
                <label>ğŸ“– Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø°Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ:</label>
                <div id="prayerResultsList"></div>
            </div>
            <button class="btn btn-danger" onclick="location.reload()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù„ÙˆØ­Ø© âœ•</button>
        </div>

        <!-- Quiz -->
        <div id="quizSection" class="section quiz-card" style="display:none;">
            <div class="section-title"><span class="emoji">ğŸ“–</span> Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ù‚Ø¯Ø³</div>
            <div id="quizSetup">
                <p style="font-size:13px; color:var(--text-secondary); margin-bottom:10px;">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ø¯Ø¡:</p>
                <select id="userNameListQuiz"><option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡...</option></select>
                <button class="btn btn-gold" onclick="startQuiz()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¢Ù† ğŸš€</button>
            </div>
            <div id="quizArea" style="display:none;">
                <div id="quizTimerDisplay">â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="timeLeft">00:00</span></div>
                <div id="questionsContainer"></div>
                <button class="btn btn-success" onclick="submitQuiz()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª âœ…</button>
            </div>
            <div id="quizDone" style="display:none; text-align:center; padding:14px;">
                <div style="font-size:48px; margin-bottom:10px;">ğŸ‰</div>
                <h3 id="quizStatusTitle" style="color:var(--success); margin-bottom:8px;">ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„!</h3>
                <div id="finalQuizScore" style="font-size:19px; font-weight:800; color:var(--warning); margin:10px 0;"></div>
                <p style="font-size:12px; color:var(--text-secondary);">Ø¯Ø±Ø¬ØªÙƒ Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù â¤ï¸</p>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="section">
            <div class="section-title"><span class="emoji">ğŸ†</span> Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</div>
            <div id="leaderboard" class="grid"></div>
        </div>

        <!-- Chat Name -->
        <div class="section">
            <div class="section-title"><span class="emoji">ğŸ“</span> Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
            <input type="text" id="userName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." oninput="localStorage.setItem('chat_user_name', this.value)">
        </div>

        <!-- Chat -->
        <div class="section" style="border-right: 4px solid var(--accent-1);">
            <div class="section-title"><span class="emoji">ğŸ’¬</span> Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div>
            <div id="chatBox" class="chat-display"></div>
            <div class="chat-input-row">
                <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeyup="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>

        <!-- Psychology Toggle -->
        <div class="switch-container switch-pink">
            <span style="font-weight:700;">ğŸŒ± Ø±ÙƒÙ† Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø© Ø§Ù„Ù†ÙØ³ÙŠØ©</span>
            <label class="switch">
                <input type="checkbox" onchange="document.getElementById('psyArea').style.display = this.checked ? 'block' : 'none'">
                <span class="slider"></span>
            </label>
        </div>

        <!-- Psychology Area -->
        <div id="psyArea" class="section psy-section" style="display:none;">
            <p style="text-align:center; font-size:13px; color:var(--text-secondary); margin-bottom:14px;">Ù…Ø§ ØªØ®ÙØ´ Ø§Ø­Ù†Ø§ Ø¬Ù†Ø¨Ùƒ Ø¨Ù†Ø­Ø¨Ùƒ ÙˆØ§Ù†Øª ØºØ§Ù„ÙŠ Ø¹Ù„Ù‰ Ù‚Ù„Ø¨ Ø§Ù„Ù…Ø³ÙŠØ­.. â¤ï¸</p>
            <input type="text" id="psyNameInput" placeholder="Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ù…Ø¬Ù‡ÙˆÙ„)" style="border: 2px dashed rgba(236,72,153,0.4);">
            <div class="mood-container">
                <span class="mood-btn" onclick="setMood(this,'ğŸ˜­')">ğŸ˜­</span>
                <span class="mood-btn" onclick="setMood(this,'ğŸ˜¥')">ğŸ˜¥</span>
                <span class="mood-btn" onclick="setMood(this,'ğŸ˜Ÿ')">ğŸ˜Ÿ</span>
                <span class="mood-btn" onclick="setMood(this,'ğŸ˜Œ')">ğŸ˜Œ</span>
                <span class="mood-btn" onclick="setMood(this,'ğŸ˜Š')">ğŸ˜Š</span>
            </div>
            <select id="psyNeed">
                <option value="Ù…Ø¬Ø±Ø¯ ÙØ¶ÙØ¶Ø© ğŸ—£ï¸">ğŸ—£ï¸ Ù…Ø¬Ø±Ø¯ ÙØ¶ÙØ¶Ø©</option>
                <option value="ØµÙ„Ø§Ø© Ù…Ù† Ø£Ø¬Ù„ÙŠ ğŸ™">ğŸ™ ØµÙ„Ø§Ø© Ù…Ù† Ø£Ø¬Ù„ÙŠ</option>
                <option value="Ø¥Ù†Ù‚Ø§Ø° Ø³Ø±ÙŠØ¹ ğŸš¨">ğŸš¨ Ø¥Ù†Ù‚Ø§Ø° Ø³Ø±ÙŠØ¹</option>
                <option value="Ø¯Ø¹Ù… ÙˆØªÙˆØ¬ÙŠÙ‡ ğŸ¤">ğŸ¤ Ø¯Ø¹Ù… ÙˆØªÙˆØ¬ÙŠÙ‡</option>
            </select>
            <button class="btn" style="background:linear-gradient(135deg,#ec4899,#f093fb); margin-bottom:14px;" onclick="sendMoodOnly()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ğŸ•Šï¸</button>

            <div id="psyChatContainer">
                <button class="clear-chat-btn" onclick="clearPsyChat()">Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ—‘ï¸</button>
                <small style="color:var(--text-secondary); font-size:12px;">Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¬Ù‡ÙˆÙ„Ø© Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…:</small>
                <div id="psyLocalChat" class="psy-chat"></div>
                <div class="chat-input-row">
                    <input type="text" id="psyChatInput" placeholder="Ø±Ø³Ø§Ù„Ø© Ø³Ø±ÙŠØ©..." style="font-size:13px;" onkeyup="if(event.key==='Enter') sendPsyChat()">
                    <button onclick="sendPsyChat()" style="background:linear-gradient(135deg,#ec4899,#f093fb);">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>

            <button class="btn btn-gold" style="margin-top:16px;" onclick="startPrayerSession()">âœ¨ ÙŠÙ„Ø§ Ù†ØµÙ„Ùˆ Ø³ÙˆØ§ (33 ØµÙ„Ø§Ø©) âœ¨</button>
            <div id="prayerTimer">
                <div class="prayer-text-display" id="activePrayer"></div>
                <div class="prayer-counter" id="pCountText">0</div>
                <button class="prayer-btn" onclick="countPrayer()">Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø¯ â”</button>
            </div>
        </div>

        <!-- Library -->
        <div id="librarySection" class="section" style="border: 2px solid var(--success);">
            <div class="section-title"><span class="emoji">ğŸ¥</span> Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ÙŠØ¯ÙŠØ§</div>
            <div class="lib-grid">
                <a id="hymnLink" href="#" target="_blank" class="lib-card"><span class="lib-emoji">ğŸµ</span> Ù„Ø­Ù† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</a>
                <a id="pdfLink" href="#" target="_blank" class="lib-card"><span class="lib-emoji">ğŸ“–</span> Ø§Ù„Ù…Ù†Ù‡Ø¬ (PDF)</a>
                <a id="videoLink" href="#" target="_blank" class="lib-card" style="grid-column:span 2;"><span class="lib-emoji">ğŸ¬</span> Ø´Ø§Ù‡Ø¯ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¯Ø±Ø³</a>
            </div>
        </div>

        <!-- Prayer Altar Toggle -->
        <div class="switch-container switch-gold">
            <span style="font-weight:700; color:var(--warning);">ğŸ™ ÙØªØ­ Ù…Ø°Ø¨Ø­ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠ <span class="badge">Ù¥ Ø¯Ø±Ø¬Ø§Øª ğŸ</span></span>
            <label class="switch">
                <input type="checkbox" onchange="document.getElementById('mutualPrayerSection').style.display = this.checked ? 'block' : 'none'">
                <span class="slider"></span>
            </label>
        </div>

        <!-- Prayer Altar -->
        <div id="mutualPrayerSection" class="section altar-section" style="display:none;">
            <div class="altar-header">âœ¨ Ù…ÙØ°Ù’Ø¨ÙØ­ Ø§Ù„ØµÙÙ‘Ù„ÙØ§Ø© Ø§Ù„ÙŠÙÙˆÙ’Ù…ÙÙŠ âœ¨</div>

            <!-- Ø±Ø³Ø§Ù„Ø© ØªØ´Ø¬ÙŠØ¹ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù† Ø§Ù„ØµÙ„Ø§Ø© -->
            <div id="prayerEncouragementBox" style="background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(240,147,251,0.15)); 
                border: 2px solid #fbbf24; border-radius: 15px; padding: 15px; margin-bottom: 15px; 
                text-align: center; display: none;">
                <div style="font-size: 28px; margin-bottom: 8px;">ğŸ™</div>
                <div id="prayerEncouragementText" style="color: var(--text-primary); font-weight: 700; 
                    font-size: 15px; line-height: 1.6;"></div>
                <div style="color: var(--text-secondary); font-size: 12px; margin-top: 8px; font-style: italic;">
                    ğŸ’ Ù…Ù† Ø§Ù„Ø®Ø¯Ø§Ù…
                </div>
            </div>

            <div style="margin-bottom:16px;">
                <label class="altar-label">ğŸ“– Ù¡. ØµÙ„Ø§Ø© Ù…Ù† Ø§Ù„Ø£Ø¬Ø¨ÙŠØ©:</label>
                <div id="admin_agpeya_hint" class="altar-hint">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø®Ø§Ø¯Ù…...</div>
                <textarea id="agpeyaText" class="altar-textarea" placeholder="Ø§ÙƒØªØ¨ Ù…Ø§ ØµÙ„ÙŠØªÙ‡ Ù‡Ù†Ø§..."></textarea>
            </div>

            <hr class="altar-divider">

            <div style="margin-bottom:16px;">
                <label class="altar-label">ğŸ•Šï¸ Ù¢. ØµÙ„Ø§ØªÙŠ Ø§Ù„Ø®Ø§ØµØ©:</label>

                <div class="metania-row">
                    <span style="color:var(--text-secondary); font-size:14px;">â€¢ Ù…ÙŠØ·Ø§Ù†ÙŠØ©:</span>
                    <input type="checkbox" id="metaniaDone"> <span style="font-size:13px;">ØªÙ…</span>
                    <input type="number" id="metaniaCount" placeholder="Ø§Ù„Ø¹Ø¯Ø¯" min="0">
                </div>

                <div style="margin-bottom:10px;">
                    <small style="color:var(--text-secondary); display:block; margin-bottom:3px;">â€¢ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø±Ø¨Ù†Ø§ ÙŠØ³ÙˆØ¹:</small>
                    <div id="admin_thanks_hint" class="altar-hint"></div>
                    <textarea id="prayThank" class="altar-textarea" placeholder="Ø§ÙƒØªØ¨ Ø´ÙƒØ±Ùƒ Ù‡Ù†Ø§..."></textarea>
                </div>
                <div style="margin-bottom:10px;">
                    <small style="color:var(--text-secondary); display:block; margin-bottom:3px;">â€¢ Ø®Ø¶ÙˆØ¹ ÙˆØ·Ù„Ø¨ Ù…ØºÙØ±Ø©:</small>
                    <div id="admin_forgive_hint" class="altar-hint"></div>
                    <textarea id="prayForgive" class="altar-textarea" placeholder="Ø§ÙƒØªØ¨ ØµÙ„Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                </div>
                <div style="margin-bottom:10px;">
                    <small style="color:var(--text-secondary); display:block; margin-bottom:3px;">â€¢ Ù‚Ù„Ø¨ÙŠ Ù…Ù„ØªÙ‡Ø¨ Ù„Ø±Ø¨Ù†Ø§:</small>
                    <div id="admin_heart_hint" class="altar-hint"></div>
                    <textarea id="prayHeart" class="altar-textarea" placeholder="Ø§ÙƒØªØ¨ ØµÙ„Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                </div>
                <div style="margin-bottom:10px;">
                    <small style="color:var(--text-secondary); display:block; margin-bottom:3px;">â€¢ Ø·Ù„Ø¨Ø© Ø§ØªØ­Ø§Ø¯ ÙÙŠ Ø±Ø¨Ù†Ø§:</small>
                    <div id="admin_union_hint" class="altar-hint"></div>
                    <textarea id="prayUnion" class="altar-textarea" placeholder="Ø§ÙƒØªØ¨ ØµÙ„Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                </div>
            </div>

            <hr class="altar-divider">

            <div style="margin-bottom:16px;">
                <label class="altar-label">ğŸ“œ Ù£. Ø£ÙƒØ«Ø± Ø¢ÙŠØ© Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ù‚Ø¯Ø³:</label>
                <div id="admin_verse_hint" class="altar-hint"></div>
                <textarea id="bibleVerseText" class="altar-textarea" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¢ÙŠØ© Ù‡Ù†Ø§..."></textarea>
            </div>

            <div style="margin-bottom:16px;">
                <label class="altar-label">â±ï¸ Ù¤. Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚):</label>
                <input type="number" id="prayerDuration" placeholder="Ù…Ø«Ù„Ø§Ù‹: 15" style="border-color: rgba(251,191,36,0.4);">
            </div>

            <select id="prayerUserName">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ --</option>
            </select>
            <button class="btn btn-gold" onclick="sendMutualPrayer()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø°Ø¨Ø­ âœ…</button>
        </div>

        <!-- Question -->
        <div class="section question-section">
            <div class="section-title"><span class="emoji">â“</span> Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­</div>
            <textarea id="quesMsg" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." style="height:64px;"></textarea>
            <button class="btn" onclick="sendQuestion()">Ø¥Ø±Ø³Ø§Ù„ ğŸ“¤</button>
        </div>

        <!-- Jihad Toggle -->
        <div class="switch-container switch-gold">
            <span style="font-weight:700; color:var(--warning);">ğŸ•Šï¸ ÙØªØ­ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø¬Ù‡Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span>
            <label class="switch">
                <input type="checkbox" id="jihadMasterToggle" onchange="toggleJihadSection(this.checked)">
                <span class="slider"></span>
            </label>
        </div>

        <!-- Jihad Area -->
        <div id="jihadArea" class="section" style="display:none; border: 2px solid var(--warning);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div class="section-title" style="margin-bottom:0;"><span class="emoji">ğŸ•Šï¸</span> Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø¬Ù‡Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
                <button onclick="changeJihadPin()" style="background:none; border:1px solid rgba(102,126,234,0.3); color:var(--text-secondary); font-size:11px; padding:5px 10px; border-radius:8px; cursor:pointer; font-family:'Cairo',sans-serif;">ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ ğŸ”‘</button>
            </div>

            <div class="jihad-grid">
                <div>
                    <div class="jihad-col-title positive">âœ¨ Ø«Ù…Ø§Ø± Ø§Ù„Ù†ÙˆØ±</div>
                    <!-- Positive items -->
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ğŸ™ ØµÙ„Ø§Ø©</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp1',-1)">âˆ’</button><span class="jihad-score jihad-p-score" id="jp1">0</span><button class="jihad-btn" onclick="jihadCh('jp1',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© ØµÙ„Ø§Ø©..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ğŸ“– Ø¥Ù†Ø¬ÙŠÙ„</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp2',-1)">âˆ’</button><span class="jihad-score jihad-p-score" id="jp2">0</span><button class="jihad-btn" onclick="jihadCh('jp2',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="Ø¢ÙŠØ© Ø§Ù„ÙŠÙˆÙ…..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ğŸ¤ Ø¹Ù…Ù„ Ù…Ø­Ø¨Ø©</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp3',-1)">âˆ’</button><span class="jihad-score jihad-p-score" id="jp3">0</span><button class="jihad-btn" onclick="jihadCh('jp3',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="Ù…ÙˆÙ‚Ù..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ğŸ’¬ ØªØ´Ø¬ÙŠØ¹/Ø´ÙƒØ±</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp4',-1)">âˆ’</button><span class="jihad-score jihad-p-score" id="jp4">0</span><button class="jihad-btn" onclick="jihadCh('jp4',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="Ø´ÙƒØ±Øª Ù…ÙŠÙ†ØŸ">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ğŸ’ª ØªØºØµØ¨ (Ø®ÙŠØ±)</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp5',-1)">âˆ’</button><span class="jihad-score jihad-p-score" id="jp5">0</span><button class="jihad-btn" onclick="jihadCh('jp5',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ØªØºØµØ¨Øª ÙÙŠ Ø¥ÙŠÙ‡ØŸ">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ğŸ† Ø§Ù†ØªØµØ§Ø±</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp6',-1)">âˆ’</button><span class="jihad-score jihad-p-score" id="jp6">0</span><button class="jihad-btn" onclick="jihadCh('jp6',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="Ø§Ù†ØªØµØ§Ø± Ø¹Ù„Ù‰..">
                    </div>
                </div>
                <div>
                    <div class="jihad-col-title negative">ğŸ›¡ï¸ Ø¯Ø±ÙˆØ³ Ø§Ù„Ø¬Ù‡Ø§Ø¯</div>
                    <!-- Negative items -->
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ğŸ™Š Ø´ØªÙŠÙ…Ø©</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jn1',-1)">âˆ’</button><span class="jihad-score jihad-n-score" id="jn1">0</span><button class="jihad-btn" onclick="jihadCh('jn1',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="Ø³Ø£ØªØ¹Ù„Ù…..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ğŸ¤¥ ÙƒØ°Ø¨</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jn2',-1)">âˆ’</button><span class="jihad-score jihad-n-score" id="jn2">0</span><button class="jihad-btn" onclick="jihadCh('jn2',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="Ø§Ù„ØµØ¯Ù‚ Ù‡Ùˆ..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ğŸ¤ ÙƒÙ„Ø§Ù… Ø±Ø¯ÙŠØ¡</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jn3',-1)">âˆ’</button><span class="jihad-score jihad-n-score" id="jn3">0</span><button class="jihad-btn" onclick="jihadCh('jn3',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="Ø¶Ø¨Ø· Ù„Ø³Ø§Ù†..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ğŸ”¥ ØºØ¶Ø¨</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jn4',-1)">âˆ’</button><span class="jihad-score jihad-n-score" id="jn4">0</span><button class="jihad-btn" onclick="jihadCh('jn4',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="Ù‡Ø¯ÙˆØ¦ÙŠ ÙÙŠ..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ğŸ’­ ÙÙƒØ± Ø³Ù„Ø¨ÙŠ</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jn5',-1)">âˆ’</button><span class="jihad-score jihad-n-score" id="jn5">0</span><button class="jihad-btn" onclick="jihadCh('jn5',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ÙÙƒØ±ÙŠ Ù…Ø¹ Ø§Ù„Ù…Ø³ÙŠØ­..">
                    </div>
                </div>
                <div class="jihad-actions">
                    <button class="btn-save" onclick="jihadSave()">Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ… ğŸ“–</button>
                    <button class="btn-save" onclick="jihadShowResults()" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© ğŸ“Š</button>
                    <a href="#" class="btn-wa" onclick="jihadPrepareLink(event,'wa')">ÙˆØ§ØªØ³Ø§Ø¨ ğŸ’¬</a>
                    <button class="btn-copy" onclick="jihadPrepareLink(event,'copy')">Ù†Ø³Ø® ğŸ“‹</button>
                </div>
            </div>

            <div id="jihadHList" style="margin-top:20px; border-top:1px solid rgba(102,126,234,0.15); padding-top:12px; display:none;"></div>
        </div>

        <!-- Attendance -->
        <div class="section" style="border: 2px solid var(--success);">
            <div class="section-title"><span class="emoji">â›ª</span> Ø±ÙƒÙ† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„ÙƒÙ†Ø³ÙŠ <span class="badge">Ù¥ Ø¯Ø±Ø¬Ø§Øª ğŸ</span></div>
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±Ùƒ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹:</p>
            <select id="attendanceNameSelect"><option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ --</option></select>
            <div class="attendance-row">
                <span>â˜¦ï¸ Ø§Ù„Ù‚Ø¯Ø§Ø³:</span>
                <input type="text" id="liturgyDay" placeholder="ÙŠÙˆÙ… Ø¥ÙŠÙ‡ØŸ">
                <button class="btn btn-success" onclick="submitAttendance('Ù‚Ø¯Ø§Ø³','liturgyDay')">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
            <div class="attendance-row">
                <span>ğŸ¤ Ø§Ù„Ø®Ø¯Ù…Ø©:</span>
                <input type="text" id="serviceDay" placeholder="ÙŠÙˆÙ… Ø¥ÙŠÙ‡ØŸ">
                <button class="btn btn-success" onclick="submitAttendance('Ø®Ø¯Ù…Ø©','serviceDay')">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>

    </div><!-- end container -->
</div><!-- end mainContent -->

<!-- ===================== SCRIPT ===================== -->
<script>
const config = { databaseURL: "https://jesus-bb0ba-default-rtdb.firebaseio.com/" };
firebase.initializeApp(config);
const db = firebase.database();

// ===== PWA Service Worker =====
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const swCode = `
            const CACHE_NAME = 'is-app-v1';
            self.addEventListener('install', e => {
                e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(['./', 'index.html'])));
            });
            self.addEventListener('fetch', e => {
                e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
            });
        `;
        const blob = new Blob([swCode], {type: 'text/javascript'});
        navigator.serviceWorker.register(URL.createObjectURL(blob));
    });
}

let psySessionID = localStorage.getItem('psy_session_id') || ("User_" + Date.now());
localStorage.setItem('psy_session_id', psySessionID);

// ===== Ù†Ø¸Ø§Ù… Ù…Ù†Ø¹ Ø§Ù„Ø­Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø± Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© =====
let currentUserId = null;
let currentUserName = null;

function getUserId(userName) {
    return userName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_\u0600-\u06FF]/g, '');
}

// ===== BIBLE VERSES =====
const bibleVerses = [
    {t:"Ù„Ø§Ù ØªÙØ®ÙÙÙ’ Ù„Ø£ÙÙ†ÙÙ‘ÙŠ Ù…ÙØ¹ÙÙƒÙ. Ù„Ø§Ù ØªÙØªÙÙ„ÙÙÙÙ‘ØªÙ’ Ù„Ø£ÙÙ†ÙÙ‘ÙŠ Ø¥ÙÙ„Ù‡ÙÙƒÙ. Ù‚ÙØ¯Ù’ Ø£ÙÙŠÙÙ‘Ø¯Ù’ØªÙÙƒÙ ÙˆÙØ£ÙØ¹ÙÙ†Ù’ØªÙÙƒÙ ÙˆÙØ¹ÙØ¶ÙØ¯Ù’ØªÙÙƒÙ Ø¨ÙÙŠÙÙ…ÙÙŠÙ†Ù Ø¨ÙØ±ÙÙ‘ÙŠ.",r:"Ø¥Ø´Ø¹ÙŠØ§Ø¡ 41: 10"},
    {t:"Ø£ÙÙ†ÙØ§ Ù…ÙØ¹ÙÙƒÙÙ…Ù’ ÙƒÙÙ„ÙÙ‘ Ø§Ù„Ø£ÙÙŠÙÙ‘Ø§Ù…Ù Ø¥ÙÙ„ÙÙ‰ Ø§Ù†Ù’Ù‚ÙØ¶ÙØ§Ø¡Ù Ø§Ù„Ø¯ÙÙ‘Ù‡Ù’Ø±Ù.",r:"Ù…ØªÙ‰ 28: 20"},
    {t:"Ø§ÙÙ„Ø±ÙÙ‘Ø¨ÙÙ‘ Ø±ÙØ§Ø¹ÙÙŠÙÙ‘ ÙÙÙ„Ø§Ù ÙŠÙØ¹Ù’ÙˆÙØ²ÙÙ†ÙÙŠ Ø´ÙÙŠÙ’Ø¡ÙŒ.",r:"Ù…Ø²Ù…ÙˆØ± 23: 1"},
    {t:"ØªÙØ¹ÙØ§Ù„ÙÙˆÙ’Ø§ Ø¥ÙÙ„ÙÙŠÙÙ‘ ÙŠÙØ§ Ø¬ÙÙ…ÙÙŠØ¹Ù Ø§Ù„Ù’Ù…ÙØªÙ’Ø¹ÙØ¨ÙÙŠÙ†Ù ÙˆÙØ§Ù„Ø«ÙÙ‘Ù‚ÙÙŠÙ„ÙÙŠ Ø§Ù„Ø£ÙØ­Ù’Ù…ÙØ§Ù„ÙØŒ ÙˆÙØ£ÙÙ†ÙØ§ Ø£ÙØ±ÙÙŠØ­ÙÙƒÙÙ…Ù’.",r:"Ù…ØªÙ‰ 11: 28"},
    {t:"ÙƒÙÙ„ÙÙ‘ Ø´ÙÙŠÙ’Ø¡Ù Ù…ÙØ³Ù’ØªÙØ·ÙØ§Ø¹ÙŒ Ù„ÙÙ„Ù’Ù…ÙØ¤Ù’Ù…ÙÙ†Ù.",r:"Ù…Ø±Ù‚Ø³ 9: 23"},
    {t:"Ø£ÙØ³Ù’ØªÙØ·ÙÙŠØ¹Ù ÙƒÙÙ„ÙÙ‘ Ø´ÙÙŠÙ’Ø¡Ù ÙÙÙŠ Ø§Ù„Ù’Ù…ÙØ³ÙÙŠØ­Ù Ø§Ù„ÙÙ‘Ø°ÙÙŠ ÙŠÙÙ‚ÙÙˆÙÙ‘ÙŠÙ†ÙÙŠ.",r:"ÙÙŠÙ„Ø¨ÙŠ 4: 13"},
    {t:"Ø³ÙÙ„Ø§ÙÙ…Ù‹Ø§ Ø£ÙØªÙ’Ø±ÙÙƒÙ Ù„ÙÙƒÙÙ…Ù’. Ø³ÙÙ„Ø§ÙÙ…ÙÙŠ Ø£ÙØ¹Ù’Ø·ÙÙŠÙƒÙÙ…Ù’. Ù„ÙÙŠÙ’Ø³Ù ÙƒÙÙ…ÙØ§ ÙŠÙØ¹Ù’Ø·ÙÙŠ Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…Ù Ø£ÙØ¹Ù’Ø·ÙÙŠÙƒÙÙ…Ù’ Ø£ÙÙ†ÙØ§.",r:"ÙŠÙˆØ­Ù†Ø§ 14: 27"},
    {t:"Ù…ÙÙ„Ù’Ù‚ÙÙŠÙ†Ù ÙƒÙÙ„ÙÙ‘ Ù‡ÙÙ…ÙÙ‘ÙƒÙÙ…Ù’ Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙØŒ Ù„Ø£ÙÙ†ÙÙ‘Ù‡Ù Ù‡ÙÙˆÙ ÙŠÙØ¹Ù’ØªÙÙ†ÙÙŠ Ø¨ÙÙƒÙÙ…Ù’.",r:"1 Ø¨Ø·Ø±Ø³ 5: 7"},
    {t:"Ø¥ÙÙ†Ù’ ÙƒÙØ§Ù†Ù Ø§Ù„Ù„Ù‡Ù Ù…ÙØ¹ÙÙ†ÙØ§ØŒ ÙÙÙ…ÙÙ†Ù’ Ø¹ÙÙ„ÙÙŠÙ’Ù†ÙØ§ØŸ",r:"Ø±ÙˆÙ…ÙŠØ© 8: 31"},
    {t:"ÙŠÙØ¹Ù’Ø·ÙÙŠ Ø§Ù„Ù’Ù…ÙØ¹Ù’ÙŠÙÙŠÙ Ù‚ÙØ¯Ù’Ø±ÙØ©Ù‹ØŒ ÙˆÙÙ„ÙØ¹ÙØ¯ÙÙŠÙ…Ù Ø§Ù„Ù’Ù‚ÙÙˆÙÙ‘Ø©Ù ÙŠÙÙƒÙØ«ÙÙ‘Ø±Ù Ø´ÙØ¯ÙÙ‘Ø©Ù‹.",r:"Ø¥Ø´Ø¹ÙŠØ§Ø¡ 40: 29"},
    {t:"Ø§ÙÙ„Ø±ÙÙ‘Ø¨ÙÙ‘ Ù†ÙÙˆØ±ÙÙŠ ÙˆÙØ®ÙÙ„Ø§ÙØµÙÙŠØŒ Ù…ÙÙ…ÙÙ‘Ù†Ù’ Ø£ÙØ®ÙØ§ÙÙØŸ Ø§ÙÙ„Ø±ÙÙ‘Ø¨ÙÙ‘ Ø­ÙØµÙ’Ù†Ù Ø­ÙÙŠÙØ§ØªÙÙŠØŒ Ù…ÙÙ…ÙÙ‘Ù†Ù’ Ø£ÙØ±Ù’ØªÙØ¹ÙØ¨ÙØŸ",r:"Ù…Ø²Ù…ÙˆØ± 27: 1"},
    {t:"Ù„Ø£ÙÙ†ÙÙ‘ Ù…ÙÙ„Ø§ÙØ¦ÙÙƒÙØªÙÙ‡Ù ÙŠÙÙˆØµÙÙŠÙ‡Ù Ø¨ÙÙƒÙ Ù„ÙÙƒÙÙŠÙ’ ÙŠÙØ­Ù’ÙÙØ¸ÙÙˆÙƒÙ ÙÙÙŠ ÙƒÙÙ„ÙÙ‘ Ø·ÙØ±ÙÙ‚ÙÙƒÙ.",r:"Ù…Ø²Ù…ÙˆØ± 91: 11"},
    {t:"Ø§Ù„Ø±ÙÙ‘Ø¨ÙÙ‘ ÙŠÙØ­ÙØ§Ø±ÙØ¨Ù Ø¹ÙÙ†Ù’ÙƒÙÙ…Ù’ ÙˆÙØ£ÙÙ†Ù’ØªÙÙ…Ù’ ØªÙØµÙ’Ù…ÙØªÙÙˆÙ†Ù.",r:"Ø®Ø±ÙˆØ¬ 14: 14"},
    {t:"Ù…ÙØ­ÙØ¨ÙÙ‘Ø©Ù‹ Ø£ÙØ¨ÙØ¯ÙÙŠÙÙ‘Ø©Ù‹ Ø£ÙØ­Ù’Ø¨ÙØ¨Ù’ØªÙÙƒÙØŒ Ù…ÙÙ†Ù’ Ø£ÙØ¬Ù’Ù„Ù Ø°Ù„ÙÙƒÙ Ø£ÙØ¯ÙÙ…Ù’ØªÙ Ù„ÙÙƒÙ Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙØ©Ù.",r:"Ø¥Ø±Ù…ÙŠØ§ 31: 3"},
    {t:"ÙÙÙŠ Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…Ù Ø³ÙÙŠÙÙƒÙÙˆÙ†Ù Ù„ÙÙƒÙÙ…Ù’ Ø¶ÙÙŠÙ‚ÙŒØŒ ÙˆÙÙ„ÙƒÙÙ†Ù’ Ø«ÙÙ‚ÙÙˆØ§: Ø£ÙÙ†ÙØ§ Ù‚ÙØ¯Ù’ ØºÙÙ„ÙØ¨Ù’ØªÙ Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…Ù.",r:"ÙŠÙˆØ­Ù†Ø§ 16: 33"},
    {t:"Ù†ÙØ­Ù’Ù†Ù Ù†ÙØ¹Ù’Ù„ÙÙ…Ù Ø£ÙÙ†ÙÙ‘ ÙƒÙÙ„ÙÙ‘ Ø§Ù„Ø£ÙØ´Ù’ÙŠÙØ§Ø¡Ù ØªÙØ¹Ù’Ù…ÙÙ„Ù Ù…ÙØ¹Ù‹Ø§ Ù„ÙÙ„Ù’Ø®ÙÙŠÙ’Ø±Ù Ù„ÙÙ„ÙÙ‘Ø°ÙÙŠÙ†Ù ÙŠÙØ­ÙØ¨ÙÙ‘ÙˆÙ†Ù Ø§Ù„Ù„Ù‡Ù.",r:"Ø±ÙˆÙ…ÙŠØ© 8: 28"},
    {t:"Ù‚ÙØ±ÙÙŠØ¨ÙŒ Ù‡ÙÙˆÙ Ø§Ù„Ø±ÙÙ‘Ø¨ÙÙ‘ Ù…ÙÙ†Ù Ø§Ù„Ù’Ù…ÙÙ†Ù’ÙƒÙØ³ÙØ±ÙÙŠ Ø§Ù„Ù’Ù‚ÙÙ„ÙÙˆØ¨Ù.",r:"Ù…Ø²Ù…ÙˆØ± 34: 18"},
    {t:"Ø§ÙØªÙÙ‘ÙƒÙÙ„Ù’ Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ø±ÙÙ‘Ø¨ÙÙ‘ Ø¨ÙÙƒÙÙ„ÙÙ‘ Ù‚ÙÙ„Ù’Ø¨ÙÙƒÙØŒ ÙˆÙØ¹ÙÙ„ÙÙ‰ ÙÙÙ‡Ù’Ù…ÙÙƒÙ Ù„Ø§Ù ØªÙØ¹Ù’ØªÙÙ…ÙØ¯Ù’.",r:"Ø£Ù…Ø«Ø§Ù„ 3: 5"},
    {t:"Ù‡Ø£ÙÙ†ÙØ°ÙØ§ Ù‚ÙØ¯Ù’ Ù†ÙÙ‚ÙØ´Ù’ØªÙÙƒÙ Ø¹ÙÙ„ÙÙ‰ ÙƒÙÙÙÙ‘ÙŠÙÙ‘. Ø£ÙØ³Ù’ÙˆÙØ§Ø±ÙÙƒÙ Ø£ÙÙ…ÙØ§Ù…ÙÙŠ Ø¯ÙØ§Ø¦ÙÙ…Ù‹Ø§.",r:"Ø¥Ø´Ø¹ÙŠØ§Ø¡ 49: 16"},
    {t:"Ø³ÙØ±ÙØ§Ø¬ÙŒ Ù„ÙØ±ÙØ¬Ù’Ù„ÙÙŠ ÙƒÙÙ„Ø§ÙÙ…ÙÙƒÙ ÙˆÙÙ†ÙÙˆØ±ÙŒ Ù„ÙØ³ÙØ¨ÙÙÙŠÙ„ÙŠ.",r:"Ù…Ø²Ù…ÙˆØ± 119: 105"}
];

const prayers = [
    "ÙŠØ§Ø±Ø¨ ÙŠØ³ÙˆØ¹ Ø§Ù„Ù…Ø³ÙŠØ­.. Ø§Ø±Ø­Ù…Ù†ÙŠ Ø£Ù†Ø§ Ø§Ù„Ø®Ø§Ø·Ø¦",
    "ÙŠØ§ Ø±Ø¨ÙŠ ÙŠØ³ÙˆØ¹ Ø§Ù„Ù…Ø³ÙŠØ­.. Ø£Ø¹Ù†Ù‘ÙŠ",
    "ÙŠØ§ Ø±Ø¨ÙŠ ÙŠØ³ÙˆØ¹ Ø§Ù„Ù…Ø³ÙŠØ­.. Ø§Ø³ØªØ± Ø¹Ù„ÙŠÙ‘",
    "ÙŠØ§ Ø±Ø¨ÙŠ ÙŠØ³ÙˆØ¹ Ø§Ù„Ù…Ø³ÙŠØ­.. Ø£Ù†Ù‚Ø°Ù†ÙŠ",
    "ÙŠØ§ Ø±Ø¨ÙŠ ÙŠØ³ÙˆØ¹ Ø§Ù„Ù…Ø³ÙŠØ­.. Ø£Ù…Ù„Ø£ Ù‚Ù„Ø¨ÙŠ Ø¨Ø­Ø¨Ùƒ"
];

let currentMood = "ğŸ˜Œ";
let pCount = 0;
let quizTimerInterval;
let allQuizQuestions = [];
let selectedQuizStudentName = "";

// ===== THEME =====
function toggleTheme() {
    const body = document.body;
    const btn = document.getElementById('themeBtn');
    if (body.getAttribute('data-theme') === 'dark') {
        body.removeAttribute('data-theme');
        btn.innerText = "â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­";
        localStorage.setItem('theme','light');
    } else {
        body.setAttribute('data-theme','dark');
        btn.innerText = "ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†";
        localStorage.setItem('theme','dark');
    }
}

// ===== LOGIN =====
function checkAccess() {
    if (document.getElementById('passInputUser').value === "jesus") {
        localStorage.setItem('session_login_time', Date.now());
        localStorage.setItem('session_login_type', 'user');
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        startApp();
        showRandomVerse();
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    } else { alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£ âŒ"); }
}

function openAdmin() {
    const p = prompt("ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø®Ø¯Ø§Ù…:");
    if (p === "admin123") {
        localStorage.setItem('session_login_time', Date.now());
        localStorage.setItem('session_login_type', 'admin');
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'block';
        loadAdminData();
    }
}

// ===== ADMIN =====
function loadAdminData() {
    db.ref("prayer_reports").limitToLast(10).on("value", snap => {
        const list = document.getElementById('prayerResultsList');
        list.innerHTML = "";
        snap.forEach(child => {
            const d = child.val();
            list.innerHTML += `<div class="prayer-result-item"><b>${d.makhdom}:</b> ØµÙ„Ù‰ ${d.duration} <br><small>${d.time}</small></div>`;
        });
    });
    
    // ØªØ­Ù…ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    db.ref("prayer_encouragement").once("value", snap => {
        const encouragement = snap.val();
        if (encouragement) {
            document.getElementById('prayerEncouragementInput').value = encouragement;
        }
    });
}

function updateAdminAlert() {
    const val = document.getElementById('newAdminAlert').value;
    db.ref("admin_announcement").set(val);
    alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± âœ…");
}

function updatePrayerEncouragement() {
    const val = document.getElementById('prayerEncouragementInput').value.trim();
    if (!val) return alert("Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© ØªØ´Ø¬ÙŠØ¹!");
    db.ref("prayer_encouragement").set(val);
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ’");
}

// ===== VERSE =====
function showRandomVerse() {
    const now = Date.now();
    const savedVerse = localStorage.getItem('daily_verse_data');
    const twelveHours = 12 * 60 * 60 * 1000; // 12 Ø³Ø§Ø¹Ø© Ø¨Ø§Ù„Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©
    
    if (savedVerse) {
        const verseData = JSON.parse(savedVerse);
        const timePassed = now - verseData.timestamp;
        
        // Ù„Ùˆ Ù…Ø± Ø£Ù‚Ù„ Ù…Ù† 12 Ø³Ø§Ø¹Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        if (timePassed < twelveHours) {
            document.getElementById('dailyVerse').innerText = `"${verseData.text}"`;
            document.getElementById('verseRef').innerText = `âœ ${verseData.ref}`;
            return;
        }
    }
    
    // Ù„Ùˆ Ù…ÙÙŠØ´ Ø¢ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© Ø£Ùˆ Ø¹Ø¯Ù‰ 12 Ø³Ø§Ø¹Ø©ØŒ Ø§Ø®ØªØ± Ø¢ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
    const v = bibleVerses[Math.floor(Math.random() * bibleVerses.length)];
    document.getElementById('dailyVerse').innerText = `"${v.t}"`;
    document.getElementById('verseRef').innerText = `âœ ${v.r}`;
    
    // Ø§Ø­ÙØ¸ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª
    localStorage.setItem('daily_verse_data', JSON.stringify({
        text: v.t,
        ref: v.r,
        timestamp: now
    }));
}

// ===== START APP =====
function startApp() {
    if (localStorage.getItem('chat_user_name')) document.getElementById('userName').value = localStorage.getItem('chat_user_name');

    db.ref("admin_announcement").on("value", snap => {
        const text = snap.val();
        document.getElementById('adminAlert').style.display = (text && text.trim() !== "") ? 'block' : 'none';
        document.getElementById('alertText').innerText = text;
    });

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ´Ø¬ÙŠØ¹ Ø¹Ù† Ø§Ù„ØµÙ„Ø§Ø©
    db.ref("prayer_encouragement").on("value", snap => {
        const encouragement = snap.val();
        const box = document.getElementById('prayerEncouragementBox');
        const text = document.getElementById('prayerEncouragementText');
        
        if (encouragement && encouragement.trim() !== "") {
            text.innerText = encouragement;
            box.style.display = 'block';
        } else {
            box.style.display = 'none';
        }
    });

    db.ref("settings/quizEnabled").on("value", snap => {
        document.getElementById('quizSection').style.display = snap.val() === true ? "block" : "none";
    });

    db.ref("settings/libVisible").on("value", snap => {
        document.getElementById('librarySection').style.display = snap.val() !== false ? "block" : "none";
    });

    db.ref("media_library").on("value", snap => {
        const d = snap.val();
        if (d) {
            document.getElementById('hymnLink').href = d.hymn || "#";
            document.getElementById('pdfLink').href = d.pdf || "#";
            document.getElementById('videoLink').href = d.video || "#";
        }
    });

    listenToAdminPrayers();

    db.ref("points_data").on("value", snap => {
        const data = snap.val();
        if (data) {
            localStorage.setItem('offline_points_data', JSON.stringify(data));
            updateLeaderboardUI(data);
        }
    });

    db.ref("chat").limitToLast(15).on("value", snap => {
        const box = document.getElementById('chatBox');
        box.innerHTML = "";
        snap.forEach(c => {
            const msg = c.val();
            const isAdmin = msg.sender.includes("Ø£/") || msg.sender.includes("Ø£Ù…ÙŠÙ†");
            box.innerHTML += `<div class="chat-msg ${isAdmin ? 'admin-msg' : ''}"><b>${msg.sender}:</b> ${msg.text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    });

    db.ref("psychology/private_chats/" + psySessionID).on("value", snap => {
        const box = document.getElementById('psyLocalChat');
        box.innerHTML = "";
        snap.forEach(m => {
            const msg = m.val();
            box.innerHTML += `<div style="margin-bottom:4px; color:${msg.sender === "Ø£Ù†Ø§" ? "#ec4899" : "#fbbf24"};"><b>${msg.sender}:</b> ${msg.text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    });
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ´Ø¬ÙŠØ¹
    setTimeout(() => {
        checkEncouragementMessages();
    }, 2000);
}

// ===== LEADERBOARD =====
function updateLeaderboardUI(data) {
    const selectQuiz = document.getElementById('userNameListQuiz');
    const selectPrayer = document.getElementById('prayerUserName');
    const selectAttendance = document.getElementById('attendanceNameSelect');
    const selectName = document.getElementById('nameSelect');
    const list = document.getElementById('leaderboard');
    if (!list) return;

    const curQ = selectQuiz ? selectQuiz.value : "";
    const curP = selectPrayer ? selectPrayer.value : "";
    const curA = selectAttendance ? selectAttendance.value : "";
    const curN = selectName ? selectName.value : "";

    if (selectQuiz) selectQuiz.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ --</option>';
    if (selectPrayer) selectPrayer.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ --</option>';
    if (selectAttendance) selectAttendance.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ --</option>';
    if (selectName) selectName.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ --</option>';

    list.innerHTML = "";
    Object.values(data).sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
        if (selectQuiz) selectQuiz.innerHTML += `<option value="${p.name}">${p.name}</option>`;
        if (selectPrayer) selectPrayer.innerHTML += `<option value="${p.name}">${p.name}</option>`;
        if (selectAttendance) selectAttendance.innerHTML += `<option value="${p.name}">${p.name}</option>`;
        if (selectName) selectName.innerHTML += `<option value="${p.name}">${p.name}</option>`;
    });

    if (selectQuiz) selectQuiz.value = curQ;
    if (selectPrayer) selectPrayer.value = curP;
    if (selectAttendance) selectAttendance.value = curA;
    if (selectName) selectName.value = curN;

    Object.values(data).sort((a,b) => b.score - a.score).forEach(p => {
        // Get breakdown from Firebase instead of localStorage
        const breakdown = p.breakdown || {};
        const quizPoints = breakdown.quiz || 0;
        const prayerPoints = breakdown.prayer || 0;
        const attendancePoints = breakdown.attendance || 0;
        
        // Calculate max for scaling
        const maxPoints = Math.max(quizPoints, prayerPoints, attendancePoints, 1);
        const quizHeight = (quizPoints / maxPoints) * 100;
        const prayerHeight = (prayerPoints / maxPoints) * 100;
        const attendanceHeight = (attendancePoints / maxPoints) * 100;
        
        let clr = p.score >= 70 ? 'bg-high' : (p.score >= 40 ? 'bg-mid' : 'bg-low');
        
        list.innerHTML += `<div class="card" onclick="toggleCardView(this)">
            <div class="card-default-view">
                <div class="bar-wrap"><div class="bar ${clr}" style="height:${Math.min(p.score,100)}%"></div></div>
                <div style="font-weight:800; color:#fbbf24; font-size:15px;">${p.score}</div>
                <div style="font-size:11px; color:#cbd5e0;">${p.name}</div>
            </div>
            
            <div class="card-details-view">
                <div class="mini-bars-container">
                    <div class="mini-bar-col">
                        <div class="mini-bar quiz" style="height:${quizHeight}%"></div>
                        <div class="mini-bar-label">ğŸ“–</div>
                        <div class="mini-bar-value">${quizPoints}</div>
                    </div>
                    <div class="mini-bar-col">
                        <div class="mini-bar prayer" style="height:${prayerHeight}%"></div>
                        <div class="mini-bar-label">ğŸ™</div>
                        <div class="mini-bar-value">${prayerPoints}</div>
                    </div>
                    <div class="mini-bar-col">
                        <div class="mini-bar attendance" style="height:${attendanceHeight}%"></div>
                        <div class="mini-bar-label">â›ª</div>
                        <div class="mini-bar-value">${attendancePoints}</div>
                    </div>
                </div>
                <div style="font-weight:800; color:#fbbf24; font-size:15px; margin-top:4px;">${p.score}</div>
                <div style="font-size:11px; color:#cbd5e0;">${p.name}</div>
            </div>
        </div>`;
    });
}

// ===== SHOW POINTS BREAKDOWN =====
function showPointsBreakdown(name, totalScore) {
    // Get breakdown from Firebase
    db.ref("points_data").once("value", snap => {
        let breakdown = {};
        snap.forEach(child => {
            if (child.val().name === name) {
                breakdown = child.val().breakdown || {};
            }
        });
        
        const quizPoints = breakdown.quiz || 0;
        const prayerPoints = breakdown.prayer || 0;
        const attendancePoints = breakdown.attendance || 0;
        
        // Calculate max for scaling
        const maxPoints = Math.max(quizPoints, prayerPoints, attendancePoints, 1);
        
        // Calculate heights as percentages
        const quizHeight = (quizPoints / maxPoints) * 100;
        const prayerHeight = (prayerPoints / maxPoints) * 100;
        const attendanceHeight = (attendancePoints / maxPoints) * 100;
        
        const modal = document.getElementById('pointsModal');
        document.getElementById('modalName').textContent = name;
        document.getElementById('modalTotalScore').textContent = totalScore;
        
        // Set bar heights with animation
        setTimeout(() => {
            document.getElementById('quizBar').style.height = quizHeight + '%';
            document.getElementById('prayerBar').style.height = prayerHeight + '%';
            document.getElementById('attendanceBar').style.height = attendanceHeight + '%';
        }, 100);
        
        // Update values
        document.getElementById('quizPoints').textContent = quizPoints;
        document.getElementById('prayerPoints').textContent = prayerPoints;
        document.getElementById('attendancePoints').textContent = attendancePoints;
        
        modal.style.display = 'flex';
    });
}

function closePointsModal() {
    const modal = document.getElementById('pointsModal');
    modal.style.display = 'none';
    
    // Reset heights
    document.getElementById('quizBar').style.height = '0%';
    document.getElementById('prayerBar').style.height = '0%';
    document.getElementById('attendanceBar').style.height = '0%';
}


// ===== ADMIN PRAYER HINTS =====
function listenToAdminPrayers() {
    db.ref("admin_prayer_hints").on("value", (snapshot) => {
        const data = snapshot.val() || {};
        document.getElementById('admin_agpeya_hint').innerText = data.agpeya || "ØµÙ„ÙÙ‘ Ù…Ø²Ù…ÙˆØ±Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø¬Ø¨ÙŠØ©..";
        document.getElementById('admin_thanks_hint').innerText = data.thanks || "Ø§Ø´ÙƒØ± Ø§Ù„Ù„Ù‡ Ø¹Ù„Ù‰ ÙƒÙ„ Ø­Ø§Ù„..";
        document.getElementById('admin_forgive_hint').innerText = data.forgive || "Ø§Ø·Ù„Ø¨ ØªÙˆØ¨Ø© Ù†Ù‚ÙŠØ©..";
        document.getElementById('admin_heart_hint').innerText = data.heart || "Ø§Ø¬Ø¹Ù„ Ù‚Ù„Ø¨Ùƒ ÙŠØ´ØªØ¹Ù„ Ø¨Ø­Ø¨ Ø§Ù„Ù…Ø³ÙŠØ­..";
        document.getElementById('admin_union_hint').innerText = data.union || "Ø§Ø·Ù„Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙˆØ§Ø­Ø¯Ø§Ù‹ Ù…Ø¹Ù‡..";
        document.getElementById('admin_verse_hint').innerText = data.verse || "Ø´Ø§Ø±ÙƒÙ†Ø§ Ø¢ÙŠØ© Ù„Ù…Ø³ØªÙƒ Ø§Ù„ÙŠÙˆÙ…..";
    });
}

// ===== MUTUAL PRAYER (ALTAR) =====
function sendMutualPrayer() {
    const name = document.getElementById('prayerUserName').value;
    const durationValue = document.getElementById('prayerDuration').value.trim();
    const agpeya = document.getElementById('agpeyaText').value.trim();
    const thanks = document.getElementById('prayThank').value.trim();
    const forgive = document.getElementById('prayForgive').value.trim();
    const verse = document.getElementById('bibleVerseText').value.trim();

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù…
    if (!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ â¤ï¸");
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø©
    if (!durationValue) return alert("Ø­Ø¯Ø¯ Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ â±ï¸");
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø© Ø§Ù„Ø£Ø¬Ø¨ÙŠØ©
    if (!agpeya) return alert("Ø§ÙƒØªØ¨ ØµÙ„Ø§Ø© Ù…Ù† Ø§Ù„Ø£Ø¬Ø¨ÙŠØ© ğŸ“–");
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø© Ø§Ù„Ø´ÙƒØ±
    if (!thanks) return alert("Ø§ÙƒØªØ¨ Ø´ÙƒØ±Ùƒ Ù„Ø±Ø¨Ù†Ø§ ğŸ™");
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºÙØ±Ø©
    if (!forgive) return alert("Ø§ÙƒØªØ¨ Ø·Ù„Ø¨ Ø§Ù„Ù…ØºÙØ±Ø© ÙˆØ§Ù„Ø®Ø¶ÙˆØ¹ ğŸ’™");
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¢ÙŠØ©
    if (!verse) return alert("Ø§ÙƒØªØ¨ Ø¢ÙŠØ© Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ù‚Ø¯Ø³ ğŸ“œ");

    const lastPrayerDate = localStorage.getItem('last_prayer_submit_date');
    const todayDate = new Date().toLocaleDateString();
    if (lastPrayerDate === todayDate) {
        return alert("Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø°Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„! Ù†Ù†ØªØ¸Ø±Ùƒ ØºØ¯Ø§Ù‹ Ø¨ÙƒÙ„ Ø­Ø¨ â¤ï¸");
    }

    const report = {
        makhdom: name,
        time: new Date().toLocaleString(),
        duration: durationValue + " Ø¯Ù‚ÙŠÙ‚Ø©",
        metania: { done: document.getElementById('metaniaDone').checked, count: document.getElementById('metaniaCount').value || 0 },
        agpeya: agpeya,
        thanks: thanks,
        forgive: forgive,
        heart: document.getElementById('prayHeart').value,
        union: document.getElementById('prayUnion').value,
        verse: verse
    };

    db.ref("prayer_reports").push(report).then(() => {
        db.ref("points_data").once("value", snap => {
            snap.forEach(child => {
                if (child.val().name === name) {
                    const currentScore = child.val().score || 0;
                    const currentBreakdown = child.val().breakdown || {};
                    
                    // Update breakdown in Firebase
                    const newBreakdown = {
                        quiz: currentBreakdown.quiz || 0,
                        prayer: (currentBreakdown.prayer || 0) + 5,
                        attendance: currentBreakdown.attendance || 0
                    };
                    
                    child.ref.update({ 
                        score: currentScore + 5,
                        breakdown: newBreakdown
                    });
                }
            });
        });
        
        // ========== Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ© ==========
        trackPrayerStreak(name);
        
        localStorage.setItem('last_prayer_submit_date', todayDate);
        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ ÙŠØ§ " + name + "! ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù¥ Ø¯Ø±Ø¬Ø§Øª Ù„Ù…ÙŠØ²Ø§Ù†Ùƒ ğŸ");
        document.querySelectorAll('#mutualPrayerSection textarea, #mutualPrayerSection input:not([type="checkbox"])').forEach(el => el.value = "");
        document.getElementById('metaniaDone').checked = false;
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.8 } });
    });
}

// ========== Ø¯Ø§Ù„Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ© Ù„Ù„ØµÙ„Ø§Ø© ==========
function trackPrayerStreak(userName) {
    const userId = getUserId(userName);
    const todayDate = new Date().toLocaleDateString();
    const yesterdayDate = new Date(Date.now() - 86400000).toLocaleDateString();
    
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ§Ø¨Ø¹ Ù…Ù† Firebase
    db.ref(`users/${userId}/prayer_streak`).once('value', snapshot => {
        let streakData = snapshot.val() || { 
            currentStreak: 0, 
            longestStreak: 0, 
            lastPrayerDate: null 
        };
        
        // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙ„Ø§Ø© Ù…ØªØªØ§Ù„ÙŠØ©
        if (streakData.lastPrayerDate === yesterdayDate) {
            // ÙŠÙˆÙ… Ù…ØªØªØ§Ù„ÙŠ
            streakData.currentStreak++;
        } else if (streakData.lastPrayerDate !== todayDate) {
            // Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø§Ù†Ù‚Ø·Ø§Ø¹
            streakData.currentStreak = 1;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø£Ø·ÙˆÙ„ Ø³Ù„Ø³Ù„Ø©
        if (streakData.currentStreak > streakData.longestStreak) {
            streakData.longestStreak = streakData.currentStreak;
        }
        
        streakData.lastPrayerDate = todayDate;
        
        // Ø­ÙØ¸ ÙÙŠ Firebase
        db.ref(`users/${userId}/prayer_streak`).set(streakData);
        
        // Ø¥Ø¹Ø·Ø§Ø¡ Ø´Ø§Ø±Ø§Øª ÙˆØªØ´Ø¬ÙŠØ¹
        checkPrayerBadges(userName, streakData.currentStreak);
    });
}

// ========== ÙØ­Øµ ÙˆØ¥Ø¹Ø·Ø§Ø¡ Ø´Ø§Ø±Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© ==========
function checkPrayerBadges(userName, streak) {
    const userId = getUserId(userName);
    
    // Ø´Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©
    const badges = [
        { days: 3, id: 'prayer-3days', title: 'Ù…ØµÙ„ÙŠ 3 Ø£ÙŠØ§Ù…', icon: 'ğŸ™', type: 'bronze', message: 'Ø±Ø§Ø¦Ø¹! 3 Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ© Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø©! ğŸ™' },
        { days: 7, id: 'prayer-week', title: 'Ø£Ø³Ø¨ÙˆØ¹ ÙƒØ§Ù…Ù„', icon: 'â­', type: 'silver', message: 'Ù…Ø¨Ø±ÙˆÙƒ! Ø£Ø³Ø¨ÙˆØ¹ ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø©! â­' },
        { days: 14, id: 'prayer-2weeks', title: 'Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† Ù…ØªÙˆØ§ØµÙ„ÙŠÙ†', icon: 'ğŸŒŸ', type: 'silver', message: 'Ù…Ù…ØªØ§Ø²! Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©! ğŸŒŸ' },
        { days: 21, id: 'prayer-21days', title: 'Ù…Ø­Ø§Ø±Ø¨ ØµÙ„Ø§Ø©', icon: 'ğŸ’ª', type: 'gold', message: 'Ø£Ù†Øª Ù…Ø­Ø§Ø±Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ! 21 ÙŠÙˆÙ… ØµÙ„Ø§Ø©! ğŸ’ª' },
        { days: 30, id: 'prayer-month', title: 'Ø´Ù‡Ø± ÙƒØ§Ù…Ù„', icon: 'ğŸ†', type: 'gold', message: 'Ø¥Ù†Ø¬Ø§Ø² Ø¹Ø¸ÙŠÙ…! Ø´Ù‡Ø± ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø©! ğŸ†' },
        { days: 50, id: 'prayer-50days', title: 'Ø§Ù„Ø®Ù…Ø³ÙŠÙ† Ø§Ù„Ù…Ù‚Ø¯Ø³Ø©', icon: 'âœ¨', type: 'gold', message: 'Ù…Ø°Ù‡Ù„! 50 ÙŠÙˆÙ… Ù…ØªØªØ§Ù„ÙŠ! âœ¨' },
        { days: 100, id: 'prayer-100days', title: 'Ù‚Ø¯ÙŠØ³ Ø§Ù„ØµÙ„Ø§Ø©', icon: 'ğŸ‘‘', type: 'gold', message: 'Ø£Ù†Øª Ù‚Ø¯ÙŠØ³ Ø­Ù‚ÙŠÙ‚ÙŠ! 100 ÙŠÙˆÙ… ØµÙ„Ø§Ø©! ğŸ‘‘' }
    ];
    
    badges.forEach(badge => {
        if (streak === badge.days) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø§Ø±Ø©
            addBadgeForUser(userId, badge.id, badge.title, badge.type, badge.icon);
            
            // Ø¥Ø¶Ø§ÙØ© XP Ù…ÙƒØ§ÙØ£Ø©
            const bonusXP = badge.days * 2;
            addXPForUser(userId, bonusXP, `${badge.days} ÙŠÙˆÙ… ØµÙ„Ø§Ø© Ù…ØªØªØ§Ù„ÙŠØ©`);
            
            // Ø±Ø³Ø§Ù„Ø© ØªØ´Ø¬ÙŠØ¹ Ù…Ø®ØµØµØ©
            showPrayerEncouragement(userName, badge.message, streak);
            
            // ÙƒÙˆÙ†ÙÙŠØªÙŠ Ø®Ø§Øµ
            if (typeof confetti !== 'undefined') {
                confetti({
                    particleCount: 200,
                    spread: 100,
                    origin: { y: 0.6 },
                    colors: ['#fbbf24', '#f59e0b', '#d97706']
                });
            }
        }
    });
    
    // Ø±Ø³Ø§Ø¦Ù„ ØªØ´Ø¬ÙŠØ¹ ÙŠÙˆÙ…ÙŠØ©
    if (streak > 0 && streak < 3) {
        setTimeout(() => {
            showPrayerEncouragement(userName, `ÙŠÙˆÙ… ${streak} Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø©! Ø§Ø³ØªÙ…Ø± ÙŠØ§ ${userName.split(' ')[0]}! ğŸ’ª`, streak);
        }, 2000);
    }
}

// ========== Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ´Ø¬ÙŠØ¹ Ù„Ù„ØµÙ„Ø§Ø© ==========
function showPrayerEncouragement(userName, message, streak) {
    const encouragementHTML = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: linear-gradient(135deg, #667eea, #764ba2); 
                    padding: 35px; border-radius: 30px; 
                    box-shadow: 0 20px 60px rgba(0,0,0,0.4); 
                    z-index: 10001; max-width: 90%; width: 400px;
                    animation: popupAppear 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);"
             id="prayerEncouragementPopup">
            <div style="font-size: 64px; text-align: center; margin-bottom: 15px; animation: bounce 1s infinite;">ğŸ”¥</div>
            <div style="font-size: 24px; font-weight: 900; color: white; text-align: center; margin-bottom: 15px; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                ${streak} ${streak === 1 ? 'ÙŠÙˆÙ…' : streak === 2 ? 'ÙŠÙˆÙ…Ø§Ù†' : 'Ø£ÙŠØ§Ù…'} Ù…ØªØªØ§Ù„ÙŠØ©! ğŸ‰
            </div>
            <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); 
                        padding: 20px; border-radius: 20px; color: white; 
                        font-size: 16px; line-height: 1.8; margin: 15px 0; 
                        border: 2px solid rgba(255,255,255,0.2); text-align: center;">
                ${message}
            </div>
            <div style="color: rgba(255,255,255,0.9); font-size: 14px; text-align: center; margin-top: 15px;">
                "ØµÙÙ„ÙÙ‘ÙˆØ§ Ø¨ÙÙ„Ø§Ù Ø§Ù†Ù’Ù‚ÙØ·ÙØ§Ø¹Ù" - 1 ØªØ³Ø§Ù„ÙˆÙ†ÙŠÙƒÙŠ 5: 17
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closePrayerEncouragement()" 
                        style="background: rgba(255,255,255,0.3); color: white; border: none; 
                               padding: 12px 30px; border-radius: 30px; font-weight: 800; 
                               cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 15px; 
                               transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡! ğŸ™
                </button>
            </div>
        </div>
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); 
                    backdrop-filter: blur(5px); z-index: 10000;" 
             id="prayerEncouragementOverlay" 
             onclick="closePrayerEncouragement()"></div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', encouragementHTML);
}

function closePrayerEncouragement() {
    const popup = document.getElementById('prayerEncouragementPopup');
    const overlay = document.getElementById('prayerEncouragementOverlay');
    if (popup) popup.remove();
    if (overlay) overlay.remove();
}

// ===== QUIZ =====

// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø­ÙØ¸ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
async function checkIfQuizSubmitted(quizId) {
    if (!currentUserId) {
        console.error('User ID not found');
        return false;
    }
    
    try {
        const snapshot = await db.ref(`quiz_submissions/${quizId}/${currentUserId}`).once('value');
        return snapshot.exists();
    } catch (error) {
        console.error('Error checking quiz submission:', error);
        return false;
    }
}

async function saveQuizSubmission(quizId, answers, score, max, finalPoints) {
    if (!currentUserId || !currentUserName) {
        alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        return false;
    }
    
    try {
        await db.ref(`quiz_submissions/${quizId}/${currentUserId}`).set({
            userName: currentUserName,
            userId: currentUserId,
            answers: answers,
            score: score,
            max: max,
            finalPoints: finalPoints,
            timestamp: Date.now(),
            submittedAt: new Date().toLocaleString()
        });
        return true;
    } catch (error) {
        console.error('Error saving quiz submission:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        return false;
    }
}

async function showAlreadySubmittedQuizMessage(quizId) {
    try {
        const snapshot = await db.ref(`quiz_submissions/${quizId}/${currentUserId}`).once('value');
        if (snapshot.exists()) {
            const data = snapshot.val();
            alert(`â›” Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø­Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹!\n\nğŸ“Š Ø¯Ø±Ø¬ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: ${data.score}/${data.max}\nğŸ¯ Ø§Ù„Ù†Ù‚Ø§Ø·: ${data.finalPoints}\n\nâŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­Ù„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`);
        } else {
            alert('â›” Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø­Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹!\n\nâŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­Ù„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        }
    } catch (error) {
        alert('â›” Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø­Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹!\n\nâŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­Ù„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
}

async function startQuiz() {
    selectedQuizStudentName = document.getElementById('userNameListQuiz').value;
    if (!selectedQuizStudentName) return alert("Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
    
    // ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
    const currentQuizId = 'current_quiz_2026';
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø³Ø¨Ù‚ ÙÙŠ Firebase
    const alreadySubmitted = await checkIfQuizSubmitted(currentQuizId);
    
    if (alreadySubmitted) {
        await showAlreadySubmittedQuizMessage(currentQuizId);
        localStorage.setItem('quiz_bound_name', selectedQuizStudentName);
        showFinishedStatus();
        return;
    }
    
    const boundName = localStorage.getItem('quiz_bound_name');
    if (boundName && boundName !== selectedQuizStudentName) {
        return alert(`Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø³Ø¬Ù„ Ø¨Ø§Ø³Ù… (${boundName}). Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­Ù„ Ù„Ø²Ù…ÙŠÙ„ Ø¢Ø®Ø±!`);
    }
    db.ref("bible_quiz/submissions").orderByChild("userName").equalTo(selectedQuizStudentName).once("value", snap => {
        if (snap.exists()) {
            alert("Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø­Ù„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹!");
            localStorage.setItem('quiz_bound_name', selectedQuizStudentName);
            showFinishedStatus();
        } else {
            localStorage.setItem('quiz_bound_name', selectedQuizStudentName);
            loadQuiz();
        }
    });
}

function loadQuiz() {
    db.ref("settings/quizTimer").once("value", snapTime => {
        let timerMinutes = snapTime.val() || 5;
        let durationInSeconds = timerMinutes * 60;
        db.ref("bible_quiz/questions").once("value", snapQ => {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = ""; allQuizQuestions = []; let i = 0;
            snapQ.forEach(child => {
                const q = child.val(); allQuizQuestions.push({...q, id: child.key});
                let html = `<div class="question-card"><p><b>Ø³${i+1}: ${q.text}</b> <small style="color:var(--text-secondary);">(${q.points||1} Ø¯Ø±Ø¬Ø©)</small></p>`;
                if (q.type === 'choice' || q.type === 'truefalse') {
                    (q.options || []).forEach(opt => { if(opt) html += `<label class="option-label"><input type="radio" name="quiz_q_${i}" value="${opt}"> ${opt}</label>`; });
                } else if (q.type === 'essay') {
                    html += `<textarea id="quiz_ans_${i}" onpaste="return false;" oninput="updateCharCount(${i})" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ù‡Ù†Ø§..." style="height:100px; width:100%; border-radius:12px;"></textarea><div style="text-align:left; font-size:12px; color:var(--text-secondary);"><span id="charCount_${i}">0</span> Ø­Ø±Ù</div>`;
                } else {
                    html += `<input type="text" id="quiz_ans_${i}" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©...">`;
                }
                container.innerHTML += html + `</div>`; i++;
            });
            document.getElementById('quizSetup').style.display = 'none';
            document.getElementById('quizArea').style.display = 'block';
            startCountdown(durationInSeconds);
        });
    });
}

function startCountdown(duration) {
    let secondsLeft = duration;
    if (quizTimerInterval) clearInterval(quizTimerInterval);
    quizTimerInterval = setInterval(() => {
        let mins = Math.floor(secondsLeft / 60);
        let secs = secondsLeft % 60;
        const display = document.getElementById('timeLeft');
        if (display) display.innerText = (mins<10?"0":"")+mins+":"+(secs<10?"0":"")+secs;
        if (secondsLeft <= 0) { clearInterval(quizTimerInterval); submitQuiz(); }
        secondsLeft--;
    }, 1000);
}

async function submitQuiz() {
    if (quizTimerInterval) clearInterval(quizTimerInterval);
    let correctAnswers = 0, totalQuestions = 0, submittedAnswers = [];
    allQuizQuestions.forEach((q, idx) => {
        let ans = "", isCorrect = false;
        totalQuestions++;
        if (q.type === 'choice' || q.type === 'truefalse') {
            const sel = document.querySelector(`input[name="quiz_q_${idx}"]:checked`);
            ans = sel ? sel.value : "";
            if (q.correctAnswer && ans === q.correctAnswer) { correctAnswers++; isCorrect = true; }
        } else if (q.type === 'essay') {
            ans = document.getElementById(`quiz_ans_${idx}`).value.trim();
            if (ans.length >= 50) { correctAnswers++; isCorrect = true; }
            else if (ans.length >= 20) { correctAnswers += 0.7; }
        } else {
            ans = document.getElementById(`quiz_ans_${idx}`).value;
            if (q.correctAnswer && ans.trim().toLowerCase() === q.correctAnswer.trim().toLowerCase()) { correctAnswers++; isCorrect = true; }
        }
        submittedAnswers.push({question: q.text, userAnswer: ans});
    });

    const wrongAnswers = totalQuestions - Math.floor(correctAnswers);
    let finalPoints = 3;
    if (wrongAnswers === 0) finalPoints = 5;
    else if (wrongAnswers === 1) finalPoints = 4;

    const currentQuizId = 'current_quiz_2026';
    
    // Ø­ÙØ¸ ÙÙŠ Ù†Ø¸Ø§Ù… Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
    const saved = await saveQuizSubmission(
        currentQuizId, 
        submittedAnswers, 
        Math.floor(correctAnswers), 
        totalQuestions, 
        finalPoints
    );
    
    if (!saved) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨ØªÙƒ. Ù„Ù… ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·.');
        return;
    }

    await db.ref("bible_quiz/submissions").push({ userName: selectedQuizStudentName, score: Math.floor(correctAnswers), max: totalQuestions, finalPoints, answers: submittedAnswers, time: new Date().toLocaleString() });
    db.ref("points_data").once("value", snap => {
        snap.forEach(child => { 
            if (child.val().name === selectedQuizStudentName) {
                const currentScore = child.val().score || 0;
                const currentBreakdown = child.val().breakdown || {};
                
                // Update breakdown in Firebase
                const newBreakdown = {
                    quiz: (currentBreakdown.quiz || 0) + finalPoints,
                    prayer: currentBreakdown.prayer || 0,
                    attendance: currentBreakdown.attendance || 0
                };
                
                child.ref.update({ 
                    score: currentScore + finalPoints,
                    breakdown: newBreakdown,
                    lastUpdate: Date.now()
                });
            }
        });
    });
    
    // ========== Ù†Ø¸Ø§Ù… Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ==========
    checkQuizBadges(selectedQuizStudentName, Math.floor(correctAnswers), totalQuestions, wrongAnswers);
    
    showFinishedStatus(Math.floor(correctAnswers), totalQuestions, finalPoints);
}

// ========== ÙØ­Øµ ÙˆØ¥Ø¹Ø·Ø§Ø¡ Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ==========
function checkQuizBadges(userName, score, total, wrong) {
    const userId = getUserId(userName);
    const percentage = (score / total) * 100;
    
    // Ø´Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¯Ø§Ø¡
    if (wrong === 0 && total >= 5) {
        // Ù…Ø«Ø§Ù„ÙŠ!
        addBadgeForUser(userId, 'quiz-perfect', 'Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø«Ø§Ù„ÙŠØ©', 'gold', 'ğŸ†');
        addXPForUser(userId, 50, 'Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø«Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!');
        showQuizEncouragement(userName, 'ğŸ† Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø«Ø§Ù„ÙŠØ©! ÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©! Ø£Ù†Øª Ù†Ø¬Ù…! ğŸŒŸ', 'perfect');
    } else if (wrong === 1 && total >= 5) {
        // Ù…Ù…ØªØ§Ø²
        addBadgeForUser(userId, 'quiz-excellent', 'Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ø§Ù‹', 'silver', 'â­');
        addXPForUser(userId, 30, 'Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø² ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!');
        showQuizEncouragement(userName, 'â­ Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ø§Ù‹! Ø®Ø·Ø£ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·! Ø£Ù†Øª Ø±Ø§Ø¦Ø¹! ğŸ’ª', 'excellent');
    } else if (percentage >= 70) {
        // Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹
        addBadgeForUser(userId, 'quiz-good', 'Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯', 'bronze', 'ğŸ‘');
        addXPForUser(userId, 20, 'Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!');
        showQuizEncouragement(userName, 'ğŸ‘ Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù…! ğŸ“š', 'good');
    } else {
        // Ù…Ø´Ø§Ø±ÙƒØ©
        addBadgeForUser(userId, 'quiz-participant', 'Ù…Ø´Ø§Ø±Ùƒ Ù†Ø´Ø·', 'blue', 'ğŸ’™');
        addXPForUser(userId, 10, 'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©');
        showQuizEncouragement(userName, 'ğŸ’™ Ø´ÙƒØ±Ø§Ù‹ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ØªØ¹Ù„Ù…! ğŸ“–', 'participant');
    }
    
    // ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª
    trackQuizParticipation(userId, userName);
}

// ========== ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ==========
function trackQuizParticipation(userId, userName) {
    db.ref(`users/${userId}/quiz_count`).once('value', snapshot => {
        let quizCount = (snapshot.val() || 0) + 1;
        db.ref(`users/${userId}/quiz_count`).set(quizCount);
        
        // Ø´Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª
        const milestones = [
            { count: 5, id: 'quiz-5times', title: '5 Ù…Ø³Ø§Ø¨Ù‚Ø§Øª', icon: 'ğŸ“š', type: 'bronze', xp: 25 },
            { count: 10, id: 'quiz-10times', title: '10 Ù…Ø³Ø§Ø¨Ù‚Ø§Øª', icon: 'ğŸ“–', type: 'silver', xp: 50 },
            { count: 20, id: 'quiz-20times', title: '20 Ù…Ø³Ø§Ø¨Ù‚Ø©', icon: 'ğŸ“', type: 'gold', xp: 100 },
            { count: 50, id: 'quiz-50times', title: 'Ø¹Ø§Ù„Ù… Ø§Ù„ÙƒØªØ§Ø¨', icon: 'ğŸ‘¨â€ğŸ“', type: 'gold', xp: 200 }
        ];
        
        milestones.forEach(milestone => {
            if (quizCount === milestone.count) {
                addBadgeForUser(userId, milestone.id, milestone.title, milestone.type, milestone.icon);
                addXPForUser(userId, milestone.xp, `${milestone.count} Ù…Ø³Ø§Ø¨Ù‚Ø©!`);
                
                setTimeout(() => {
                    showQuizEncouragement(
                        userName, 
                        `${milestone.icon} Ù…Ø¨Ø±ÙˆÙƒ! Ø£ÙƒÙ…Ù„Øª ${milestone.count} Ù…Ø³Ø§Ø¨Ù‚Ø©! Ø£Ù†Øª Ø¹Ø§Ù„Ù… Ø­Ù‚ÙŠÙ‚ÙŠ ÙÙŠ Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ù‚Ø¯Ø³! ğŸ‰`, 
                        'milestone'
                    );
                }, 3000);
                
                if (typeof confetti !== 'undefined') {
                    setTimeout(() => {
                        confetti({
                            particleCount: 150,
                            spread: 80,
                            origin: { y: 0.6 }
                        });
                    }, 3000);
                }
            }
        });
    });
}

// ========== Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ´Ø¬ÙŠØ¹ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ==========
function showQuizEncouragement(userName, message, type) {
    const icons = {
        'perfect': 'ğŸ†',
        'excellent': 'â­',
        'good': 'ğŸ‘',
        'participant': 'ğŸ’™',
        'milestone': 'ğŸ‰'
    };
    
    const colors = {
        'perfect': 'linear-gradient(135deg, #fbbf24, #f59e0b)',
        'excellent': 'linear-gradient(135deg, #e5e7eb, #9ca3af)',
        'good': 'linear-gradient(135deg, #f59e0b, #d97706)',
        'participant': 'linear-gradient(135deg, #3b82f6, #2563eb)',
        'milestone': 'linear-gradient(135deg, #667eea, #764ba2)'
    };
    
    const encouragementHTML = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: ${colors[type] || colors.participant}; 
                    padding: 35px; border-radius: 30px; 
                    box-shadow: 0 20px 60px rgba(0,0,0,0.4); 
                    z-index: 10001; max-width: 90%; width: 400px;
                    animation: popupAppear 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);"
             id="quizEncouragementPopup">
            <div style="font-size: 64px; text-align: center; margin-bottom: 15px; animation: bounce 1s infinite;">
                ${icons[type] || 'ğŸ’™'}
            </div>
            <div style="font-size: 24px; font-weight: 900; color: white; text-align: center; margin-bottom: 15px; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                ${userName.split(' ')[0]}ØŒ Ø£Ø­Ø³Ù†Øª! ğŸ‰
            </div>
            <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); 
                        padding: 20px; border-radius: 20px; color: white; 
                        font-size: 16px; line-height: 1.8; margin: 15px 0; 
                        border: 2px solid rgba(255,255,255,0.2); text-align: center;">
                ${message}
            </div>
            <div style="color: rgba(255,255,255,0.9); font-size: 14px; text-align: center; margin-top: 15px;">
                "Ø§Ø¬Ù’ØªÙÙ‡ÙØ¯Ù’ Ø£ÙÙ†Ù’ ØªÙÙ‚ÙÙŠÙ…Ù Ù†ÙÙÙ’Ø³ÙÙƒÙ Ù„Ù„Ù‡Ù Ù…ÙØ²ÙÙƒÙ‹Ù‘Ù‰" - 2 ØªÙŠÙ…ÙˆØ«Ø§ÙˆØ³ 2: 15
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeQuizEncouragement()" 
                        style="background: rgba(255,255,255,0.3); color: white; border: none; 
                               padding: 12px 30px; border-radius: 30px; font-weight: 800; 
                               cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 15px; 
                               transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    Ø´ÙƒØ±Ø§Ù‹! ğŸ™
                </button>
            </div>
        </div>
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); 
                    backdrop-filter: blur(5px); z-index: 10000;" 
             id="quizEncouragementOverlay" 
             onclick="closeQuizEncouragement()"></div>
    `;
    
    // Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
    setTimeout(() => {
        document.body.insertAdjacentHTML('beforeend', encouragementHTML);
    }, 2000);
}

function closeQuizEncouragement() {
    const popup = document.getElementById('quizEncouragementPopup');
    const overlay = document.getElementById('quizEncouragementOverlay');
    if (popup) popup.remove();
    if (overlay) overlay.remove();
}

// ========== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø§Ø±Ø§Øª Ùˆ XP ==========
function addBadgeForUser(userId, badgeId, title, type, icon) {
    db.ref(`users/${userId}/badges/${badgeId}`).set({
        title: title,
        type: type,
        icon: icon,
        earnedAt: Date.now()
    });
}

function addXPForUser(userId, amount, reason) {
    db.ref(`users/${userId}/progress`).once('value', snapshot => {
        const data = snapshot.val() || { xp: 0, level: 1, xpForNextLevel: 100 };
        data.xp += amount;
        
        // ÙØ­Øµ Ø§Ù„Ø§Ø±ØªÙ‚Ø§Ø¡
        while (data.xp >= data.xpForNextLevel) {
            data.level++;
            data.xp -= data.xpForNextLevel;
            data.xpForNextLevel = Math.floor(data.xpForNextLevel * 1.5);
        }
        
        db.ref(`users/${userId}/progress`).set(data);
    });
}

function showFinishedStatus(score, max, finalPoints) {
    document.getElementById('quizSetup').style.display = 'none';
    document.getElementById('quizArea').style.display = 'none';
    document.getElementById('quizDone').style.display = 'block';
    if (score !== undefined) {
        const wrongCount = max - score;
        let pointsMsg = "";
        if (wrongCount === 0) pointsMsg = " - Ù…Ø¨Ø±ÙˆÙƒ! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 5 Ù†Ù‚Ø§Ø· ğŸ‰";
        else if (wrongCount === 1) pointsMsg = " - Ø¬ÙŠØ¯! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 4 Ù†Ù‚Ø§Ø· âœ¨";
        else pointsMsg = " - Ø´ÙƒØ±Ø§Ù‹ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 3 Ù†Ù‚Ø§Ø· ğŸ‘";
        document.getElementById('finalQuizScore').innerText = `Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${score} Ù…Ù† ${max}${pointsMsg}`;
    }
}

function updateCharCount(idx) {
    const area = document.getElementById(`quiz_ans_${idx}`);
    const counter = document.getElementById(`charCount_${idx}`);
    if (area && counter) counter.innerText = area.value.length;
}

// ===== CHAT =====
function sendChat() {
    const inp = document.getElementById('chatInput');
    const name = document.getElementById('userName').value || "Ù…Ø®Ø¯ÙˆÙ…";
    if (inp.value.trim()) { db.ref("chat").push({sender: name, text: inp.value}); inp.value = ""; }
}

// ===== PSYCHOLOGY =====
function setMood(el, m) {
    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active'); currentMood = m;
}

function sendMoodOnly() {
    db.ref("psychology/confessions").push({
        sender: document.getElementById('psyNameInput').value || "Ø§Ø¨Ù† Ø§Ù„Ø·Ø§Ø¹Ø©",
        mood: currentMood,
        need: document.getElementById('psyNeed').value,
        text: "ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ÙÙ‚Ø·",
        time: new Date().toLocaleString()
    });
    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­ â¤ï¸");
}

function sendPsyChat() {
    const inp = document.getElementById('psyChatInput');
    if (inp.value.trim()) {
        db.ref("psychology/private_chats/" + psySessionID).push({ sender: "Ø£Ù†Ø§", text: inp.value.trim() });
        inp.value = "";
    }
}

function clearPsyChat() {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) db.ref("psychology/private_chats/" + psySessionID).remove();
}

// ===== PRAYER SESSION (33) =====
function startPrayerSession() {
    document.getElementById('prayerTimer').style.display = 'block';
    pCount = 0; updatePrayerDisplay();
}

function countPrayer() {
    pCount++; updatePrayerDisplay();
    if (window.navigator.vibrate) window.navigator.vibrate(40);
    if (pCount >= 33) { alert("ØµÙ„Ø§Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø©! ğŸ™âœ¨"); document.getElementById('prayerTimer').style.display = 'none'; }
}

function updatePrayerDisplay() {
    document.getElementById('pCountText').innerText = pCount;
    document.getElementById('activePrayer').innerText = prayers[pCount % prayers.length];
}

// ===== QUESTION =====
function sendQuestion() {
    const txt = document.getElementById('quesMsg').value.trim();
    if (txt) {
        db.ref("psychology/questions").push({ sender: "Ù…Ø®Ø¯ÙˆÙ…", text: txt, time: new Date().toLocaleString() });
        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…"); document.getElementById('quesMsg').value = "";
    }
}

// ===== JIHAD BALANCE =====
function toggleJihadSection(isChecked) {
    const area = document.getElementById('jihadArea');
    const toggle = document.getElementById('jihadMasterToggle');
    if (isChecked) {
        let savedPin = localStorage.getItem('jihad_pin');
        if (!savedPin) {
            let newPin = prompt("Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø³Ø±ÙŠ Ø¬Ø¯ÙŠØ¯ Ù„Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø¬Ù‡Ø§Ø¯:");
            if (newPin && newPin.trim()) { localStorage.setItem('jihad_pin', newPin.trim()); area.style.display = 'block'; }
            else toggle.checked = false;
        } else {
            if (prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ:") === savedPin) area.style.display = 'block';
            else { alert("Ø®Ø·Ø£! âœ•"); toggle.checked = false; }
        }
    } else area.style.display = 'none';
}

function changeJihadPin() {
    if (prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:") === localStorage.getItem('jihad_pin')) {
        let n = prompt("Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
        if (n) localStorage.setItem('jihad_pin', n);
    }
}

function jihadCh(id, d) {
    let s = document.getElementById(id);
    let v = parseInt(s.innerText);
    if (v + d >= 0) s.innerText = v + d;
}

function jihadSave() {
    let ps = 0; 
    let ns = 0;
    
    // Get individual negative scores for analysis
    const negativeScores = {
        'Ø´ØªÙŠÙ…Ø©': parseInt(document.getElementById('jn1').innerText),
        'ÙƒØ°Ø¨': parseInt(document.getElementById('jn2').innerText),
        'ÙƒÙ„Ø§Ù… Ø±Ø¯ÙŠØ¡': parseInt(document.getElementById('jn3').innerText),
        'ØºØ¶Ø¨': parseInt(document.getElementById('jn4').innerText),
        'ÙÙƒØ± Ø³Ù„Ø¨ÙŠ': parseInt(document.getElementById('jn5').innerText)
    };
    
    document.querySelectorAll('.jihad-p-score').forEach(s => ps += parseInt(s.innerText));
    document.querySelectorAll('.jihad-n-score').forEach(s => ns += parseInt(s.innerText));
    
    let total = ps + ns;
    let pP = total === 0 ? 0 : Math.round((ps/total)*100);
    
    // Get history
    let h = JSON.parse(localStorage.getItem('spiritual_vFullDetail') || "[]");
    
    // Analyze improvement
    let improvementMsg = "";
    let encouragementMsg = "";
    let focusArea = "";
    
    // Find highest negative area to focus on
    let maxNegative = 0;
    let maxNegativeName = "";
    for (let key in negativeScores) {
        if (negativeScores[key] > maxNegative) {
            maxNegative = negativeScores[key];
            maxNegativeName = key;
        }
    }
    
    // Check if improving from yesterday
    if (h.length > 0) {
        const lastScore = h[0].p;
        const improvement = pP - lastScore;
        
        if (improvement > 0) {
            improvementMsg = `\nğŸ‰ Ø±Ø§Ø¦Ø¹! ØªØ­Ø³Ù†Øª ${improvement}% Ø¹Ù† Ø¢Ø®Ø± Ù…Ø±Ø©!`;
            encouragementMsg = "Ù…Ø§Ø´ÙŠ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„ØµØ­! Ø±Ø¨Ù†Ø§ Ù…Ø¹Ø§Ùƒ ÙˆÙØ±Ø­Ø§Ù† Ø¨ÙŠÙƒ â¤ï¸";
        } else if (improvement === 0) {
            improvementMsg = `\nğŸ“Š Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙƒØ¢Ø®Ø± Ù…Ø±Ø©`;
            encouragementMsg = "Ø®Ù„ÙŠÙ†Ø§ Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¨Ù‚Ù‰ Ø£Ø­Ø³Ù† ÙƒÙ„ ÙŠÙˆÙ… Ø´ÙˆÙŠØ© Ø´ÙˆÙŠØ© ğŸ’ª";
        } else {
            improvementMsg = `\nğŸ“‰ Ø§Ù†Ø®ÙØ¶Øª ${Math.abs(improvement)}% Ø¹Ù† Ø¢Ø®Ø± Ù…Ø±Ø©`;
            encouragementMsg = "Ù…Ø´ Ù…Ø´ÙƒÙ„Ø©! ÙƒÙ„Ù†Ø§ Ø¨Ù†ØºÙ„Ø·.. Ø§Ù„Ù…Ù‡Ù… Ù†Ù‚ÙˆÙ… ÙˆÙ†ÙƒÙ…Ù„ ğŸŒŸ";
        }
    }
    
    // Suggest focus area
    if (maxNegative > 0) {
        focusArea = `\n\nğŸ¯ Ø±ÙƒØ² Ø¹Ù„Ù‰: ${maxNegativeName} (${maxNegative} Ù…Ø±Ø©)\nØ­Ø§ÙˆÙ„ ØªÙ‚Ù„Ù„Ù‡Ø§ Ø£ÙƒØªØ± Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø¬Ø§ÙŠØ©!`;
    }
    
    // Save new record
    h.unshift({ 
        id: Date.now(), 
        date: new Date().toLocaleDateString('ar-EG'), 
        p: pP, 
        n: (100-pP),
        negatives: negativeScores
    });
    
    // Keep only last 7 days
    if (h.length > 7) {
        h = h.slice(0, 7);
    }
    
    localStorage.setItem('spiritual_vFullDetail', JSON.stringify(h));
    
    // Show detailed message
    alert(`âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸!\n\nğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${pP}% Ø¥ÙŠØ¬Ø§Ø¨ÙŠ${improvementMsg}\n\nğŸ’¬ ${encouragementMsg}${focusArea}`);
    
    // Update display without reloading
    jihadDisplay();
    
    // Reset scores to zero
    document.querySelectorAll('.jihad-p-score, .jihad-n-score').forEach(s => s.innerText = '0');
    
    // Show confetti
    if (typeof confetti !== 'undefined') {
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    }
}

function jihadPrepareLink(event, type) {
    event.preventDefault();
    let h = JSON.parse(localStorage.getItem('spiritual_vFullDetail') || "[]");
    if (h.length === 0) return alert("Ø³Ø¬Ù„ Ø£ÙˆÙ„Ø§Ù‹!");
    let msg = "Ù…Ù„Ø®Øµ Ø¬Ù‡Ø§Ø¯ÙŠ:\n" + h.slice(0,3).map(d => `${d.date}: ${d.p}% Ø¥ÙŠØ¬Ø§Ø¨ÙŠ`).join('\n');
    if (type === 'wa') window.open("https://wa.me/?text=" + encodeURIComponent(msg));
    else navigator.clipboard.writeText(msg).then(() => alert("Ù†Ø³Ø® âœ…"));
}

function jihadDel(id) {
    if (confirm("Ø­Ø°ÙØŸ")) {
        let h = JSON.parse(localStorage.getItem('spiritual_vFullDetail') || "[]").filter(x => x.id !== id);
        localStorage.setItem('spiritual_vFullDetail', JSON.stringify(h));
        jihadDisplay();
    }
}

function jihadDisplay() {
    let h = JSON.parse(localStorage.getItem('spiritual_vFullDetail') || "[]");
    const l = document.getElementById('jihadHList');
    
    if (!l) return;
    
    let html = `<div style="font-weight:700; margin-bottom:12px; color:var(--text-secondary); font-size:16px;">ğŸ“œ Ø³Ø¬Ù„ Ø¬Ù‡Ø§Ø¯Ùƒ Ø§Ù„Ø±ÙˆØ­ÙŠ (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</div>`;
    
    // Show improvement trend if there's data
    if (h.length >= 2) {
        const trend = h[0].p - h[1].p;
        let trendIcon = trend > 0 ? "ğŸ“ˆ" : trend < 0 ? "ğŸ“‰" : "â¡ï¸";
        let trendText = trend > 0 ? "Ø¨ØªØªØ­Ø³Ù†!" : trend < 0 ? "Ù…Ø­ØªØ§Ø¬ ØªØ±ÙƒÙŠØ² Ø£ÙƒØªØ±" : "Ø«Ø§Ø¨Øª";
        let trendColor = trend > 0 ? "var(--success)" : trend < 0 ? "var(--danger)" : "var(--warning)";
        
        html += `<div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); padding:12px; border-radius:12px; margin-bottom:12px; text-align:center;">
            <div style="font-size:24px; margin-bottom:6px;">${trendIcon}</div>
            <div style="font-weight:700; color:${trendColor}; font-size:15px;">${trendText}</div>
            <div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">
                ${trend > 0 ? `+${trend}` : trend}% Ø¹Ù† Ø¢Ø®Ø± Ù…Ø±Ø©
            </div>
        </div>`;
    }
    
    // Show each record with details
    h.forEach((x, index) => {
        let improvementBadge = "";
        if (index > 0 && h[index - 1]) {
            const diff = x.p - h[index - 1].p;
            if (diff > 0) improvementBadge = `<span style="color:var(--success); font-size:11px; margin-right:8px;">â†‘ +${diff}%</span>`;
            else if (diff < 0) improvementBadge = `<span style="color:var(--danger); font-size:11px; margin-right:8px;">â†“ ${diff}%</span>`;
        }
        
        // Find focus area for this day
        let focusNote = "";
        if (x.negatives) {
            let maxNeg = 0;
            let maxNegName = "";
            for (let key in x.negatives) {
                if (x.negatives[key] > maxNeg) {
                    maxNeg = x.negatives[key];
                    maxNegName = key;
                }
            }
            if (maxNeg > 0) {
                focusNote = `<div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">ğŸ¯ Ø±ÙƒØ² Ø¹Ù„Ù‰: ${maxNegName}</div>`;
            }
        }
        
        html += `<div class="jihad-history-item" style="position:relative;">
            <div>
                <strong>${x.date}</strong>: 
                <span style="color:var(--success); font-weight:700;">${x.p}% Ø¥ÙŠØ¬Ø§Ø¨ÙŠ</span>
                ${improvementBadge}
                ${focusNote}
            </div>
            <button class="jihad-del-btn" onclick="jihadDel(${x.id})">ğŸ—‘ï¸</button>
        </div>`;
    });
    
    l.innerHTML = html;
}

function jihadShowResults() {
    const resultsDiv = document.getElementById('jihadHList');
    if (resultsDiv.style.display === 'none') {
        resultsDiv.style.display = 'block';
        jihadDisplay();
    } else {
        resultsDiv.style.display = 'none';
    }
}

// ===== ATTENDANCE =====
// ========== Ù†Ø¸Ø§Ù… Ù…Ù†Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªÙƒØ±Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ ==========
// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ØµÙ…Ø© ÙØ±ÙŠØ¯Ø© Ù„Ù„Ø¬Ù‡Ø§Ø² (Ù„Ø§ ØªØªØºÙŠØ± Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ù…Ø³Ø­ Ø§Ù„Ù…ØªØµÙØ­)
function getDeviceFingerprintForAttendance() {
    const navigatorInfo = [
        navigator.userAgent,
        navigator.language,
        navigator.platform,
        screen.width,
        screen.height,
        screen.colorDepth,
        new Date().getTimezoneOffset(),
        navigator.hardwareConcurrency || 'unknown',
        navigator.deviceMemory || 'unknown'
    ].join('###');
    
    let hash = 0;
    for (let i = 0; i < navigatorInfo.length; i++) {
        const char = navigatorInfo.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    
    return 'device_' + Math.abs(hash).toString(36);
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙÙŠ Firebase
async function checkDailyAttendanceLimit(type, name) {
    const deviceId = getDeviceFingerprintForAttendance();
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    
    return new Promise((resolve) => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙŠÙˆÙ…
        db.ref('daily_attendance_locks/' + type + '/' + today)
            .orderByChild('name')
            .equalTo(name)
            .once('value', nameSnapshot => {
                if (nameSnapshot.exists()) {
                    // Ø§Ù„Ø§Ø³Ù… Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…
                    resolve({ 
                        blocked: true, 
                        reason: `Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª Ø­Ø¶ÙˆØ± ${type} Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø§Ø³Ù… "${name}"!` 
                    });
                } else {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
                    db.ref('daily_attendance_locks/' + type + '/' + today)
                        .orderByChild('deviceId')
                        .equalTo(deviceId)
                        .once('value', deviceSnapshot => {
                            if (deviceSnapshot.exists()) {
                                // Ø§Ù„Ø¬Ù‡Ø§Ø² Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…
                                let registeredName = '';
                                deviceSnapshot.forEach(child => {
                                    registeredName = child.val().name;
                                });
                                resolve({ 
                                    blocked: true, 
                                    reason: `Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø§Ø³Ù… "${registeredName}"!\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ø´Ø®Øµ Ø¢Ø®Ø±.` 
                                });
                            } else {
                                // Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - Ù…Ø³Ù…ÙˆØ­
                                resolve({ blocked: false });
                            }
                        });
                }
            });
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠ Firebase
async function recordDailyAttendance(type, name) {
    const deviceId = getDeviceFingerprintForAttendance();
    const today = new Date().toISOString().split('T')[0];
    const timestamp = Date.now();
    
    const recordData = {
        name: name,
        deviceId: deviceId,
        timestamp: timestamp,
        datetime: new Date().toISOString()
    };
    
    return db.ref('daily_attendance_locks/' + type + '/' + today).push(recordData);
}

async function submitAttendance(type, inputId) {
    const name = document.getElementById('attendanceNameSelect').value;
    const day = document.getElementById(inputId).value.trim();
    const today = new Date().toLocaleDateString();

    if (!name) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹!");
    if (!day) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ ÙŠÙˆÙ… Ø¥ÙŠÙ‡!");

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase
    const limitCheck = await checkDailyAttendanceLimit(type, name);
    if (limitCheck.blocked) {
        return alert(limitCheck.reason);
    }

    // Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Firebase Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù‚ÙˆÙŠØ©)
    await recordDailyAttendance(type, name);

    db.ref("points_data").once("value", snap => {
        snap.forEach(child => {
            if (child.val().name === name) {
                const currentScore = child.val().score || 0;
                const currentBreakdown = child.val().breakdown || {};
                
                // Update breakdown in Firebase
                const newBreakdown = {
                    quiz: currentBreakdown.quiz || 0,
                    prayer: currentBreakdown.prayer || 0,
                    attendance: (currentBreakdown.attendance || 0) + 5
                };
                
                child.ref.update({ 
                    score: currentScore + 5,
                    breakdown: newBreakdown
                });
            }
        });
    });

    db.ref("attendance_logs").push({ makhdom: name, type, day, submittedAt: new Date().toLocaleString() });
    
    // Ø§Ù„Ù€ localStorage Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙ‚Ø·
    const lockKey = `lock_${type}_${name}_${today}`;
    localStorage.setItem(lockKey, "true");
    
    alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù¥ Ø¯Ø±Ø¬Ø§Øª Ø­Ø¶ÙˆØ± ${type} Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
    document.getElementById(inputId).value = "";
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
}

// ===== SESSION CHECK ON LOAD =====
window.addEventListener('DOMContentLoaded', function() {
    // Restore theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.setAttribute('data-theme','dark');
        document.getElementById('themeBtn').innerText = "ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†";
    }

    const lastLogin = localStorage.getItem('session_login_time');
    const loginType = localStorage.getItem('session_login_type');

    if (lastLogin) {
        const timePassed = Date.now() - parseInt(lastLogin);
        const hours24 = 24 * 60 * 60 * 1000;
        if (timePassed < hours24) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            if (loginType === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminData();
            }
            startApp();
            showRandomVerse();
            // jihadDisplay removed - will show only when button clicked
        } else {
            localStorage.removeItem('session_login_time');
            localStorage.removeItem('session_login_type');
        }
    }
});

// ===== TOGGLE CARD VIEW =====
function toggleCardView(cardElement) {
    cardElement.classList.toggle('expanded');
}

// ===== Ù†Ø¸Ø§Ù… Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ´Ø¬ÙŠØ¹ =====

function checkEncouragementMessages() {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    const userName = localStorage.getItem('selected_user_name');
    console.log('ğŸ” Checking messages for:', userName);
    if (!userName) {
        console.log('âŒ No user name found');
        return;
    }
    
    db.ref("encouragement_messages").orderByChild("to").equalTo(userName)
        .once("value", snap => {
            const unreadMessages = [];
            snap.forEach(child => {
                const msg = child.val();
                console.log('ğŸ“¨ Found message:', msg);
                if (!msg.read) {
                    unreadMessages.push({
                        id: child.key,
                        ...msg
                    });
                }
            });
            
            console.log('ğŸ“¬ Total unread messages:', unreadMessages.length);
            
            if (unreadMessages.length > 0) {
                showEncouragementBadge(unreadMessages.length);
                // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø·
                showEncouragementPopup(unreadMessages[0]);
            } else {
                console.log('âœ… No unread messages');
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø¯Ø¬ Ù„Ùˆ Ù…ÙÙŠØ´ Ø±Ø³Ø§Ø¦Ù„
                const badge = document.getElementById('encouragementBadge');
                if (badge) badge.style.display = 'none';
            }
        });
}

// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
function showNextEncouragementMessage() {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    const userName = localStorage.getItem('selected_user_name');
    if (!userName) return;
    
    db.ref("encouragement_messages").orderByChild("to").equalTo(userName)
        .once("value", snap => {
            const unreadMessages = [];
            snap.forEach(child => {
                const msg = child.val();
                if (!msg.read) {
                    unreadMessages.push({
                        id: child.key,
                        ...msg
                    });
                }
            });
            
            if (unreadMessages.length > 0) {
                showEncouragementBadge(unreadMessages.length);
                showEncouragementPopup(unreadMessages[0]);
            } else {
                // Ù…ÙÙŠØ´ Ø±Ø³Ø§Ø¦Ù„ ØªØ§Ù†ÙŠØ© - Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø¯Ø¬
                const badge = document.getElementById('encouragementBadge');
                if (badge) badge.style.display = 'none';
            }
        });
}

function showEncouragementBadge(count) {
    let badge = document.getElementById('encouragementBadge');
    if (!badge) {
        badge = document.createElement('div');
        badge.id = 'encouragementBadge';
        badge.className = 'encouragement-badge';
        badge.onclick = () => {
            // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø¯Ø¬ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
            showNextEncouragementMessage();
        };
        document.body.appendChild(badge);
    }
    badge.innerHTML = `<div style="font-size:20px; margin-bottom:2px;">ğŸ’Œ</div><div style="font-size:12px;">${count} ${count === 1 ? 'Ø±Ø³Ø§Ù„Ø©' : 'Ø±Ø³Ø§Ø¦Ù„'}</div>`;
    badge.style.display = 'block';
    badge.title = 'Ø§Ø¶ØºØ· Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„';
}

function showEncouragementPopup(message) {
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù†Ø§ÙØ°Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
    const existingPopup = document.querySelector('.encouragement-popup');
    if (existingPopup) existingPopup.remove();
    
    const popup = document.createElement('div');
    popup.className = 'encouragement-popup';
    popup.innerHTML = `
        <button class="close-btn" onclick="closeEncouragementPopup('${message.id}')">âœ•</button>
        <div style="font-size:48px; text-align:center; margin-bottom:10px;">ğŸ’™</div>
        <div style="font-size:22px; font-weight:900; color:white; text-align:center; margin-bottom:15px;">
            Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø®Ø¯Ø§Ù…
        </div>
        <div class="message-content">${message.message.replace(/\n/g, '<br>')}</div>
        <div class="from-tag">ğŸ’ Ù…Ù†: ${message.from}</div>
        <div style="text-align:center; margin-top:15px;">
            <button onclick="closeEncouragementPopup('${message.id}')" style="background:rgba(255,255,255,0.25); color:white; border:none; padding:10px 25px; border-radius:25px; font-weight:700; cursor:pointer; font-family:'Cairo',sans-serif; font-size:14px; transition:0.3s;">
                ØªÙ…Ø§Ù…ØŒ Ø´ÙƒØ±Ù‹Ø§! ğŸ™
            </button>
        </div>
    `;
    document.body.appendChild(popup);
    
    // ØªØ´ØºÙŠÙ„ ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø·ÙŠÙ
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch(e) {
        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø·Ø£ Ù„Ùˆ Ø§Ù„ØµÙˆØª Ù…Ø´ Ù…Ø¯Ø¹ÙˆÙ…
    }
    
    // ØªØ´ØºÙŠÙ„ ÙƒÙˆÙ†ÙÙŠØªÙŠ
    if (typeof confetti !== 'undefined') {
        confetti({ particleCount: 80, spread: 60, origin: { y: 0.4 } });
    }
}

function closeEncouragementPopup(messageId) {
    const popup = document.querySelector('.encouragement-popup');
    if (popup) {
        popup.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            popup.remove();
            // Ø¹Ù„Ù‘Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
            markMessageAsRead(messageId);
            // Ø§Ø³ØªÙ†Ù‰ Ù†Øµ Ø«Ø§Ù†ÙŠØ© ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
            setTimeout(() => {
                showNextEncouragementMessage();
            }, 500);
        }, 300);
    }
}

function markMessageAsRead(messageId) {
    db.ref(`encouragement_messages/${messageId}`).update({ read: true });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬
    const userName = localStorage.getItem('selected_user_name');
    if (!userName) return;
    
    db.ref("encouragement_messages").orderByChild("to").equalTo(userName)
        .once("value", snap => {
            let unreadCount = 0;
            snap.forEach(child => {
                if (!child.val().read) unreadCount++;
            });
            
            const badge = document.getElementById('encouragementBadge');
            if (unreadCount === 0) {
                if (badge) badge.style.display = 'none';
            } else {
                showEncouragementBadge(unreadCount);
            }
        });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù…
function confirmNameSelection() {
    const nameSelect = document.getElementById('nameSelect');
    const selectedName = nameSelect?.value;
    
    if (!selectedName) {
        alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹!');
        return;
    }
    
    // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    currentUserName = selectedName;
    currentUserId = getUserId(selectedName);
    
    // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…
    localStorage.setItem('selected_user_name', selectedName);
    localStorage.setItem('user_id', currentUserId);
    
    // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù…
    document.getElementById('nameSelectionSection').style.display = 'none';
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
    showWelcomeMessage(selectedName);
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
    displayUserNameInHeader(selectedName);
    
    // ÙƒÙˆÙ†ÙÙŠØªÙŠ Ø§Ø­ØªÙØ§Ù„ÙŠ
    if (typeof confetti !== 'undefined') {
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ´Ø¬ÙŠØ¹ Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
    setTimeout(checkEncouragementMessages, 2000);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
function showWelcomeMessage(name) {
    const welcomeSection = document.getElementById('welcomeMessageSection');
    const welcomeText = document.getElementById('welcomeText');
    
    if (welcomeSection && welcomeText) {
        welcomeText.innerHTML = `Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ ${name}! ğŸ‰`;
        welcomeSection.style.display = 'block';
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            welcomeSection.style.animation = 'fadeOutUp 0.8s ease';
            setTimeout(() => {
                welcomeSection.style.display = 'none';
                welcomeSection.style.animation = 'slideDown 0.8s ease'; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø£ØµÙ„ÙŠ
            }, 800);
        }, 10000);
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¨Ø´ÙƒÙ„ Ù…ØªØ­Ø±Ùƒ
function displayUserNameInHeader(name) {
    const userNameDisplay = document.getElementById('userNameDisplay');
    if (userNameDisplay) {
        userNameDisplay.innerHTML = `ğŸ‘¤ ${name}`;
        userNameDisplay.style.display = 'block';
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¸Ù‡ÙˆØ±
        userNameDisplay.style.animation = 'slideInRight 0.8s ease, wave 2s ease-in-out 0.8s infinite';
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠØ­Ø¯Ø« ÙÙ‚Ø· Ø¹Ù†Ø¯ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØµÙØ­)
function changeUserName() {
    // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
    document.getElementById('welcomeMessageSection').style.display = 'none';
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
    document.getElementById('userNameDisplay').style.display = 'none';
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù…
    document.getElementById('nameSelectionSection').style.display = 'block';
    
    // Ù…Ø³Ø­ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸
    localStorage.removeItem('selected_user_name');
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù…
const nameSelectElement = document.getElementById('nameSelect');
if (nameSelectElement) {
    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    const savedName = localStorage.getItem('selected_user_name');
    const savedId = localStorage.getItem('user_id');
    
    if (savedName && savedId) {
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        currentUserName = savedName;
        currentUserId = savedId;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù… Ù…Ø­ÙÙˆØ¸ØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù…Ø¨Ø§Ø´Ø±Ø©
        setTimeout(() => {
            showWelcomeMessage(savedName);
            displayUserNameInHeader(savedName);
            checkEncouragementMessages();
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            initializeNewFeatures();
        }, 1000);
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø§Ø³Ù… Ù…Ø­ÙÙˆØ¸ØŒ Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        document.getElementById('nameSelectionSection').style.display = 'block';
    }
}

// ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ==========

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function initializeNewFeatures() {
    // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø±Ø§Øª ÙÙ‚Ø·
    setTimeout(() => {
        document.getElementById('badgesSection').style.display = 'block';
    }, 800);
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    loadUserBadges();
}

// ØªØ­Ù…ÙŠÙ„ Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function loadUserBadges() {
    const savedBadges = JSON.parse(localStorage.getItem('userBadges') || '[]');
    const container = document.getElementById('userBadgesContainer');
    const section = document.getElementById('badgesSection');
    
    if (savedBadges.length === 0) {
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ùˆ Ù…ÙÙŠØ´ Ø´Ø§Ø±Ø§Øª
        section.style.display = 'none';
    } else {
        section.style.display = 'block';
        container.innerHTML = '';
        savedBadges.forEach(badge => {
            const badgeEl = document.createElement('div');
            badgeEl.className = `achievement-badge badge-${badge.type}`;
            badgeEl.innerHTML = `${badge.icon} ${badge.title}`;
            badgeEl.title = badge.description || badge.title;
            container.appendChild(badgeEl);
        });
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©
function addBadge(id, title, type, icon = 'ğŸ†', description = '') {
    const savedBadges = JSON.parse(localStorage.getItem('userBadges') || '[]');
    
    // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø´Ø§Ø±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„
    if (savedBadges.some(b => b.id === id)) {
        return;
    }
    
    const newBadge = { id, title, type, icon, description };
    savedBadges.push(newBadge);
    localStorage.setItem('userBadges', JSON.stringify(savedBadges));
    
    loadUserBadges();
    showNotification(`${icon} Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø´Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${title}!`);
}




// Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± ØªÙØ§Ø¹Ù„ÙŠ
function showNotification(message) {
    const notification = document.getElementById('interactiveNotification');
    const notificationText = document.getElementById('notificationText');
    
    notificationText.textContent = message;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.5s ease';
        setTimeout(() => {
            notification.style.display = 'none';
            notification.style.animation = 'notificationSlide 0.5s ease, notificationBounce 2s ease-in-out infinite';
        }, 500);
    }, 3000);
}

// Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ø±Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù…
function initializeDefaultBadges() {
    const savedBadges = JSON.parse(localStorage.getItem('userBadges') || '[]');
    
    if (savedBadges.length === 0) {
        // Ø´Ø§Ø±Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
        addBadge('welcome', 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ', 'blue', 'ğŸ‘‹', 'Ø§Ù†Ø¶Ù…Ù…Øª Ù„Ø®Ø¯Ù…Ø© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ');
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© confirmNameSelection Ù„ØªØ´Ù…Ù„ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
const originalConfirmNameSelection = confirmNameSelection;
confirmNameSelection = function() {
    originalConfirmNameSelection();
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    setTimeout(() => {
        initializeNewFeatures();
        initializeDefaultBadges();
    }, 1500);
};

</script>
</body>
</html>
