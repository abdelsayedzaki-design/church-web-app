
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  üîí ŸÜÿ∏ÿßŸÖ ÿ≠ŸÖÿßŸäÿ© ŸÖÿ≠ÿØŸëÿ´ ÿ∂ÿØ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ŸÖŸÜ ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÖÿ™ÿπÿØÿØÿ© üîí              ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                                   ‚ïë
‚ïë  ‚úÖ ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑÿ™ÿßŸÑŸäÿ©:                                    ‚ïë
‚ïë  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚ïë
‚ïë                                                                   ‚ïë
‚ïë  1Ô∏è‚É£  ŸÖÿ∞ÿ®ÿ≠ ÿßŸÑÿµŸÑÿßÿ© (sendMutualPrayer):                            ‚ïë
‚ïë     ‚Ä¢ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firebase ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ                            ‚ïë
‚ïë     ‚Ä¢ ÿ≠ŸÅÿ∏ ÿ¢ÿÆÿ± ÿ™ÿßÿ±ŸäÿÆ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÅŸä users/{userId}/last_prayer_submit_date ‚ïë
‚ïë     ‚Ä¢ ÿ•ÿ∂ÿßŸÅÿ© submitDate Ÿà userId ŸÑŸÉŸÑ ÿ™ŸÇÿ±Ÿäÿ±                       ‚ïë
‚ïë     ‚Ä¢ ŸÖŸÜÿπ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ± ŸÖŸÜ ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÖÿÆÿ™ŸÑŸÅÿ© ‚úì                     ‚ïë
‚ïë                                                                   ‚ïë
‚ïë  2Ô∏è‚É£  ÿ≠ÿ∂Ÿàÿ± ÿßŸÑÿÆÿØŸÖÿ© ŸàÿßŸÑŸÇÿØÿßÿ≥ (submitAttendance):                    ‚ïë
‚ïë     ‚Ä¢ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÉÿßŸÜ Ÿäÿ≥ÿ™ÿÆÿØŸÖ Firebase ÿ®ÿßŸÑŸÅÿπŸÑ ‚úì                       ‚ïë
‚ïë     ‚Ä¢ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© userId Ÿà submitDate ŸÑŸÑÿ™Ÿàÿ´ŸäŸÇ                      ‚ïë
‚ïë     ‚Ä¢ ÿßŸÑÿ≠ŸÖÿßŸäÿ© ŸÖŸàÿ¨ŸàÿØÿ© ŸÖŸÜ ÿÆŸÑÿßŸÑ checkDailyAttendanceLimit ‚úì         ‚ïë
‚ïë                                                                   ‚ïë
‚ïë  3Ô∏è‚É£  ŸÖÿ≥ÿßÿ®ŸÇÿ© ÿßŸÑŸÉÿ™ÿßÿ® ÿßŸÑŸÖŸÇÿØÿ≥ (saveQuizSubmission):                 ‚ïë
‚ïë     ‚Ä¢ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÉÿßŸÜ Ÿäÿ≥ÿ™ÿÆÿØŸÖ Firebase ÿ®ÿßŸÑŸÅÿπŸÑ ‚úì                       ‚ïë
‚ïë     ‚Ä¢ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© submitDate ŸÑŸÑÿ™Ÿàÿ´ŸäŸÇ                               ‚ïë
‚ïë     ‚Ä¢ ÿßŸÑÿ≠ŸÖÿßŸäÿ© ŸÖŸàÿ¨ŸàÿØÿ© ŸÖŸÜ ÿÆŸÑÿßŸÑ quiz_submissions/{quizId}/{userId} ‚úì  ‚ïë
‚ïë                                                                   ‚ïë
‚ïë  üìå ÿßŸÑÿ¢ŸÜ ŸÉŸÑ ÿßŸÑÿ£ŸÜÿ∏ŸÖÿ© ŸÖÿ≠ŸÖŸäÿ© ŸÖŸÜ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ÿπÿ®ÿ±:                       ‚ïë
‚ïë     ‚Ä¢ Firebase (ÿßŸÑÿ≠ŸÖÿßŸäÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©)                               ‚ïë
‚ïë     ‚Ä¢ localStorage (ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©)                              ‚ïë
‚ïë     ‚Ä¢ ŸÖÿπÿ±ŸÅÿßÿ™ ŸÅÿ±ŸäÿØÿ© ŸÑŸÉŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ (userId)                          ‚ïë
‚ïë     ‚Ä¢ ÿ™Ÿàÿßÿ±ŸäÿÆ ÿ•ÿ±ÿ≥ÿßŸÑ Ÿàÿßÿ∂ÿ≠ÿ© (submitDate)                           ‚ïë
‚ïë                                                                   ‚ïë
‚ïë  üéØ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©: ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÜŸÅÿ≥ ÿßŸÑÿ¥Ÿäÿ° ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ŸÖÿ±ÿ© ŸÅŸä ÿßŸÑŸäŸàŸÖ       ‚ïë
‚ïë             ÿ≠ÿ™Ÿâ ŸÖŸÜ ÿ£ÿ¨Ÿáÿ≤ÿ© ÿ£Ÿà ŸÖÿ™ÿµŸÅÿ≠ÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ©! üõ°Ô∏è                   ‚ïë
‚ïë                                                                   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿÆÿØŸÖÿ© ÿ•ÿπÿØÿßÿØŸä</title>
    
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2904/2904979.png">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');

        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: #f8f9ff;
            --bg-card: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --accent-1: #667eea;
            --accent-2: #f093fb;
            --accent-3: #4facfe;
            --success: #48bb78;
            --warning: #ecc94b;
            --danger: #f56565;
            --shadow-sm: 0 2px 8px rgba(102,126,234,0.1);
            --shadow-md: 0 4px 16px rgba(102,126,234,0.15);
            --shadow-lg: 0 8px 32px rgba(102,126,234,0.2);
        }

        [data-theme="dark"] {
            --bg-secondary: #1a202c;
            --bg-card: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #cbd5e0;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Cairo', 'Segoe UI', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* ===== LOGIN ===== */
        #loginScreen {
            position: fixed; inset: 0;
            background: var(--bg-primary);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
            animation: fadeIn 0.5s ease;
        }
        .login-box {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 40px 30px;
            border-radius: 30px;
            text-align: center;
            width: 90%; max-width: 380px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.6s ease;
        }
        .login-box h3 {
            font-size: 26px; font-weight: 800;
            background: var(--bg-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
        }
        .login-icon { font-size: 56px; margin-bottom: 16px; animation: bounce 2s infinite; }
        .login-box p { color: #718096; font-size: 14px; margin-bottom: 22px; }

        /* ===== ŸÇÿ≥ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ≤ŸÖŸÑÿßÿ° ŸÑŸÑÿ™ÿ£ŸÉŸäÿØ ===== */
        .peer-confirmation-section {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid var(--accent-1);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.6);
            }
        }

        .peer-confirmation-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .peer-confirmation-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-1);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .peer-confirmation-header p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .peers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .peer-card {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .peer-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .peer-card.selected {
            border-color: var(--success);
            background: linear-gradient(135deg, #48bb7815 0%, #48bb7825 100%);
        }

        .peer-card .peer-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto 8px;
        }

        .peer-card.selected .peer-avatar {
            animation: bounceAvatar 0.5s ease;
        }

        @keyframes bounceAvatar {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .peer-card .peer-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .peer-card .peer-status {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .peer-card .check-icon {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 24px;
            height: 24px;
            background: var(--success);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            animation: popIn 0.3s ease;
        }

        .peer-card.selected .check-icon {
            display: flex;
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .confirm-peers-btn {
            width: 100%;
            padding: 14px;
            background: var(--bg-primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
        }

        .confirm-peers-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .confirm-peers-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* ŸÇÿ≥ŸÖ ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸàÿßÿ±ÿØÿ© */
        .pending-confirmations-section {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow-md);
        }

        /* ===== ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ© ÿßŸÑÿ´ÿßÿ®ÿ™ ===== */
        #persistentNotificationsContainer {
            position: fixed;
            top: 70px;
            left: 10px;
            right: 10px;
            max-width: 400px;
            margin: 0 auto;
            z-index: 9998;
            pointer-events: none;
        }

        .persistent-notification-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 10px;
            box-shadow: 0 8px 24px rgba(255, 107, 107, 0.4);
            animation: slideInBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: all;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .persistent-notification-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(255, 107, 107, 0.5);
        }

        @keyframes slideInBounce {
            0% {
                transform: translateY(-100px);
                opacity: 0;
            }
            60% {
                transform: translateY(10px);
                opacity: 1;
            }
            80% {
                transform: translateY(-5px);
            }
            100% {
                transform: translateY(0);
            }
        }

        .persistent-notification-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .persistent-notification-title {
            font-size: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pulse-icon {
            animation: pulseIcon 1.5s ease-in-out infinite;
        }

        @keyframes pulseIcon {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        .persistent-notification-body {
            font-size: 13px;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .persistent-notification-sender {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .persistent-notification-actions {
            display: flex;
            gap: 8px;
        }

        .persistent-notif-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .persistent-notif-accept {
            background: white;
            color: #48bb78;
        }

        .persistent-notif-accept:hover {
            background: #f0fdf4;
            transform: scale(1.05);
        }

        .persistent-notif-reject {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .persistent-notif-reject:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .pending-confirmations-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .pending-confirmations-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .pending-count {
            background: var(--danger);
            color: white;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .confirmation-request-card {
            background: linear-gradient(135deg, #f093fb15 0%, #4facfe15 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .confirmation-request-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .requester-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--bg-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .requester-info {
            flex: 1;
        }

        .requester-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .request-time {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .confirmation-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 12px;
        }

        .confirm-btn, .reject-btn {
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
        }

        .confirm-btn {
            background: var(--success);
            color: white;
        }

        .reject-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .confirm-btn:hover, .reject-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* ===== MAIN ===== */
        #mainContent { display: none; animation: fadeIn 0.5s ease; padding-bottom: 30px; }

        .theme-toggle-btn {
            position: fixed; top: 16px; left: 16px;
            background: var(--bg-card); color: var(--text-primary);
            border: none; padding: 10px 18px; border-radius: 50px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            box-shadow: var(--shadow-md); z-index: 100;
            transition: all 0.3s ease; font-family: 'Cairo', sans-serif;
        }
        .theme-toggle-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        /* ===== HEADER ===== */
        .main-header {
            background: var(--bg-primary);
            padding: 34px 20px 44px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative; overflow: hidden;
        }
        .main-header::before {
            content:'';
            position: absolute; inset: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="rgba(255,255,255,0.05)"/></svg>');
            animation: float 20s infinite linear;
        }
        .main-header h2 {
            color: white; font-size: 30px; font-weight: 800;
            margin-bottom: 6px; position: relative;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: titleGlow 3s ease-in-out infinite;
        }
        
        @keyframes titleGlow {
            0%, 100% {
                text-shadow: 0 2px 10px rgba(0,0,0,0.2),
                            0 0 20px rgba(255,255,255,0.3);
                transform: scale(1);
            }
            50% {
                text-shadow: 0 2px 10px rgba(0,0,0,0.2),
                            0 0 30px rgba(255,255,255,0.6),
                            0 0 40px rgba(255,255,255,0.4);
                transform: scale(1.02);
            }
        }
        
        .animated-title {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        
        .animated-title span {
            display: inline-block;
        }
        
        /* ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑŸÉŸÜŸäÿ≥ÿ© - ÿ´ÿßÿ®ÿ™ÿ© ŸÖÿπ ÿ™ŸàŸáÿ¨ ÿÆŸÅŸäŸÅ */
        .animated-title .word-1 {
            font-size: 36px;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
        }
        
        /* ŸÉŸÑŸÖÿ© "ÿÆÿØŸÖÿ©" - ŸÖŸàÿ¨ÿ© ŸÖÿπ ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿ¨ŸÖ */
        .animated-title .word-2 {
            animation: waveText 3s ease-in-out infinite;
            transform-origin: center;
        }
        
        @keyframes waveText {
            0%, 100% {
                transform: translateY(0) scale(1);
                letter-spacing: 0px;
            }
            33% {
                transform: translateY(-8px) scale(1.08);
                letter-spacing: 2px;
            }
            66% {
                transform: translateY(4px) scale(0.95);
                letter-spacing: -1px;
            }
        }
        
        /* ŸÉŸÑŸÖÿ© "ÿ•ÿπÿØÿßÿØŸä" - ÿ™ÿ£ÿ´Ÿäÿ± ŸÇŸàÿ≥ ŸÇÿ≤ÿ≠ ŸÖÿ™ÿ≠ÿ±ŸÉ ŸÖÿπ ŸÜÿ®ÿ∂ */
        .animated-title .word-3 {
            background: linear-gradient(90deg, 
                #fff 0%, 
                #fbbf24 25%, 
                #f093fb 50%, 
                #4facfe 75%, 
                #fff 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 300% 100%;
            animation: rainbowSlide 4s linear infinite, pulseBig 2s ease-in-out infinite;
            font-weight: 900;
        }
        
        @keyframes rainbowSlide {
            0% {
                background-position: 0% 50%;
            }
            100% {
                background-position: 300% 50%;
            }
        }
        
        @keyframes pulseBig {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 5px rgba(251,191,36,0.3));
            }
            50% {
                transform: scale(1.12);
                filter: drop-shadow(0 0 15px rgba(251,191,36,0.8));
            }
        }
        
        /* ÿßÿ≥ŸÖ ÿßŸÑŸÉŸÜŸäÿ≥ÿ© - ÿ™ÿ£ÿ´Ÿäÿ± ŸÉÿ™ÿßÿ®ÿ© + ÿ™ŸÑÿßÿ¥Ÿä */
        .main-header small { 
            color: rgba(255,255,255,0.88); 
            font-size: 13px; 
            position: relative;
            display: inline-block;
            animation: typewriter 8s steps(40) infinite, fadeInOut 8s ease-in-out infinite;
            overflow: hidden;
            white-space: nowrap;
            border-left: 2px solid rgba(255,255,255,0.7);
            padding-left: 8px;
        }
        
        @keyframes typewriter {
            0%, 10% {
                width: 0;
            }
            50%, 90% {
                width: 100%;
            }
            100% {
                width: 0;
            }
        }
        
        @keyframes fadeInOut {
            0%, 10% {
                opacity: 0;
            }
            20%, 80% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        /* ===== VERSE ===== */
        .verse-container {
            background: var(--bg-primary);
            margin: -28px 15px 20px;
            padding: 24px; border-radius: 24px;
            box-shadow: var(--shadow-lg);
            position: relative; overflow: hidden;
            animation: slideUp 0.6s ease;
        }
        .verse-container::before {
            content:'‚úù'; position: absolute;
            top: 8px; right: 18px;
            font-size: 90px; opacity: 0.1; color: white;
        }
        .verse-text { font-size: 17px; font-weight: 600; color: white; line-height: 1.8; margin-bottom: 10px; position: relative; }
        .verse-ref { font-size: 13px; color: rgba(255,255,255,0.8); font-weight: 600; position: relative; }

        /* ===== CONTAINER ===== */
        .container { padding: 0 15px; }

        /* ===== ADMIN ALERT ===== */
        #adminAlert {
            display: none;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white; padding: 18px; border-radius: 18px;
            margin: 18px 15px; box-shadow: var(--shadow-md);
            animation: shake 0.5s ease, pulse 2s infinite;
        }
        #adminAlert b { display: block; font-size: 17px; margin-bottom: 6px; }

        /* ===== SECTIONS ===== */
        .section {
            background: var(--bg-card);
            padding: 20px; border-radius: 22px;
            margin: 14px 0; box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            animation: slideUp 0.6s ease;
        }
        .section:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        .section-title {
            font-size: 19px; font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 14px;
            display: flex; align-items: center; gap: 10px;
        }
        .section-title .emoji { font-size: 22px; }

        /* ===== GRID / LEADERBOARD ===== */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: 10px; margin-top: 12px;
        }
        .card {
            background: #0f172a;
            padding: 10px; border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.3s ease;
        }
        .card:hover { 
            transform: translateY(-3px); 
            box-shadow: var(--shadow-md); 
            border-color: var(--accent-1);
            background: #1a2332;
        }
        
        /* ===== MINI BARS IN CARD ===== */
        .card-default-view {
            display: block;
        }
        .card-details-view {
            display: none;
        }
        .card.expanded .card-default-view {
            display: none;
        }
        .card.expanded .card-details-view {
            display: block;
        }
        
        .mini-bars-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 8px;
            height: 70px;
            margin: 8px 0;
            padding: 0 8px;
        }
        .mini-bar-col {
            flex: 1;
            max-width: 25px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }
        .mini-bar {
            width: 100%;
            border-radius: 6px 6px 0 0;
            transition: height 0.8s cubic-bezier(0.68,-0.55,0.265,1.55);
            position: relative;
            min-height: 3px;
        }
        .mini-bar.quiz {
            background: linear-gradient(180deg, #f093fb 0%, #f5576c 100%);
        }
        .mini-bar.prayer {
            background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%);
        }
        .mini-bar.attendance {
            background: linear-gradient(180deg, #43e97b 0%, #38f9d7 100%);
        }
        .mini-bar-label {
            font-size: 9px;
            color: #cbd5e0;
            margin-top: 3px;
            white-space: nowrap;
        }
        .mini-bar-value {
            font-size: 11px;
            font-weight: 700;
            color: #fbbf24;
            margin-top: 2px;
        }
        .bar-wrap {
            height: 62px;
            background: rgba(102,126,234,0.1);
            border-radius: 12px; overflow: hidden;
            margin: 8px 0; display: flex; align-items: flex-end;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.06);
        }
        .bar {
            width: 100%;
            transition: height 1s cubic-bezier(0.68,-0.55,0.265,1.55);
            border-radius: 12px 12px 0 0;
            position: relative;
        }
        .bar::after {
            content:''; position: absolute;
            top:0; left:0; right:0; height:30%;
            background: rgba(255,255,255,0.25);
            border-radius: 12px 12px 0 0;
        }
        .bg-high { background: linear-gradient(to top, #48bb78, #68d391); }
        .bg-mid  { background: linear-gradient(to top, #ecc94b, #f6e05e); }
        .bg-low  { background: linear-gradient(to top, #f56565, #fc8181); }

        /* ===== INPUTS ===== */
        textarea, input[type="text"], input[type="password"], select, input[type="number"] {
            width: 100%; padding: 14px; border-radius: 14px;
            border: 2px solid rgba(102,126,234,0.2);
            background: var(--bg-secondary); color: var(--text-primary);
            font-family: 'Cairo', sans-serif; font-size: 15px;
            margin-bottom: 11px; outline: none;
            transition: all 0.3s ease;
        }
        textarea:focus, input:focus, select:focus {
            border-color: var(--accent-1);
            box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
            transform: translateY(-1px);
        }

        /* ===== BUTTONS ===== */
        .btn {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white; padding: 14px 22px; border: none;
            border-radius: 14px; cursor: pointer;
            font-weight: 700; font-size: 15px;
            font-family: 'Cairo', sans-serif;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease; width: 100%;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn:active { transform: translateY(0); }
        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .btn-danger  { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .btn-gold    { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1a202c; }

        /* ===== QUIZ ===== */
        .quiz-card { border: 3px solid var(--accent-2); position: relative; overflow: hidden; }
        .quiz-card::before { content:'üìñ'; position: absolute; top:-18px; left:-18px; font-size:110px; opacity:0.05; }
        .question-card {
            background: rgba(102,126,234,0.06);
            padding: 16px; border-radius: 14px;
            margin-bottom: 14px;
            border-right: 5px solid var(--accent-1);
        }
        .option-label {
            display: block; background: var(--bg-secondary);
            padding: 13px; margin: 7px 0; border-radius: 12px;
            cursor: pointer; border: 2px solid transparent;
            font-size: 14px; transition: all 0.3s ease; font-weight: 600;
        }
        .option-label:hover { border-color: var(--accent-1); background: rgba(102,126,234,0.08); }
        .option-label input { margin-left: 10px; width: 18px; height: 18px; }
        #quizTimerDisplay {
            font-size: 22px; font-weight: 800; color: white;
            text-align: center; margin-bottom: 18px; padding: 14px;
            border-radius: 14px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            box-shadow: var(--shadow-md); animation: pulse 2s infinite;
        }

        /* ===== CHAT ===== */
        .chat-display {
            height: 190px; overflow-y: auto;
            background: var(--bg-secondary);
            padding: 12px; border-radius: 14px; margin-bottom: 10px;
        }
        .chat-msg {
            background: var(--bg-card);
            padding: 10px 14px; border-radius: 14px;
            margin-bottom: 8px; font-size: 13px;
            border-right: 4px solid var(--accent-1);
            word-wrap: break-word;
            box-shadow: var(--shadow-sm);
            animation: slideInRight 0.3s ease;
        }
        .chat-msg.admin-msg { border-right-color: #fbbf24; background: rgba(251,191,36,0.08); }
        .chat-input-row { display: flex; gap: 8px; }
        .chat-input-row input { margin-bottom: 0; flex: 1; }
        .chat-input-row button {
            background: var(--accent-1); border: none;
            padding: 0 18px; border-radius: 14px; color: white;
            font-weight: 700; cursor: pointer; font-size: 15px;
            transition: all 0.3s;
        }
        .chat-input-row button:hover { background: #5a6fd6; }

        .clear-chat-btn {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white; border: none; border-radius: 8px;
            padding: 6px 14px; font-size: 12px; cursor: pointer;
            margin-bottom: 8px; font-weight: 600;
            font-family: 'Cairo', sans-serif;
            box-shadow: var(--shadow-sm); transition: 0.3s;
        }
        .clear-chat-btn:hover { transform: translateY(-1px); }

        /* ===== SWITCH ===== */
        .switch-container {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(102,126,234,0.08);
            padding: 14px 16px; border-radius: 16px;
            margin-bottom: 14px;
            border: 2px solid rgba(102,126,234,0.18);
            font-weight: 600; transition: 0.3s;
        }
        .switch-container:hover { background: rgba(102,126,234,0.13); }
        .switch { position: relative; display: inline-block; width: 50px; height: 27px; }
        .switch input { opacity:0; width:0; height:0; }
        .slider {
            position: absolute; cursor: pointer; inset: 0;
            background-color: #cbd5e0; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content:"";
            height: 21px; width: 21px;
            left: 3px; bottom: 3px;
            background: white; transition: .4s; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); }
        input:checked + .slider:before { transform: translateX(23px); }

        .switch-gold input:checked + .slider { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .switch-pink input:checked + .slider { background: linear-gradient(135deg, #ec4899, #f093fb); }

        /* ===== MOOD ===== */
        .mood-container { display: flex; justify-content: space-around; margin: 18px 0; gap: 8px; }
        .mood-btn {
            font-size: 34px; cursor: pointer; transition: all 0.3s;
            opacity: 0.4; filter: grayscale(100%);
            padding: 8px; border-radius: 14px;
        }
        .mood-btn:hover { transform: scale(1.1); opacity: 0.7; }
        .mood-btn.active {
            opacity: 1; transform: scale(1.25); filter: grayscale(0%);
            background: rgba(102,126,234,0.1);
        }

        /* ===== PSY AREA ===== */
        .psy-section { border: 2px solid #ec4899 !important; }
        .psy-section .section-title .emoji { color: #ec4899; }
        .psy-chat { height: 110px; overflow-y: auto; background: rgba(0,0,0,0.06); border-radius: 10px; padding: 8px; font-size: 12px; margin: 6px 0; }
        [data-theme="dark"] .psy-chat { background: rgba(255,255,255,0.05); }

        /* ===== PRAYER TIMER ===== */
        #prayerTimer {
            display: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 22px; border-radius: 22px;
            margin-top: 18px; text-align: center;
            box-shadow: var(--shadow-lg);
        }
        .prayer-counter { font-size: 56px; font-weight: 800; color: #fbbf24; margin: 12px 0; text-shadow: 0 3px 8px rgba(0,0,0,0.3); }
        .prayer-text-display {
            font-size: 17px; font-weight: 600; color: white;
            min-height: 64px; display: flex; align-items: center; justify-content: center;
            margin-bottom: 12px; background: rgba(0,0,0,0.2);
            border-radius: 14px; padding: 12px; text-align: center; line-height: 1.6;
        }
        .prayer-btn {
            background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3);
            color: white; padding: 18px; border-radius: 16px;
            font-size: 18px; font-weight: 700; cursor: pointer;
            width: 100%; font-family: 'Cairo', sans-serif;
            transition: all 0.3s;
        }
        .prayer-btn:hover { background: rgba(255,255,255,0.25); transform: translateY(-2px); }

        /* ===== LIBRARY ===== */
        .lib-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
        .lib-card {
            background: linear-gradient(135deg, #10b981, #059669);
            padding: 18px; border-radius: 18px; text-align: center;
            cursor: pointer; text-decoration: none; color: white;
            font-weight: 700; font-size: 14px;
            box-shadow: var(--shadow-md); transition: all 0.3s;
        }
        .lib-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .lib-card .lib-emoji { font-size: 28px; display: block; margin-bottom: 6px; }

        /* ===== MUTUAL PRAYER (ALTAR) ===== */
        .altar-section { border: 2px solid #fbbf24 !important; }
        .altar-header {
            text-align: center; color: #fbbf24; font-size: 20px; font-weight: 800;
            border-bottom: 1px solid rgba(251,191,36,0.3); padding-bottom: 10px; margin-bottom: 18px;
        }
        .altar-label {
            color: #fbbf24; font-weight: 700; display: block; margin-bottom: 6px; font-size: 15px;
        }
        .altar-hint {
            color: #4ade80; font-size: 12px; font-style: italic;
            margin-bottom: 6px; background: rgba(74,222,128,0.1);
            padding: 5px 10px; border-radius: 8px;
        }
        .altar-textarea {
            width: 100%; height: 58px;
            background: var(--bg-secondary); color: var(--text-primary);
            border: 2px solid rgba(251,191,36,0.3); border-radius: 12px;
            padding: 10px; resize: none; font-family: 'Cairo', sans-serif;
            font-size: 14px; outline: none; transition: 0.3s;
        }
        .altar-textarea:focus { border-color: #fbbf24; box-shadow: 0 0 0 3px rgba(251,191,36,0.15); }
        .altar-divider { border: 0; border-top: 1px solid rgba(102,126,234,0.15); margin: 16px 0; }
        .metania-row {
            display: flex; align-items: center; gap: 10px;
            background: rgba(102,126,234,0.06); padding: 10px;
            border-radius: 12px; margin-bottom: 10px;
            border: 2px solid rgba(102,126,234,0.15);
        }
        .metania-row input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; accent-color: var(--accent-1); }
        .metania-row input[type="number"] { margin-bottom:0; width: 80px; padding: 6px; text-align: center; }

        /* ===== JIHAD BALANCE ===== */
        .jihad-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .jihad-col-title {
            text-align: center; font-size: 13px; font-weight: 700;
            padding: 6px; border-radius: 10px; margin-bottom: 8px;
        }
        .jihad-col-title.positive { background: rgba(72,187,120,0.12); color: var(--success); }
        .jihad-col-title.negative { background: rgba(245,101,101,0.12); color: var(--danger); }
        .jihad-item {
            background: rgba(102,126,234,0.05); padding: 8px;
            border-radius: 10px; margin-bottom: 7px;
            border: 1px solid rgba(102,126,234,0.1);
        }
        .jihad-item-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;
        }
        .jihad-item-row span { font-size: 14px; }
        .jihad-btn {
            background: rgba(102,126,234,0.15); border: none; color: var(--text-primary);
            width: 28px; height: 28px; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: 700; transition: 0.2s;
        }
        .jihad-btn:hover { background: rgba(102,126,234,0.3); }
        .jihad-score { font-weight: 800; color: var(--warning); font-size: 16px; min-width: 24px; text-align: center; }
        .jihad-note {
            width: 100%; background: rgba(102,126,234,0.06);
            border: 1px solid rgba(102,126,234,0.15); border-radius: 6px;
            color: var(--text-secondary); padding: 5px 8px;
            font-size: 11px; outline: none; margin-top: 3px;
            font-family: 'Cairo', sans-serif; transition: 0.3s;
        }
        .jihad-note:focus { border-color: var(--accent-1); }
        .jihad-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px; grid-column: span 2; }
        .jihad-actions button, .jihad-actions a {
            flex: 1; min-width: 80px; padding: 12px; border-radius: 12px;
            font-weight: 700; font-size: 13px; cursor: pointer;
            text-decoration: none; text-align: center;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Cairo', sans-serif; transition: 0.3s; border: none;
        }
        .jihad-actions .btn-save { background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); color: white; box-shadow: var(--shadow-sm); }
        .jihad-actions .btn-wa { background: linear-gradient(135deg, #25d366, #128c7e); color: white; }
        .jihad-actions .btn-copy { background: rgba(102,126,234,0.1); color: var(--text-primary); border: 2px solid rgba(102,126,234,0.2); }
        .jihad-history-item {
            background: rgba(72,187,120,0.08); padding: 10px; border-radius: 10px;
            margin-bottom: 7px; border-right: 4px solid var(--success);
            position: relative; font-size: 14px;
        }
        .jihad-del-btn { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--danger); border: none; background: none; cursor: pointer; font-size: 16px; }

        /* ===== ATTENDANCE ===== */
        .attendance-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .attendance-row span { min-width: 58px; font-size: 14px; font-weight: 600; }
        .attendance-row input { margin-bottom: 0; flex: 1; }
        .attendance-row .btn { width: auto; padding: 10px 18px; flex-shrink: 0; }

        /* ===== QUESTION ===== */
        .question-section { border: 2px solid var(--accent-1) !important; }

        /* ===== ADMIN PANEL ===== */
        #adminPanel {
            display: none; background: var(--bg-card);
            padding: 22px; border-radius: 22px;
            border: 3px solid var(--success);
            margin-top: 18px; box-shadow: var(--shadow-lg);
        }
        .admin-item {
            background: rgba(72,187,120,0.07); padding: 14px;
            border-radius: 14px; margin-bottom: 10px;
            border-right: 5px solid var(--success);
        }
        .admin-item label { font-weight: 700; display: block; margin-bottom: 8px; }
        #prayerResultsList { max-height: 190px; overflow-y: auto; font-size: 13px; }
        .prayer-result-item { border-bottom: 1px solid rgba(102,126,234,0.12); padding: 7px 0; }
        .prayer-result-item small { color: var(--text-secondary); }

        /* ===== BADGE ===== */
        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white; padding: 4px 11px; border-radius: 18px;
            font-size: 11px; font-weight: 700;
            box-shadow: var(--shadow-sm);
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(102,126,234,0.08); border-radius: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--accent-1); border-radius: 6px; }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        @keyframes slideUp { from { opacity:0; transform:translateY(28px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideInRight { from { opacity:0; transform:translateX(16px); } to { opacity:1; transform:translateX(0); } }
        @keyframes slideDown { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
        @keyframes bounce { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-8px); } }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.8; } }
        @keyframes shake { 0%,100% { transform:translateX(0); } 25% { transform:translateX(-8px); } 75% { transform:translateX(8px); } }
        @keyframes float { from { transform:translateY(0); } to { transform:translateY(-100vh); } }
        @keyframes wave { 
            0%, 100% { transform: translateY(0) scale(1); } 
            25% { transform: translateY(-3px) scale(1.05); } 
            50% { transform: translateY(0) scale(1); } 
            75% { transform: translateY(3px) scale(0.95); } 
        }
        @keyframes fadeOutUp { 
            from { opacity: 1; transform: translateY(0); } 
            to { opacity: 0; transform: translateY(-30px); } 
        }

        /* ===== ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ÿ¥ÿ¨Ÿäÿπ ===== */
        .encouragement-popup {
            position: fixed;
            top: 80px;
            right: 20px;
            left: 20px;
            max-width: 400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            z-index: 10000;
            animation: slideDown 0.5s ease;
            border: 3px solid #fbbf24;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .encouragement-popup .close-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.3);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .encouragement-popup .close-btn:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }
        
        .encouragement-popup .message-content {
            color: white;
            font-size: 16px;
            line-height: 1.8;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
        }
        
        .encouragement-popup .from-tag {
            color: rgba(255,255,255,0.85);
            font-size: 13px;
            margin-top: 12px;
            text-align: center;
            font-weight: 600;
        }
        
        .encouragement-badge {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            z-index: 999;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(239,68,68,0.6);
            border: 2px solid white;
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 4px 15px rgba(239,68,68,0.6);
            }
            50% { 
                transform: scale(1.08); 
                box-shadow: 0 6px 25px rgba(239,68,68,0.9);
            }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-50px); }
        }

        /* ===== PEER CONFIRMATION MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--bg-card);
            margin: 10% auto;
            padding: 25px 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bg-secondary);
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .modal-header p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .peers-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .peer-item {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .peer-item:hover {
            transform: translateX(-5px);
            box-shadow: var(--shadow-md);
        }

        .peer-item.confirmed {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            cursor: default;
        }

        .peer-item.pending {
            background: linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%);
            color: white;
        }

        .peer-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .peer-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--accent-1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
        }

        .peer-item.confirmed .peer-avatar,
        .peer-item.pending .peer-avatar {
            background: rgba(255,255,255,0.3);
        }

        .peer-details h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .peer-details p {
            font-size: 12px;
            opacity: 0.9;
        }

        .peer-action {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            font-weight: 600;
        }

        .close-modal-btn {
            background: var(--accent-1);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
        }

        .close-modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .confirmation-badge {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
        }

        .pending-badge {
            background: linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            animation: pulseBadge 2s infinite;
        }

        @keyframes pulseBadge {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .main-header h2 { font-size: 24px; }
            .verse-text { font-size: 15px; }
            .section-title { font-size: 17px; }
        }

        /* ========== ŸÖŸÖŸäÿ≤ÿßÿ™ ÿ¨ÿØŸäÿØÿ©: ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™ (Badges) ========== */
        .achievement-badge-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .achievement-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 700;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        @keyframes badgeAppear {
            from {
                opacity: 0;
                transform: scale(0.5) rotate(-10deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .badge-gold {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #78350f;
            box-shadow: 0 2px 8px rgba(251,191,36,0.3);
        }

        .badge-silver {
            background: linear-gradient(135deg, #e5e7eb, #9ca3af);
            color: #374151;
            box-shadow: 0 2px 8px rgba(156,163,175,0.3);
        }

        .badge-bronze {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #78350f;
            box-shadow: 0 2px 8px rgba(217,119,6,0.3);
        }

        .badge-blue {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 2px 8px rgba(59,130,246,0.3);
        }

        /* ========== ŸäŸàŸÖŸäÿßÿ™ ÿ®ÿ±ŸÉÿßÿ™ ÿ±ÿ®ŸÜÿß ========== */
        .filter-feeling-btn {
            padding: 8px 16px;
            border: 2px solid rgba(102,126,234,0.3);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .filter-feeling-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .filter-feeling-btn.filter-active {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white;
            border-color: var(--accent-1);
        }
        
        .journal-entries-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .journal-entry-card {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 18px;
            box-shadow: var(--shadow-md);
            border: 2px solid rgba(102,126,234,0.15);
            transition: all 0.3s ease;
            animation: slideDown 0.5s ease;
        }
        
        .journal-entry-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-1);
        }
        
        .journal-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .journal-entry-feeling {
            font-size: 28px;
            padding: 8px 14px;
            background: rgba(102,126,234,0.1);
            border-radius: 12px;
        }
        
        .journal-entry-date {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .journal-entry-title {
            font-size: 17px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .journal-entry-content {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 12px;
            white-space: pre-wrap;
        }
        
        .journal-entry-verse {
            background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(240,147,251,0.1));
            border-right: 4px solid var(--warning);
            padding: 12px;
            border-radius: 10px;
            font-size: 13px;
            color: var(--text-primary);
            font-style: italic;
            margin-top: 10px;
        }
        
        .journal-entry-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid rgba(102,126,234,0.1);
        }
        
        .journal-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .journal-delete-btn {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }
        
        .journal-delete-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(245,101,101,0.4);
        }
        
        .feeling-option {
            padding: 12px 16px;
            border: 3px solid rgba(102,126,234,0.2);
            background: var(--bg-secondary);
            border-radius: 15px;
            cursor: pointer;
            font-size: 28px;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 80px;
        }
        
        .feeling-option:hover {
            transform: scale(1.1);
            border-color: var(--accent-1);
        }
        
        .feeling-option.selected {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            border-color: var(--accent-1);
            color: white;
            transform: scale(1.05);
        }

        /* ========== ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿßŸÑŸÖÿ¥ÿ™ÿ±ŸÉÿ© - ÿ™ÿµŸÖŸäŸÖ ÿ±ÿ≥ÿßÿ¶ŸÑ ========== */
        .shared-stories-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px 5px;
        }
        
        .shared-story-message {
            background: var(--bg-card);
            border-right: 4px solid #10b981;
            border-radius: 12px 12px 12px 4px;
            padding: 12px 14px;
            box-shadow: 0 2px 8px rgba(16,185,129,0.15);
            animation: slideInRight 0.4s ease;
            max-width: 95%;
            align-self: flex-start;
        }
        
        .shared-story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(16,185,129,0.2);
        }
        
        .shared-story-author {
            font-size: 13px;
            font-weight: 700;
            color: #059669;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .shared-story-date {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .shared-story-feeling {
            font-size: 20px;
            margin-left: 6px;
        }
        
        .shared-story-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
            line-height: 1.4;
        }
        
        .shared-story-content {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.7;
            white-space: pre-wrap;
            margin-bottom: 8px;
        }
        
        .shared-story-verse {
            background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(16,185,129,0.08));
            border-right: 3px solid #fbbf24;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-primary);
            font-style: italic;
            margin-top: 8px;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }
        }




        /* ========== ÿ™ŸÜÿ®ŸäŸáÿßÿ™ ÿ™ŸÅÿßÿπŸÑŸäÿ© ŸÖÿ≠ÿ≥ŸëŸÜÿ© ========== */
        .interactive-notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white;
            padding: 18px 30px;
            border-radius: 50px;
            box-shadow: 0 8px 30px rgba(102,126,234,0.4);
            z-index: 999;
            font-weight: 700;
            font-size: 16px;
            animation: notificationSlide 0.5s ease, notificationBounce 2s ease-in-out infinite;
            display: none;
        }

        @keyframes notificationSlide {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes notificationBounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-8px); }
        }

        /* ========== ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ™ÿµŸÖŸäŸÖ ÿ•ÿ∂ÿßŸÅŸäÿ© ========== */
        
        /* ÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿ£ÿ≠ŸÑŸâ Ÿàÿ£ŸÜÿπŸÖ */
        .smooth-entrance {
            animation: smoothEntrance 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes smoothEntrance {
            from {
                opacity: 0;
                transform: scale(0.8) rotate(-5deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        /* ÿ£ŸÑŸàÿßŸÜ ÿ£ŸÉÿ´ÿ± ÿ¨ÿßÿ∞ÿ®Ÿäÿ© */
        .gradient-text {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
        }

        /* ÿ™ÿ¨ÿßŸàÿ® ÿ£ŸÅÿ∂ŸÑ ŸÖÿπ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ */
        @media (max-width: 768px) {
            .achievement-badge-container {
                justify-content: center;
            }

            .level-number {
                font-size: 56px;
            }

            .level-title {
                font-size: 20px;
            }

            .progress-chart-container,
            .weekly-goals-container,
            .level-system-container {
                padding: 15px;
            }
        }

        /* Ÿàÿ∂ÿπ ÿØÿßŸÉŸÜ ŸÖÿ≠ÿ≥ŸëŸÜ */
        [data-theme="dark"] .goal-item {
            background: var(--bg-card);
        }

        [data-theme="dark"] .progress-chart-container {
            background: var(--bg-card);
            border: 1px solid rgba(102,126,234,0.2);
        }
    </style>
</head>
<body>

<!-- ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ´ÿßÿ®ÿ™ÿ© -->
<div id="persistentNotificationsContainer"></div>

<!-- ===================== LOGIN ===================== -->
<div id="loginScreen">
    <div class="login-box">
        <div class="login-icon">‚úùÔ∏è</div>
        <h3>ÿÆÿØŸÖÿ© ÿ•ÿπÿØÿßÿØŸä</h3>
        <p>ÿßÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ŸÑŸÑÿ®ÿØÿ°</p>
        <input type="password" id="passInputUser" placeholder="üîí ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±" onkeyup="if(event.key==='Enter') checkAccess()">
        <button class="btn" onclick="checkAccess()">ÿØÿÆŸàŸÑ üöÄ</button>
        <p onclick="openAdmin()" style="font-size:11px; color:#a0aec0; margin-top:18px; cursor:pointer;">üîß ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÑŸÑÿÆÿØÿßŸÖ</p>
    </div>
</div>

<!-- ===================== MAIN ===================== -->
<div id="mainContent">
    <button class="theme-toggle-btn" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÅÿßÿ™ÿ≠</button>

    <!-- Header -->
    <div class="main-header">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div id="userNameDisplay" style="font-size: 15px; font-weight: 800; color: #fbbf24; animation: wave 2s ease-in-out infinite; display: none; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
            <h2 class="animated-title" style="margin: 0; flex: 1; text-align: center;">
                <span class="word-1">‚õ™</span>
                <span class="word-2">ÿÆÿØŸÖÿ©</span>
                <span class="word-3">ÿ•ÿπÿØÿßÿØŸä</span>
            </h2>
            <div style="width: 80px;"></div>
        </div>
        <small class="animated-subtitle">ŸÉŸÜŸäÿ≥ÿ© ÿßŸÑÿπÿ∞ÿ±ÿßÿ° Ÿàÿ£ÿ®Ÿàÿ≥ŸäŸÅŸäŸÜ ŸàÿßŸÑÿ¥ŸáŸäÿØ ÿ£ÿ®ÿ≥ÿÆŸäÿ±ŸàŸÜ</small>
    </div>

    <div class="container">
        <!-- Verse -->
        <div class="verse-container">
            <div id="dailyVerse" class="verse-text">‚ú® ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ¢Ÿäÿ© ÿ™ÿπÿ≤Ÿäÿ©...</div>
            <div id="verseRef" class="verse-ref"></div>
        </div>

        <!-- Name Selection for Encouragement Messages -->
        <div class="section" id="nameSelectionSection" style="border: 2px solid #fbbf24; background: rgba(251,191,36,0.05); display: none;">
            <div class="section-title"><span class="emoji">üë§</span> ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ ŸÑÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</div>
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ ÿßŸÑÿ´ŸÑÿßÿ´Ÿä ÿπÿ¥ÿßŸÜ ŸÜŸÇÿØÿ± ŸÜÿ™ÿßÿ®ÿπŸÉ ŸàŸÜÿ¥ÿ¨ÿπŸÉ! üíô</p>
            <select id="nameSelect">
                <option value="">-- ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ ÿßŸÑÿ´ŸÑÿßÿ´Ÿä --</option>
            </select>
            <button class="btn btn-gold" onclick="confirmNameSelection()" style="margin-top: 10px;">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ŸÖ ‚úÖ</button>
        </div>

        <!-- Welcome Message (shown after name is selected) -->
        <div id="welcomeMessageSection" style="display:none; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(251,191,36,0.15)); border-radius: 20px; text-align: center; border: 2px solid #fbbf24; animation: slideDown 0.8s ease;">
            <div style="font-size: 48px; margin-bottom: 10px;">üëã</div>
            <div id="welcomeText" style="font-size: 22px; font-weight: 800; color: var(--text-primary); margin-bottom: 8px;"></div>
            <div style="font-size: 14px; color: var(--text-secondary);">ÿ±ÿ®ŸÜÿß ŸäŸÅÿ±ÿ≠ ŸÇŸÑÿ®ŸÉ ŸàŸäŸÇŸàŸäŸÉ! üíô</div>
        </div>



        <!-- ========== ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™ - ÿµÿ∫Ÿäÿ±ÿ© ÿπŸÑŸâ ÿ¨ŸÜÿ® ========== -->
        <div id="badgesSection" style="display:none; margin-bottom: 15px;">
            <div style="display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; background: rgba(102,126,234,0.05); border-radius: 12px;" id="userBadgesContainer">
                <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
            </div>
        </div>

        <!-- ========== ÿ≥ŸàŸäÿ™ÿ¥ ŸäŸàŸÖŸäÿßÿ™ ÿ®ÿ±ŸÉÿßÿ™ ÿ±ÿ®ŸÜÿß ========== -->
        <div class="switch-container" style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(240,147,251,0.1)); border: 2px solid var(--accent-1); position: relative;">
            <span style="font-weight:700;">üìñ ŸäŸàŸÖŸäÿßÿ™ ÿ®ÿ±ŸÉÿßÿ™ ÿ±ÿ®ŸÜÿß ŸÖÿπÿßŸäÿß</span>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="journalNotificationBadge" style="display:none; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; font-size: 12px; font-weight: 800; padding: 4px 10px; border-radius: 20px; animation: pulse 1.5s infinite;">
                    0 ÿ¨ÿØŸäÿØ
                </span>
                <label class="switch">
                    <input type="checkbox" onchange="toggleJournalSection(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- ========== ŸÇÿ≥ŸÖ ÿßŸÑŸäŸàŸÖŸäÿßÿ™ ÿßŸÑÿÆÿßÿµÿ© ========== -->
        <div id="blessingsJournalSection" class="section" style="display:none; background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(240,147,251,0.05)); border: 2px solid var(--accent-1);">
            <div class="section-title"><span class="emoji">üìñ</span> ŸäŸàŸÖŸäÿßÿ™Ÿä ÿßŸÑÿÆÿßÿµÿ©</div>
            <p style="text-align:center; color:var(--text-secondary); font-size:13px; margin-bottom:16px; line-height:1.6;">
                ÿßŸÉÿ™ÿ® ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿßŸÑŸÑŸä ÿ±ÿ®ŸÜÿß ŸàŸÇŸÅ ŸÖÿπÿßŸÉ ŸÅŸäŸáÿß ŸàŸÖÿ¥ÿßÿπÿ±ŸÉ ‚ú®<br>
                <span style="font-size:12px; opacity:0.8;">ÿØŸä ŸäŸàŸÖŸäÿßÿ™ŸÉ ÿßŸÑÿÆÿßÿµÿ©.. ŸÖŸÖŸÉŸÜ ÿ™ÿ¥ÿßÿ±ŸÉŸáÿß ŸÖÿπ ÿßŸÑŸÖÿÆÿØŸàŸÖŸäŸÜ ŸÑŸà ÿ≠ÿ®Ÿäÿ™ üíú</span>
            </p>
            
            <!-- ÿ≤ÿ± ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàŸÇŸÅ ÿ¨ÿØŸäÿØ -->
            <button class="btn" style="background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); margin-bottom:16px; font-size:15px; font-weight:700;" onclick="openJournalEntryModal()">
                ‚úçÔ∏è ÿßŸÉÿ™ÿ® ŸÖŸàŸÇŸÅ ÿ¨ÿØŸäÿØ
            </button>
            
            <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑŸÖÿ¥ÿßÿπÿ± -->
            <div class="feelings-filter" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:20px;">
                <button class="filter-feeling-btn filter-active" data-feeling="all" onclick="filterJournalByFeeling('all')">ÿßŸÑŸÉŸÑ</button>
                <button class="filter-feeling-btn" data-feeling="happy" onclick="filterJournalByFeeling('happy')">üòä</button>
                <button class="filter-feeling-btn" data-feeling="grateful" onclick="filterJournalByFeeling('grateful')">üôè</button>
                <button class="filter-feeling-btn" data-feeling="sad" onclick="filterJournalByFeeling('sad')">üò¢</button>
                <button class="filter-feeling-btn" data-feeling="worried" onclick="filterJournalByFeeling('worried')">üò∞</button>
                <button class="filter-feeling-btn" data-feeling="peaceful" onclick="filterJournalByFeeling('peaceful')">üòå</button>
                <button class="filter-feeling-btn" data-feeling="excited" onclick="filterJournalByFeeling('excited')">ü§©</button>
            </div>
            
            <!-- ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿßŸÑŸÖÿ≥ÿ¨ŸÑÿ© -->
            <div id="journalEntriesContainer" class="journal-entries-container">
                <div class="empty-journal" style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                    <div style="font-size:70px; margin-bottom:12px; animation: bounce 2s infinite;">üìî</div>
                    <p style="font-size:16px; font-weight:600; color:var(--text-primary); margin-bottom:6px;">ŸÑÿ≥Ÿá ŸÖŸÉÿ™ÿ®ÿ™ÿ¥ ÿ£Ÿä ŸÖŸàŸÇŸÅ</p>
                    <p style="font-size:13px;">ÿßÿ®ÿØÿ£ ÿØŸÑŸàŸÇÿ™Ÿä ŸàÿßŸÉÿ™ÿ® ÿ£ŸàŸÑ ŸÖŸàŸÇŸÅ ÿ±ÿ®ŸÜÿß ŸàŸÇŸÅ ŸÖÿπÿßŸÉ ŸÅŸäŸá üíù</p>
                </div>
            </div>
        </div>

        <!-- ========== ŸÖŸàÿßŸÇŸÅ ÿßŸÑŸÖÿÆÿØŸàŸÖŸäŸÜ ÿßŸÑŸÖÿ¥ÿ™ÿ±ŸÉÿ© ========== -->
        <div id="sharedStoriesSection" class="section" style="display:none; border: 2px solid #10b981;">
            <div class="section-title"><span class="emoji">üíö</span> ÿ®ÿ±ŸÉÿßÿ™ ÿ±ÿ®ŸÜÿß ŸÖÿπ ÿßŸÑŸÖÿÆÿØŸàŸÖŸäŸÜ</div>
            <p style="text-align:center; color:var(--text-secondary); font-size:13px; margin-bottom:16px;">
                ÿ¥ŸàŸÅ ÿ•ÿ≤ÿßŸä ÿ±ÿ®ŸÜÿß ÿ®Ÿäÿ¥ÿ™ÿ∫ŸÑ ŸÅŸä ÿ≠Ÿäÿßÿ© ÿ£ÿµÿ≠ÿßÿ®ŸÉ üåü
            </p>
            <div id="sharedStoriesContainer" class="shared-stories-container">
                <div class="empty-journal" style="text-align:center; padding:30px 20px; color:var(--text-secondary);">
                    <div style="font-size:60px; margin-bottom:12px;">üí¨</div>
                    <p style="font-size:15px; font-weight:600; color:var(--text-primary);">ŸÑÿ≥Ÿá ŸÖÿ≠ÿØÿ¥ ÿ¥ÿßÿ±ŸÉ ŸÖŸàÿßŸÇŸÅŸá</p>
                </div>
            </div>
        </div>





        <!-- ÿ™ŸÜÿ®ŸäŸá ÿ™ŸÅÿßÿπŸÑŸä -->
        <div class="interactive-notification" id="interactiveNotification">
            <span id="notificationText"></span>
        </div>

        <!-- ========== ŸÜÿßŸÅÿ∞ÿ© ŸÉÿ™ÿßÿ®ÿ© ŸÖŸàŸÇŸÅ ÿ¨ÿØŸäÿØ ========== -->
        <div id="journalEntryModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10000; backdrop-filter:blur(5px); animation: fadeIn 0.3s ease;">

        <!-- ========== ÿ•ÿ¥ÿπÿßÿ± ŸÖŸàŸÇŸÅ ÿ¨ÿØŸäÿØ ========== -->
        <div id="newStoryNotification" style="display:none; position:fixed; top:100px; right:20px; background:linear-gradient(135deg, #10b981, #059669); color:white; padding:16px 20px; border-radius:15px; box-shadow:0 8px 30px rgba(16,185,129,0.4); z-index:9999; max-width:320px; animation: slideInRight 0.5s ease; cursor:pointer;" onclick="openJournalFromNotification()">
            <div style="display:flex; align-items:center; gap:12px;">
                <div style="font-size:36px; animation: bounce 1s infinite;">üíö</div>
                <div>
                    <div style="font-weight:800; font-size:15px; margin-bottom:4px;">ŸÖŸàŸÇŸÅ ÿ¨ÿØŸäÿØ!</div>
                    <div id="newStoryNotificationText" style="font-size:13px; opacity:0.95; line-height:1.4;"></div>
                </div>
            </div>
            <button onclick="event.stopPropagation(); closeStoryNotification()" style="position:absolute; top:8px; left:8px; background:rgba(255,255,255,0.2); border:none; color:white; width:24px; height:24px; border-radius:50%; cursor:pointer; font-size:16px; line-height:1;">√ó</button>
        </div>
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--bg-card); border-radius:25px; padding:25px; width:90%; max-width:500px; max-height:90vh; overflow-y:auto; box-shadow:var(--shadow-lg); animation: slideUp 0.4s ease;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0; font-size:20px; color:var(--text-primary);">‚úçÔ∏è ÿßŸÉÿ™ÿ® ŸÖŸàŸÇŸÅŸÉ</h3>
                    <button onclick="closeJournalEntryModal()" style="background:none; border:none; font-size:28px; cursor:pointer; color:var(--text-secondary); line-height:1;">√ó</button>
                </div>
                
                <!-- ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ¥ÿßÿπÿ± -->
                <div style="margin-bottom:18px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; color:var(--text-primary);">ÿ•ÿ≤ÿßŸä ŸÉŸÜÿ™ ÿ≠ÿßÿ≥ÿ≥ÿü üí≠</label>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                        <button class="feeling-option" data-feeling="happy" onclick="selectFeeling('happy', 'üòä ŸÅÿ±ÿ≠ÿßŸÜ')">üòä<br><span style="font-size:11px;">ŸÅÿ±ÿ≠ÿßŸÜ</span></button>
                        <button class="feeling-option" data-feeling="grateful" onclick="selectFeeling('grateful', 'üôè ÿ¥ÿßŸÉÿ±')">üôè<br><span style="font-size:11px;">ÿ¥ÿßŸÉÿ±</span></button>
                        <button class="feeling-option" data-feeling="sad" onclick="selectFeeling('sad', 'üò¢ ÿ≠ÿ≤ŸäŸÜ')">üò¢<br><span style="font-size:11px;">ÿ≠ÿ≤ŸäŸÜ</span></button>
                        <button class="feeling-option" data-feeling="worried" onclick="selectFeeling('worried', 'üò∞ ŸÇŸÑŸÇÿßŸÜ')">üò∞<br><span style="font-size:11px;">ŸÇŸÑŸÇÿßŸÜ</span></button>
                        <button class="feeling-option" data-feeling="peaceful" onclick="selectFeeling('peaceful', 'üòå ŸÖÿ∑ŸÖŸÜ')">üòå<br><span style="font-size:11px;">ŸÖÿ∑ŸÖŸÜ</span></button>
                        <button class="feeling-option" data-feeling="excited" onclick="selectFeeling('excited', 'ü§© ŸÖÿ™ÿ≠ŸÖÿ≥')">ü§©<br><span style="font-size:11px;">ŸÖÿ™ÿ≠ŸÖÿ≥</span></button>
                    </div>
                </div>
                
                <!-- ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸàŸÇŸÅ -->
                <div style="margin-bottom:18px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; color:var(--text-primary);">ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸàŸÇŸÅ üìå</label>
                    <input type="text" id="journalTitle" placeholder="ŸÖÿ´ÿßŸÑ: ÿ±ÿ®ŸÜÿß ŸàŸÇŸÅ ŸÖÿπÿßŸäÿß ŸÅŸä ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜ" style="width:100%; padding:12px; border:2px solid rgba(102,126,234,0.3); border-radius:12px; font-family:'Cairo',sans-serif; font-size:14px; background:var(--bg-secondary); color:var(--text-primary);">
                </div>
                
                <!-- ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸàŸÇŸÅ -->
                <div style="margin-bottom:18px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; color:var(--text-primary);">ÿßŸÉÿ™ÿ® ÿßŸÑŸÖŸàŸÇŸÅ ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ ‚ú®</label>
                    <textarea id="journalContent" placeholder="ÿßŸÉÿ™ÿ® ŸáŸÜÿß ÿ•ŸäŸá ÿßŸÑŸÑŸä ÿ≠ÿµŸÑÿå Ÿàÿ•ÿ≠ÿ≥ÿßÿ≥ŸÉ ŸÉÿßŸÜ ÿ•ŸäŸáÿå Ÿàÿ±ÿ®ŸÜÿß ÿπŸÖŸÑ ÿ•ŸäŸá..." style="width:100%; min-height:150px; padding:12px; border:2px solid rgba(102,126,234,0.3); border-radius:12px; font-family:'Cairo',sans-serif; font-size:14px; resize:vertical; background:var(--bg-secondary); color:var(--text-primary); line-height:1.6;"></textarea>
                </div>
                
                <!-- ÿ¢Ÿäÿ© ŸÖŸÇÿØÿ≥ÿ© ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿ© -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; color:var(--text-primary);">üìñ ÿ¢Ÿäÿ© ŸÖŸÇÿØÿ≥ÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
                    <input type="text" id="journalVerse" placeholder="ŸÖÿ´ÿßŸÑ: ŸÉŸÑ ÿßŸÑÿ£ÿ¥Ÿäÿßÿ° ÿ™ÿπŸÖŸÑ ŸÖÿπÿßŸã ŸÑŸÑÿÆŸäÿ± - ÿ±ŸàŸÖŸäÿ© 8:28" style="width:100%; padding:12px; border:2px solid rgba(102,126,234,0.3); border-radius:12px; font-family:'Cairo',sans-serif; font-size:13px; background:var(--bg-secondary); color:var(--text-primary);">
                </div>
                
                <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© -->
                <div style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1)); border: 2px solid #10b981; border-radius:15px; padding:16px; margin-bottom:20px;">
                    <label style="display:block; font-weight:700; margin-bottom:12px; color:#059669; font-size:15px;">üåü ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑŸÖŸàŸÇŸÅ</label>
                    <p style="font-size:12px; color:var(--text-secondary); margin-bottom:12px; line-height:1.5;">
                        ŸÖŸÖŸÉŸÜ ÿ™ÿ¥ÿßÿ±ŸÉ ŸÖŸàŸÇŸÅŸÉ ŸÖÿπ ÿßŸÑŸÖÿÆÿØŸàŸÖŸäŸÜ ÿπÿ¥ÿßŸÜ ÿ™ÿ¥ÿ¨ÿπŸáŸÖ Ÿàÿ™ŸÅÿ±ÿ≠ŸáŸÖ ÿ®ÿ¥ÿ∫ŸÑ ÿ±ÿ®ŸÜÿß ŸÅŸä ÿ≠Ÿäÿßÿ™ŸÉ üíö
                    </p>
                    
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:12px; background:var(--bg-card); border-radius:10px; border:2px solid rgba(16,185,129,0.3); transition:all 0.3s;" onclick="selectSharingOption('private')">
                            <input type="radio" name="sharing" value="private" checked style="width:20px; height:20px; cursor:pointer;">
                            <div>
                                <div style="font-weight:600; color:var(--text-primary); font-size:14px;">üîí ÿÆÿßÿµ (ŸÑŸàÿ≠ÿØŸä ÿ®ÿ≥)</div>
                                <div style="font-size:11px; color:var(--text-secondary);">ÿßŸÑŸÖŸàŸÇŸÅ ŸáŸäÿ®ŸÇŸâ ÿÆÿßÿµ ÿ®ŸäŸÉ Ÿàÿ≠ÿØ ŸÖÿ¥ ŸáŸäÿ¥ŸàŸÅŸá</div>
                            </div>
                        </label>
                        
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:12px; background:var(--bg-card); border-radius:10px; border:2px solid rgba(16,185,129,0.3); transition:all 0.3s;" onclick="selectSharingOption('named')">
                            <input type="radio" name="sharing" value="named" style="width:20px; height:20px; cursor:pointer;">
                            <div>
                                <div style="font-weight:600; color:var(--text-primary); font-size:14px;">üë§ ÿ®ÿßÿ≥ŸÖŸä</div>
                                <div style="font-size:11px; color:var(--text-secondary);">ÿßŸÑŸÖÿÆÿØŸàŸÖŸäŸÜ ŸáŸäÿ¥ŸàŸÅŸàÿß ÿßÿ≥ŸÖŸÉ ŸÖÿπ ÿßŸÑŸÖŸàŸÇŸÅ</div>
                            </div>
                        </label>
                        
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:12px; background:var(--bg-card); border-radius:10px; border:2px solid rgba(16,185,129,0.3); transition:all 0.3s;" onclick="selectSharingOption('anonymous')">
                            <input type="radio" name="sharing" value="anonymous" style="width:20px; height:20px; cursor:pointer;">
                            <div>
                                <div style="font-weight:600; color:var(--text-primary); font-size:14px;">üé≠ ÿ¥ÿÆÿµ ŸÖÿπÿßŸÉŸÖ</div>
                                <div style="font-size:11px; color:var(--text-secondary);">ÿßŸÑŸÖÿÆÿØŸàŸÖŸäŸÜ ŸáŸäÿ¥ŸàŸÅŸàÿß ÿßŸÑŸÖŸàŸÇŸÅ ŸÖŸÜ ÿ∫Ÿäÿ± ÿßÿ≥ŸÖŸÉ</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ≠ŸÅÿ∏ -->
                <div style="display:flex; gap:10px;">
                    <button onclick="saveJournalEntry()" style="flex:1; padding:14px; background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); color:white; border:none; border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; font-family:'Cairo',sans-serif;">üíæ ÿßÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇŸÅ</button>
                    <button onclick="closeJournalEntryModal()" style="padding:14px 20px; background:var(--bg-secondary); color:var(--text-secondary); border:2px solid rgba(102,126,234,0.2); border-radius:12px; font-size:14px; font-weight:600; cursor:pointer; font-family:'Cairo',sans-serif;">ÿ•ŸÑÿ∫ÿßÿ°</button>
                </div>
            </div>
        </div>

        <!-- Admin Alert -->
        <div id="adminAlert">
            <b>üì¢ ÿ™ŸÜÿ®ŸäŸá ŸÖŸÜ ÿßŸÑÿÆÿØÿßŸÖ:</b>
            <span id="alertText"></span>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel">
            <div class="section-title" style="justify-content:center; color: var(--success);"><span class="emoji">üõ†Ô∏è</span> ŸÑŸàÿ≠ÿ© ÿßŸÑÿÆÿØÿßŸÖ</div>
            <div class="admin-item">
                <label>üì£ ÿ™ŸÜÿ®ŸäŸá ÿßŸÑÿÆÿØÿßŸÖ ÿßŸÑÿπÿßŸÖ:</label>
                <input type="text" id="newAdminAlert" placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑÿ™ŸÜÿ®ŸäŸá ŸáŸÜÿß...">
                <button class="btn btn-success" onclick="updateAdminAlert()">ŸÜÿ¥ÿ± ÿßŸÑÿ™ŸÜÿ®ŸäŸá üì§</button>
            </div>
            <div class="admin-item">
                <label>üôè ŸÉŸÑŸÖÿ© ÿ™ÿ¥ÿ¨Ÿäÿπ ÿπŸÜ ÿßŸÑÿµŸÑÿßÿ©:</label>
                <textarea id="prayerEncouragementInput" placeholder="ÿßŸÉÿ™ÿ® ŸÉŸÑŸÖÿ© ÿ™ÿ¥ÿ¨Ÿäÿπ ÿ¨ŸÖŸäŸÑÿ© ÿπŸÜ ÿßŸÑÿµŸÑÿßÿ©..." style="height: 80px;"></textarea>
                <button class="btn btn-gold" onclick="updatePrayerEncouragement()">ÿ≠ŸÅÿ∏ ÿßŸÑŸÉŸÑŸÖÿ© üíù</button>
            </div>
            <div class="admin-item">
                <label>üìñ ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÖÿ∞ÿ®ÿ≠ ÿßŸÑŸäŸàŸÖŸä:</label>
                <div id="prayerResultsList"></div>
            </div>
            <button class="btn btn-danger" onclick="location.reload()">ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÑŸàÿ≠ÿ© ‚úï</button>
        </div>

        <!-- Quiz -->
        <div id="quizSection" class="section quiz-card" style="display:none;">
            <div class="section-title"><span class="emoji">üìñ</span> ŸÖÿ≥ÿßÿ®ŸÇÿ© ÿßŸÑŸÉÿ™ÿßÿ® ÿßŸÑŸÖŸÇÿØÿ≥</div>
            <div id="quizSetup">
                <p style="font-size:13px; color:var(--text-secondary); margin-bottom:10px;">ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÑŸÑÿ®ÿØÿ°:</p>
                <select id="userNameListQuiz"><option value="">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿ≥ŸÖÿßÿ°...</option></select>
                <button class="btn btn-gold" onclick="startQuiz()">ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© ÿßŸÑÿ¢ŸÜ üöÄ</button>
            </div>
            <div id="quizArea" style="display:none;">
                <div id="quizTimerDisplay">‚è±Ô∏è ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: <span id="timeLeft">00:00</span></div>
                <div id="questionsContainer"></div>
                <button class="btn btn-success" onclick="submitQuiz()">ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ‚úÖ</button>
            </div>
            <div id="quizDone" style="display:none; text-align:center; padding:14px;">
                <div style="font-size:48px; margin-bottom:10px;">üéâ</div>
                <h3 id="quizStatusTitle" style="color:var(--success); margin-bottom:8px;">ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ!</h3>
                <div id="finalQuizScore" style="font-size:19px; font-weight:800; color:var(--warning); margin:10px 0;"></div>
                <p style="font-size:12px; color:var(--text-secondary);">ÿØÿ±ÿ¨ÿ™ŸÉ ŸÖÿ≥ÿ¨ŸÑÿ© ŸÅŸä ŸÑŸàÿ≠ÿ© ÿßŸÑÿ¥ÿ±ŸÅ ‚ù§Ô∏è</p>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="section">
            <div class="section-title"><span class="emoji">üèÜ</span> ŸÑŸàÿ≠ÿ© ÿßŸÑÿ¥ÿ±ŸÅ</div>
            <div id="leaderboard" class="grid"></div>
        </div>

        <!-- Chat Name -->
        <div class="section">
            <div class="section-title"><span class="emoji">üìù</span> ÿßÿ≥ŸÖŸÉ ŸÅŸä ÿßŸÑÿØÿ±ÿØÿ¥ÿ©</div>
            <input type="text" id="userName" placeholder="ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ ŸáŸÜÿß..." oninput="localStorage.setItem('chat_user_name', this.value)">
        </div>

        <!-- Chat -->
        <div class="section" style="border-right: 4px solid var(--accent-1);">
            <div class="section-title"><span class="emoji">üí¨</span> ÿØÿ±ÿØÿ¥ÿ© ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ©</div>
            <div id="chatBox" class="chat-display"></div>
            <div class="chat-input-row">
                <input type="text" id="chatInput" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." onkeyup="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
            </div>
        </div>

        <!-- Psychology Toggle -->
        <div class="switch-container switch-pink">
            <span style="font-weight:700;">üå± ÿ±ŸÉŸÜ ÿßŸÑŸÖÿ≥ÿßŸÜÿØÿ© ÿßŸÑŸÜŸÅÿ≥Ÿäÿ©</span>
            <label class="switch">
                <input type="checkbox" onchange="document.getElementById('psyArea').style.display = this.checked ? 'block' : 'none'">
                <span class="slider"></span>
            </label>
        </div>

        <!-- Psychology Area -->
        <div id="psyArea" class="section psy-section" style="display:none;">
            <p style="text-align:center; font-size:13px; color:var(--text-secondary); margin-bottom:14px;">ŸÖÿß ÿ™ÿÆŸÅÿ¥ ÿßÿ≠ŸÜÿß ÿ¨ŸÜÿ®ŸÉ ÿ®ŸÜÿ≠ÿ®ŸÉ ŸàÿßŸÜÿ™ ÿ∫ÿßŸÑŸä ÿπŸÑŸâ ŸÇŸÑÿ® ÿßŸÑŸÖÿ≥Ÿäÿ≠.. ‚ù§Ô∏è</p>
            <input type="text" id="psyNameInput" placeholder="ÿßÿ≥ŸÖŸÉ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä - ÿßÿ™ÿ±ŸÉŸá ŸÅÿßÿ±ÿ∫ÿßŸã ŸÑŸÑŸÖÿ¨ŸáŸàŸÑ)" style="border: 2px dashed rgba(236,72,153,0.4);">
            <div class="mood-container">
                <span class="mood-btn" onclick="setMood(this,'üò≠')">üò≠</span>
                <span class="mood-btn" onclick="setMood(this,'üò•')">üò•</span>
                <span class="mood-btn" onclick="setMood(this,'üòü')">üòü</span>
                <span class="mood-btn" onclick="setMood(this,'üòå')">üòå</span>
                <span class="mood-btn" onclick="setMood(this,'üòä')">üòä</span>
            </div>
            <select id="psyNeed">
                <option value="ŸÖÿ¨ÿ±ÿØ ŸÅÿ∂ŸÅÿ∂ÿ© üó£Ô∏è">üó£Ô∏è ŸÖÿ¨ÿ±ÿØ ŸÅÿ∂ŸÅÿ∂ÿ©</option>
                <option value="ÿµŸÑÿßÿ© ŸÖŸÜ ÿ£ÿ¨ŸÑŸä üôè">üôè ÿµŸÑÿßÿ© ŸÖŸÜ ÿ£ÿ¨ŸÑŸä</option>
                <option value="ÿ•ŸÜŸÇÿßÿ∞ ÿ≥ÿ±Ÿäÿπ üö®">üö® ÿ•ŸÜŸÇÿßÿ∞ ÿ≥ÿ±Ÿäÿπ</option>
                <option value="ÿØÿπŸÖ Ÿàÿ™Ÿàÿ¨ŸäŸá ü§ù">ü§ù ÿØÿπŸÖ Ÿàÿ™Ÿàÿ¨ŸäŸá</option>
            </select>
            <button class="btn" style="background:linear-gradient(135deg,#ec4899,#f093fb); margin-bottom:14px;" onclick="sendMoodOnly()">ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ© üïäÔ∏è</button>

            <div id="psyChatContainer">
                <button class="clear-chat-btn" onclick="clearPsyChat()">ŸÖÿ≥ÿ≠ ÿßŸÑÿØÿ±ÿØÿ¥ÿ© üóëÔ∏è</button>
                <small style="color:var(--text-secondary); font-size:12px;">ŸÖÿ≠ÿßÿØÿ´ÿ© ŸÖÿ¨ŸáŸàŸÑÿ© ŸÖÿπ ÿßŸÑÿÆÿßÿØŸÖ:</small>
                <div id="psyLocalChat" class="psy-chat"></div>
                <div class="chat-input-row">
                    <input type="text" id="psyChatInput" placeholder="ÿ±ÿ≥ÿßŸÑÿ© ÿ≥ÿ±Ÿäÿ©..." style="font-size:13px;" onkeyup="if(event.key==='Enter') sendPsyChat()">
                    <button onclick="sendPsyChat()" style="background:linear-gradient(135deg,#ec4899,#f093fb);">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
                </div>
            </div>

            <button class="btn btn-gold" style="margin-top:16px;" onclick="startPrayerSession()">‚ú® ŸäŸÑÿß ŸÜÿµŸÑŸà ÿ≥Ÿàÿß (33 ÿµŸÑÿßÿ©) ‚ú®</button>
            <div id="prayerTimer">
                <div class="prayer-text-display" id="activePrayer"></div>
                <div class="prayer-counter" id="pCountText">0</div>
                <button class="prayer-btn" onclick="countPrayer()">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿπÿØ ‚ûî</button>
            </div>
        </div>

        <!-- Library -->
        <div id="librarySection" class="section" style="border: 2px solid var(--success);">
            <div class="section-title"><span class="emoji">üé•</span> ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑŸÖŸäÿØŸäÿß</div>
            <div class="lib-grid">
                <a id="hymnLink" href="#" target="_blank" class="lib-card"><span class="lib-emoji">üéµ</span> ŸÑÿ≠ŸÜ ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</a>
                <a id="pdfLink" href="#" target="_blank" class="lib-card"><span class="lib-emoji">üìñ</span> ÿßŸÑŸÖŸÜŸáÿ¨ (PDF)</a>
                <a id="videoLink" href="#" target="_blank" class="lib-card" style="grid-column:span 2;"><span class="lib-emoji">üé¨</span> ÿ¥ÿßŸáÿØ ŸÅŸäÿØŸäŸà ÿßŸÑÿØÿ±ÿ≥</a>
            </div>
        </div>

        <!-- Prayer Altar Toggle -->
        <div class="switch-container switch-gold">
            <span style="font-weight:700; color:var(--warning);">üôè ŸÅÿ™ÿ≠ ŸÖÿ∞ÿ®ÿ≠ ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑŸäŸàŸÖŸä <span class="badge">Ÿ• ÿØÿ±ÿ¨ÿßÿ™ üéÅ</span></span>
            <label class="switch">
                <input type="checkbox" onchange="document.getElementById('mutualPrayerSection').style.display = this.checked ? 'block' : 'none'">
                <span class="slider"></span>
            </label>
        </div>

        <!-- Prayer Altar -->
        <div id="mutualPrayerSection" class="section altar-section" style="display:none;">
            <div class="altar-header">‚ú® ŸÖŸéÿ∞Ÿíÿ®Ÿéÿ≠ ÿßŸÑÿµŸéŸëŸÑŸéÿßÿ© ÿßŸÑŸäŸéŸàŸíŸÖŸêŸä ‚ú®</div>

            <!-- ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ¥ÿ¨Ÿäÿπ ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ ÿπŸÜ ÿßŸÑÿµŸÑÿßÿ© -->
            <div id="prayerEncouragementBox" style="background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(240,147,251,0.15)); 
                border: 2px solid #fbbf24; border-radius: 15px; padding: 15px; margin-bottom: 15px; 
                text-align: center; display: none;">
                <div style="font-size: 28px; margin-bottom: 8px;">üôè</div>
                <div id="prayerEncouragementText" style="color: var(--text-primary); font-weight: 700; 
                    font-size: 15px; line-height: 1.6;"></div>
                <div style="color: var(--text-secondary); font-size: 12px; margin-top: 8px; font-style: italic;">
                    üíù ŸÖŸÜ ÿßŸÑÿÆÿØÿßŸÖ
                </div>
            </div>

            <div style="margin-bottom:16px;">
                <label class="altar-label">üìñ Ÿ°. ÿµŸÑÿßÿ© ŸÖŸÜ ÿßŸÑÿ£ÿ¨ÿ®Ÿäÿ©:</label>
                <div id="admin_agpeya_hint" class="altar-hint">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ™Ÿàÿ¨ŸäŸá ÿßŸÑÿÆÿßÿØŸÖ...</div>
                <textarea id="agpeyaText" class="altar-textarea" placeholder="ÿßŸÉÿ™ÿ® ŸÖÿß ÿµŸÑŸäÿ™Ÿá ŸáŸÜÿß..."></textarea>
            </div>

            <hr class="altar-divider">

            <div style="margin-bottom:16px;">
                <label class="altar-label">üïäÔ∏è Ÿ¢. ÿµŸÑÿßÿ™Ÿä ÿßŸÑÿÆÿßÿµÿ©:</label>

                <div class="metania-row">
                    <span style="color:var(--text-secondary); font-size:14px;">‚Ä¢ ŸÖŸäÿ∑ÿßŸÜŸäÿ©:</span>
                    <input type="checkbox" id="metaniaDone"> <span style="font-size:13px;">ÿ™ŸÖ</span>
                    <input type="number" id="metaniaCount" placeholder="ÿßŸÑÿπÿØÿØ" min="0">
                </div>

                <div style="margin-bottom:10px;">
                    <small style="color:var(--text-secondary); display:block; margin-bottom:3px;">‚Ä¢ ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ±ÿ®ŸÜÿß Ÿäÿ≥Ÿàÿπ:</small>
                    <div id="admin_thanks_hint" class="altar-hint"></div>
                    <textarea id="prayThank" class="altar-textarea" placeholder="ÿßŸÉÿ™ÿ® ÿ¥ŸÉÿ±ŸÉ ŸáŸÜÿß..."></textarea>
                </div>
                <div style="margin-bottom:10px;">
                    <small style="color:var(--text-secondary); display:block; margin-bottom:3px;">‚Ä¢ ÿÆÿ∂Ÿàÿπ Ÿàÿ∑ŸÑÿ® ŸÖÿ∫ŸÅÿ±ÿ©:</small>
                    <div id="admin_forgive_hint" class="altar-hint"></div>
                    <textarea id="prayForgive" class="altar-textarea" placeholder="ÿßŸÉÿ™ÿ® ÿµŸÑÿßÿ™ŸÉ ŸáŸÜÿß..."></textarea>
                </div>
                <div style="margin-bottom:10px;">
                    <small style="color:var(--text-secondary); display:block; margin-bottom:3px;">‚Ä¢ ŸÇŸÑÿ®Ÿä ŸÖŸÑÿ™Ÿáÿ® ŸÑÿ±ÿ®ŸÜÿß:</small>
                    <div id="admin_heart_hint" class="altar-hint"></div>
                    <textarea id="prayHeart" class="altar-textarea" placeholder="ÿßŸÉÿ™ÿ® ÿµŸÑÿßÿ™ŸÉ ŸáŸÜÿß..."></textarea>
                </div>
                <div style="margin-bottom:10px;">
                    <small style="color:var(--text-secondary); display:block; margin-bottom:3px;">‚Ä¢ ÿ∑ŸÑÿ®ÿ© ÿßÿ™ÿ≠ÿßÿØ ŸÅŸä ÿ±ÿ®ŸÜÿß:</small>
                    <div id="admin_union_hint" class="altar-hint"></div>
                    <textarea id="prayUnion" class="altar-textarea" placeholder="ÿßŸÉÿ™ÿ® ÿµŸÑÿßÿ™ŸÉ ŸáŸÜÿß..."></textarea>
                </div>
            </div>

            <hr class="altar-divider">

            <div style="margin-bottom:16px;">
                <label class="altar-label">üìú Ÿ£. ÿ£ŸÉÿ´ÿ± ÿ¢Ÿäÿ© ŸÖŸÜ ÿßŸÑŸÉÿ™ÿßÿ® ÿßŸÑŸÖŸÇÿØÿ≥:</label>
                <div id="admin_verse_hint" class="altar-hint"></div>
                <textarea id="bibleVerseText" class="altar-textarea" placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑÿ¢Ÿäÿ© ŸáŸÜÿß..."></textarea>
            </div>

            <div style="margin-bottom:16px;">
                <label class="altar-label">‚è±Ô∏è Ÿ§. ŸÖÿØÿ© ÿßŸÑÿµŸÑÿßÿ© (ÿ®ÿßŸÑÿØŸÇÿßÿ¶ŸÇ):</label>
                <input type="number" id="prayerDuration" placeholder="ŸÖÿ´ŸÑÿßŸã: 15" style="border-color: rgba(251,191,36,0.4);">
            </div>

            <select id="prayerUserName">
                <option value="">-- ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ ÿßŸÑÿ´ŸÑÿßÿ´Ÿä --</option>
            </select>
            <button class="btn btn-gold" onclick="sendMutualPrayer()">ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖÿ∞ÿ®ÿ≠ ‚úÖ</button>
        </div>

        <!-- Question -->
        <div class="section question-section">
            <div class="section-title"><span class="emoji">‚ùì</span> ÿ≥ÿ§ÿßŸÑ ÿ£Ÿà ÿßŸÇÿ™ÿ±ÿßÿ≠</div>
            <textarea id="quesMsg" placeholder="ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑŸÉ ŸáŸÜÿß..." style="height:64px;"></textarea>
            <button class="btn" onclick="sendQuestion()">ÿ•ÿ±ÿ≥ÿßŸÑ üì§</button>
        </div>

        <!-- Jihad Toggle -->
        <div class="switch-container switch-gold">
            <span style="font-weight:700; color:var(--warning);">üïäÔ∏è ŸÅÿ™ÿ≠ ŸÖŸäÿ≤ÿßŸÜ ÿßŸÑÿ¨ŸáÿßÿØ ÿßŸÑŸäŸàŸÖŸä</span>
            <label class="switch">
                <input type="checkbox" id="jihadMasterToggle" onchange="toggleJihadSection(this.checked)">
                <span class="slider"></span>
            </label>
        </div>

        <!-- Jihad Area -->
        <div id="jihadArea" class="section" style="display:none; border: 2px solid var(--warning);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div class="section-title" style="margin-bottom:0;"><span class="emoji">üïäÔ∏è</span> ŸÖŸäÿ≤ÿßŸÜ ÿßŸÑÿ¨ŸáÿßÿØ ÿßŸÑŸäŸàŸÖŸä</div>
                <button onclick="changeJihadPin()" style="background:none; border:1px solid rgba(102,126,234,0.3); color:var(--text-secondary); font-size:11px; padding:5px 10px; border-radius:8px; cursor:pointer; font-family:'Cairo',sans-serif;">ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿ≥ÿ±Ÿä üîë</button>
            </div>

            <div class="jihad-grid">
                <div>
                    <div class="jihad-col-title positive">‚ú® ÿ´ŸÖÿßÿ± ÿßŸÑŸÜŸàÿ±</div>
                    <!-- Positive items -->
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>üôè ÿµŸÑÿßÿ©</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp1',-1)">‚àí</button><span class="jihad-score jihad-p-score" id="jp1">0</span><button class="jihad-btn" onclick="jihadCh('jp1',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿµŸÑÿßÿ©..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>üìñ ÿ•ŸÜÿ¨ŸäŸÑ</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp2',-1)">‚àí</button><span class="jihad-score jihad-p-score" id="jp2">0</span><button class="jihad-btn" onclick="jihadCh('jp2',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ÿ¢Ÿäÿ© ÿßŸÑŸäŸàŸÖ..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ü§ù ÿπŸÖŸÑ ŸÖÿ≠ÿ®ÿ©</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp3',-1)">‚àí</button><span class="jihad-score jihad-p-score" id="jp3">0</span><button class="jihad-btn" onclick="jihadCh('jp3',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ŸÖŸàŸÇŸÅ..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>üí¨ ÿ™ÿ¥ÿ¨Ÿäÿπ/ÿ¥ŸÉÿ±</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp4',-1)">‚àí</button><span class="jihad-score jihad-p-score" id="jp4">0</span><button class="jihad-btn" onclick="jihadCh('jp4',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ÿ¥ŸÉÿ±ÿ™ ŸÖŸäŸÜÿü">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>üí™ ÿ™ÿ∫ÿµÿ® (ÿÆŸäÿ±)</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp5',-1)">‚àí</button><span class="jihad-score jihad-p-score" id="jp5">0</span><button class="jihad-btn" onclick="jihadCh('jp5',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ÿ™ÿ∫ÿµÿ®ÿ™ ŸÅŸä ÿ•ŸäŸáÿü">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>üèÜ ÿßŸÜÿ™ÿµÿßÿ±</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jp6',-1)">‚àí</button><span class="jihad-score jihad-p-score" id="jp6">0</span><button class="jihad-btn" onclick="jihadCh('jp6',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ÿßŸÜÿ™ÿµÿßÿ± ÿπŸÑŸâ..">
                    </div>
                </div>
                <div>
                    <div class="jihad-col-title negative">üõ°Ô∏è ÿØÿ±Ÿàÿ≥ ÿßŸÑÿ¨ŸáÿßÿØ</div>
                    <!-- Negative items -->
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>üôä ÿ¥ÿ™ŸäŸÖÿ©</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jn1',-1)">‚àí</button><span class="jihad-score jihad-n-score" id="jn1">0</span><button class="jihad-btn" onclick="jihadCh('jn1',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ÿ≥ÿ£ÿ™ÿπŸÑŸÖ..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ü§• ŸÉÿ∞ÿ®</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jn2',-1)">‚àí</button><span class="jihad-score jihad-n-score" id="jn2">0</span><button class="jihad-btn" onclick="jihadCh('jn2',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ÿßŸÑÿµÿØŸÇ ŸáŸà..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>ü§ê ŸÉŸÑÿßŸÖ ÿ±ÿØŸäÿ°</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jn3',-1)">‚àí</button><span class="jihad-score jihad-n-score" id="jn3">0</span><button class="jihad-btn" onclick="jihadCh('jn3',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ÿ∂ÿ®ÿ∑ ŸÑÿ≥ÿßŸÜ..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>üî• ÿ∫ÿ∂ÿ®</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jn4',-1)">‚àí</button><span class="jihad-score jihad-n-score" id="jn4">0</span><button class="jihad-btn" onclick="jihadCh('jn4',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ŸáÿØŸàÿ¶Ÿä ŸÅŸä..">
                    </div>
                    <div class="jihad-item">
                        <div class="jihad-item-row"><span>üí≠ ŸÅŸÉÿ± ÿ≥ŸÑÿ®Ÿä</span><div style="display:flex;align-items:center;gap:6px;"><button class="jihad-btn" onclick="jihadCh('jn5',-1)">‚àí</button><span class="jihad-score jihad-n-score" id="jn5">0</span><button class="jihad-btn" onclick="jihadCh('jn5',1)">+</button></div></div>
                        <input type="text" class="jihad-note" placeholder="ŸÅŸÉÿ±Ÿä ŸÖÿπ ÿßŸÑŸÖÿ≥Ÿäÿ≠..">
                    </div>
                </div>
                <div class="jihad-actions">
                    <button class="btn-save" onclick="jihadSave()">ÿ≠ŸÅÿ∏ ÿßŸÑŸäŸàŸÖ üìñ</button>
                    <button class="btn-save" onclick="jihadShowResults()" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© üìä</button>
                    <a href="#" class="btn-wa" onclick="jihadPrepareLink(event,'wa')">Ÿàÿßÿ™ÿ≥ÿßÿ® üí¨</a>
                    <button class="btn-copy" onclick="jihadPrepareLink(event,'copy')">ŸÜÿ≥ÿÆ üìã</button>
                </div>
            </div>

            <div id="jihadHList" style="margin-top:20px; border-top:1px solid rgba(102,126,234,0.15); padding-top:12px; display:none;"></div>
        </div>

        <!-- Attendance -->
        <div class="section" style="border: 2px solid var(--success);">
            <div class="section-title"><span class="emoji">‚õ™</span> ÿ±ŸÉŸÜ ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖ ÿßŸÑŸÉŸÜÿ≥Ÿä <span class="badge">ÿ≠ÿ™Ÿâ Ÿ¶ ŸÜŸÇÿßÿ∑ üéÅ</span></div>
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">
                ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã ÿ´ŸÖ ÿ≥ÿ¨ŸÑ ÿ≠ÿ∂Ÿàÿ±ŸÉ:<br>
                <span style="font-size:11px; color:#10b981; font-weight:600;">
                    ‚õ™ ÿßŸÑŸÇÿØÿßÿ≥: 3 ŸÜŸÇÿßÿ∑ + 3 ÿ®ÿπÿØ ÿ™ÿ£ŸÉŸäÿØ ÿ≤ŸÖŸäŸÑŸÉ = 6 ŸÜŸÇÿßÿ∑ ‚Ä¢ ü§ù ÿßŸÑÿÆÿØŸÖÿ©: 5 ŸÜŸÇÿßÿ∑
                </span>
            </p>
            <select id="attendanceNameSelect"><option value="">-- ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ --</option></select>
            <div class="attendance-row">
                <span>‚ò¶Ô∏è ÿßŸÑŸÇÿØÿßÿ≥ ÿßŸÑŸÜŸáÿßÿ±ÿØŸá:</span>
                <input type="time" id="massTime" placeholder="ÿßŸÑÿ≥ÿßÿπÿ© ŸÉÿßŸÖÿü" style="width:100px;">
                <input type="text" id="priestName" placeholder="ÿ£ÿ®ŸàŸÜÿß ŸÖŸäŸÜÿü" style="width:120px;">
                <button class="btn btn-success" onclick="submitAttendance('ŸÇÿØÿßÿ≥','liturgyDay')">‚úÖ ÿ≥ÿ¨ŸÑ</button>
            </div>
            <div id="confirmationStatus" style="display:none; background:linear-gradient(135deg, #fbbf24, #f59e0b); color:white; padding:12px; border-radius:12px; margin-top:10px; font-size:13px; font-weight:600; text-align:center;">
            </div>
            <div class="attendance-row">
                <span>ü§ù ÿßŸÑÿÆÿØŸÖÿ©:</span>
                <input type="text" id="serviceDay" placeholder="ŸäŸàŸÖ ÿ•ŸäŸáÿü">
                <button class="btn btn-success" onclick="submitAttendance('ÿÆÿØŸÖÿ©','serviceDay')">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
            </div>
            <div id="serviceWarning" style="display:none; background:#fef3c7; color:#78350f; padding:10px; border-radius:8px; margin-top:10px; font-size:13px; font-weight:600;">
                ‚ö†Ô∏è ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿÆÿØŸÖÿ© ŸäŸàŸÖ ÿßŸÑÿ¨ŸÖÿπÿ© ŸÅŸÇÿ∑!
            </div>
            <div id="massWarning" style="display:none; background:#fee2e2; color:#7f1d1d; padding:10px; border-radius:8px; margin-top:10px; font-size:13px; font-weight:600;">
                ‚ùå ŸÑÿßÿ≤ŸÖ ÿ™ÿ≥ÿ¨ŸÑ ÿßŸÑŸÇÿØÿßÿ≥ ÿßŸÑŸÜŸáÿßÿ±ÿØŸá ŸÅŸÇÿ∑!
            </div>
        </div>

    </div><!-- end container -->
</div><!-- end mainContent -->

<!-- Peer Confirmation Modal -->
<div id="peerConfirmationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ü§ù ÿßÿÆÿ™ÿ± ÿ≤ŸÖŸäŸÑ ŸÑÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∂Ÿàÿ±ŸÉ</h3>
            <p>ÿßÿÆÿ™ÿ± Ÿàÿßÿ≠ÿØ ŸÖŸÜ ÿ≤ŸÖÿßŸäŸÑŸÉ ÿπÿ¥ÿßŸÜ Ÿäÿ£ŸÉÿØ ÿ•ŸÜŸÉ ŸÉŸÜÿ™ ŸÖÿπÿßŸáŸÖ ŸÅŸä ÿßŸÑŸÇÿØÿßÿ≥</p>
        </div>
        <div id="peersList" class="peers-list">
            <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®ÿßŸÑÿ£ÿ≥ŸÖÿßÿ° ŸÖŸÜ JavaScript -->
        </div>
        <button class="close-modal-btn" onclick="closePeerModal()">ÿ•ÿ∫ŸÑÿßŸÇ</button>
    </div>
</div>

<!-- ===================== SCRIPT ===================== -->
<script>
const config = { databaseURL: "https://jesus-bb0ba-default-rtdb.firebaseio.com/" };
firebase.initializeApp(config);
const db = firebase.database();

// ===== PWA Service Worker =====
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const swCode = `
            const CACHE_NAME = 'is-app-v1';
            self.addEventListener('install', e => {
                e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(['./', 'index.html'])));
            });
            self.addEventListener('fetch', e => {
                e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
            });
        `;
        const blob = new Blob([swCode], {type: 'text/javascript'});
        navigator.serviceWorker.register(URL.createObjectURL(blob));
    });
}

let psySessionID = localStorage.getItem('psy_session_id') || ("User_" + Date.now());
localStorage.setItem('psy_session_id', psySessionID);

// ===== ŸÜÿ∏ÿßŸÖ ŸÖŸÜÿπ ÿßŸÑÿ≠ŸÑ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ± ŸÑŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© =====
let currentUserId = null;
let currentUserName = null;

function getUserId(userName) {
    return userName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_\u0600-\u06FF]/g, '');
}

// ===== BIBLE VERSES =====
const bibleVerses = [
    {t:"ŸÑÿßŸé ÿ™ŸéÿÆŸéŸÅŸí ŸÑÿ£ŸéŸÜŸêŸëŸä ŸÖŸéÿπŸéŸÉŸé. ŸÑÿßŸé ÿ™Ÿéÿ™ŸéŸÑŸéŸÅŸéŸëÿ™Ÿí ŸÑÿ£ŸéŸÜŸêŸëŸä ÿ•ŸêŸÑŸáŸèŸÉŸé. ŸÇŸéÿØŸí ÿ£ŸéŸäŸéŸëÿØŸíÿ™ŸèŸÉŸé ŸàŸéÿ£ŸéÿπŸéŸÜŸíÿ™ŸèŸÉŸé ŸàŸéÿπŸéÿ∂ŸéÿØŸíÿ™ŸèŸÉŸé ÿ®ŸêŸäŸéŸÖŸêŸäŸÜŸê ÿ®Ÿêÿ±ŸêŸëŸä.",r:"ÿ•ÿ¥ÿπŸäÿßÿ° 41: 10"},
    {t:"ÿ£ŸéŸÜŸéÿß ŸÖŸéÿπŸéŸÉŸèŸÖŸí ŸÉŸèŸÑŸéŸë ÿßŸÑÿ£ŸéŸäŸéŸëÿßŸÖŸê ÿ•ŸêŸÑŸéŸâ ÿßŸÜŸíŸÇŸêÿ∂Ÿéÿßÿ°Ÿê ÿßŸÑÿØŸéŸëŸáŸíÿ±Ÿê.",r:"ŸÖÿ™Ÿâ 28: 20"},
    {t:"ÿßŸéŸÑÿ±ŸéŸëÿ®ŸèŸë ÿ±ŸéÿßÿπŸêŸäŸéŸë ŸÅŸéŸÑÿßŸé ŸäŸèÿπŸíŸàŸêÿ≤ŸèŸÜŸêŸä ÿ¥ŸéŸäŸíÿ°Ÿå.",r:"ŸÖÿ≤ŸÖŸàÿ± 23: 1"},
    {t:"ÿ™ŸéÿπŸéÿßŸÑŸéŸàŸíÿß ÿ•ŸêŸÑŸéŸäŸéŸë ŸäŸéÿß ÿ¨ŸéŸÖŸêŸäÿπŸé ÿßŸÑŸíŸÖŸèÿ™ŸíÿπŸéÿ®ŸêŸäŸÜŸé ŸàŸéÿßŸÑÿ´ŸéŸëŸÇŸêŸäŸÑŸêŸä ÿßŸÑÿ£Ÿéÿ≠ŸíŸÖŸéÿßŸÑŸêÿå ŸàŸéÿ£ŸéŸÜŸéÿß ÿ£Ÿèÿ±ŸêŸäÿ≠ŸèŸÉŸèŸÖŸí.",r:"ŸÖÿ™Ÿâ 11: 28"},
    {t:"ŸÉŸèŸÑŸèŸë ÿ¥ŸéŸäŸíÿ°Ÿç ŸÖŸèÿ≥Ÿíÿ™Ÿéÿ∑ŸéÿßÿπŸå ŸÑŸêŸÑŸíŸÖŸèÿ§ŸíŸÖŸêŸÜŸê.",r:"ŸÖÿ±ŸÇÿ≥ 9: 23"},
    {t:"ÿ£Ÿéÿ≥Ÿíÿ™Ÿéÿ∑ŸêŸäÿπŸè ŸÉŸèŸÑŸéŸë ÿ¥ŸéŸäŸíÿ°Ÿç ŸÅŸêŸä ÿßŸÑŸíŸÖŸéÿ≥ŸêŸäÿ≠Ÿê ÿßŸÑŸéŸëÿ∞ŸêŸä ŸäŸèŸÇŸéŸàŸêŸëŸäŸÜŸêŸä.",r:"ŸÅŸäŸÑÿ®Ÿä 4: 13"},
    {t:"ÿ≥ŸéŸÑÿßŸéŸÖŸãÿß ÿ£Ÿéÿ™Ÿíÿ±ŸèŸÉŸè ŸÑŸéŸÉŸèŸÖŸí. ÿ≥ŸéŸÑÿßŸéŸÖŸêŸä ÿ£ŸèÿπŸíÿ∑ŸêŸäŸÉŸèŸÖŸí. ŸÑŸéŸäŸíÿ≥Ÿé ŸÉŸéŸÖŸéÿß ŸäŸèÿπŸíÿ∑ŸêŸä ÿßŸÑŸíÿπŸéÿßŸÑŸéŸÖŸè ÿ£ŸèÿπŸíÿ∑ŸêŸäŸÉŸèŸÖŸí ÿ£ŸéŸÜŸéÿß.",r:"ŸäŸàÿ≠ŸÜÿß 14: 27"},
    {t:"ŸÖŸèŸÑŸíŸÇŸêŸäŸÜŸé ŸÉŸèŸÑŸéŸë ŸáŸéŸÖŸêŸëŸÉŸèŸÖŸí ÿπŸéŸÑŸéŸäŸíŸáŸêÿå ŸÑÿ£ŸéŸÜŸéŸëŸáŸè ŸáŸèŸàŸé ŸäŸéÿπŸíÿ™ŸéŸÜŸêŸä ÿ®ŸêŸÉŸèŸÖŸí.",r:"1 ÿ®ÿ∑ÿ±ÿ≥ 5: 7"},
    {t:"ÿ•ŸêŸÜŸí ŸÉŸéÿßŸÜŸé ÿßŸÑŸÑŸáŸè ŸÖŸéÿπŸéŸÜŸéÿßÿå ŸÅŸéŸÖŸéŸÜŸí ÿπŸéŸÑŸéŸäŸíŸÜŸéÿßÿü",r:"ÿ±ŸàŸÖŸäÿ© 8: 31"},
    {t:"ŸäŸèÿπŸíÿ∑ŸêŸä ÿßŸÑŸíŸÖŸèÿπŸíŸäŸêŸäŸé ŸÇŸèÿØŸíÿ±Ÿéÿ©Ÿãÿå ŸàŸéŸÑŸêÿπŸéÿØŸêŸäŸÖŸê ÿßŸÑŸíŸÇŸèŸàŸéŸëÿ©Ÿê ŸäŸèŸÉŸéÿ´ŸêŸëÿ±Ÿè ÿ¥ŸêÿØŸéŸëÿ©Ÿã.",r:"ÿ•ÿ¥ÿπŸäÿßÿ° 40: 29"},
    {t:"ÿßŸéŸÑÿ±ŸéŸëÿ®ŸèŸë ŸÜŸèŸàÿ±ŸêŸä ŸàŸéÿÆŸéŸÑÿßŸéÿµŸêŸäÿå ŸÖŸêŸÖŸéŸëŸÜŸí ÿ£ŸéÿÆŸéÿßŸÅŸèÿü ÿßŸéŸÑÿ±ŸéŸëÿ®ŸèŸë ÿ≠ŸêÿµŸíŸÜŸè ÿ≠ŸéŸäŸéÿßÿ™ŸêŸäÿå ŸÖŸêŸÖŸéŸëŸÜŸí ÿ£Ÿéÿ±Ÿíÿ™ŸéÿπŸêÿ®Ÿèÿü",r:"ŸÖÿ≤ŸÖŸàÿ± 27: 1"},
    {t:"ŸÑÿ£ŸéŸÜŸéŸë ŸÖŸéŸÑÿßŸéÿ¶ŸêŸÉŸéÿ™ŸéŸáŸè ŸäŸèŸàÿµŸêŸäŸáŸê ÿ®ŸêŸÉŸé ŸÑŸêŸÉŸéŸäŸí ŸäŸéÿ≠ŸíŸÅŸéÿ∏ŸèŸàŸÉŸé ŸÅŸêŸä ŸÉŸèŸÑŸêŸë ÿ∑Ÿèÿ±ŸèŸÇŸêŸÉŸé.",r:"ŸÖÿ≤ŸÖŸàÿ± 91: 11"},
    {t:"ÿßŸÑÿ±ŸéŸëÿ®ŸèŸë ŸäŸèÿ≠Ÿéÿßÿ±Ÿêÿ®Ÿè ÿπŸéŸÜŸíŸÉŸèŸÖŸí ŸàŸéÿ£ŸéŸÜŸíÿ™ŸèŸÖŸí ÿ™ŸéÿµŸíŸÖŸèÿ™ŸèŸàŸÜŸé.",r:"ÿÆÿ±Ÿàÿ¨ 14: 14"},
    {t:"ŸÖŸéÿ≠Ÿéÿ®ŸéŸëÿ©Ÿã ÿ£Ÿéÿ®ŸéÿØŸêŸäŸéŸëÿ©Ÿã ÿ£Ÿéÿ≠Ÿíÿ®Ÿéÿ®Ÿíÿ™ŸèŸÉŸéÿå ŸÖŸêŸÜŸí ÿ£Ÿéÿ¨ŸíŸÑŸê ÿ∞ŸÑŸêŸÉŸé ÿ£ŸéÿØŸéŸÖŸíÿ™Ÿè ŸÑŸéŸÉŸé ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéÿ©Ÿé.",r:"ÿ•ÿ±ŸÖŸäÿß 31: 3"},
    {t:"ŸÅŸêŸä ÿßŸÑŸíÿπŸéÿßŸÑŸéŸÖŸê ÿ≥ŸéŸäŸéŸÉŸèŸàŸÜŸè ŸÑŸéŸÉŸèŸÖŸí ÿ∂ŸêŸäŸÇŸåÿå ŸàŸéŸÑŸÉŸêŸÜŸí ÿ´ŸêŸÇŸèŸàÿß: ÿ£ŸéŸÜŸéÿß ŸÇŸéÿØŸí ÿ∫ŸéŸÑŸéÿ®Ÿíÿ™Ÿè ÿßŸÑŸíÿπŸéÿßŸÑŸéŸÖŸé.",r:"ŸäŸàÿ≠ŸÜÿß 16: 33"},
    {t:"ŸÜŸéÿ≠ŸíŸÜŸè ŸÜŸéÿπŸíŸÑŸéŸÖŸè ÿ£ŸéŸÜŸéŸë ŸÉŸèŸÑŸéŸë ÿßŸÑÿ£Ÿéÿ¥ŸíŸäŸéÿßÿ°Ÿê ÿ™ŸéÿπŸíŸÖŸéŸÑŸè ŸÖŸéÿπŸãÿß ŸÑŸêŸÑŸíÿÆŸéŸäŸíÿ±Ÿê ŸÑŸêŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ŸäŸèÿ≠Ÿêÿ®ŸèŸëŸàŸÜŸé ÿßŸÑŸÑŸáŸé.",r:"ÿ±ŸàŸÖŸäÿ© 8: 28"},
    {t:"ŸÇŸéÿ±ŸêŸäÿ®Ÿå ŸáŸèŸàŸé ÿßŸÑÿ±ŸéŸëÿ®ŸèŸë ŸÖŸêŸÜŸé ÿßŸÑŸíŸÖŸèŸÜŸíŸÉŸéÿ≥Ÿêÿ±ŸêŸä ÿßŸÑŸíŸÇŸèŸÑŸèŸàÿ®Ÿê.",r:"ŸÖÿ≤ŸÖŸàÿ± 34: 18"},
    {t:"ÿßŸêÿ™ŸéŸëŸÉŸêŸÑŸí ÿπŸéŸÑŸéŸâ ÿßŸÑÿ±ŸéŸëÿ®ŸêŸë ÿ®ŸêŸÉŸèŸÑŸêŸë ŸÇŸéŸÑŸíÿ®ŸêŸÉŸéÿå ŸàŸéÿπŸéŸÑŸéŸâ ŸÅŸéŸáŸíŸÖŸêŸÉŸé ŸÑÿßŸé ÿ™ŸéÿπŸíÿ™ŸéŸÖŸêÿØŸí.",r:"ÿ£ŸÖÿ´ÿßŸÑ 3: 5"},
    {t:"Ÿáÿ£ŸéŸÜŸéÿ∞Ÿéÿß ŸÇŸéÿØŸí ŸÜŸéŸÇŸéÿ¥Ÿíÿ™ŸèŸÉŸé ÿπŸéŸÑŸéŸâ ŸÉŸéŸÅŸéŸëŸäŸéŸë. ÿ£Ÿéÿ≥ŸíŸàŸéÿßÿ±ŸèŸÉŸé ÿ£ŸéŸÖŸéÿßŸÖŸêŸä ÿØŸéÿßÿ¶ŸêŸÖŸãÿß.",r:"ÿ•ÿ¥ÿπŸäÿßÿ° 49: 16"},
    {t:"ÿ≥Ÿêÿ±Ÿéÿßÿ¨Ÿå ŸÑŸêÿ±Ÿêÿ¨ŸíŸÑŸêŸä ŸÉŸéŸÑÿßŸéŸÖŸèŸÉŸé ŸàŸéŸÜŸèŸàÿ±Ÿå ŸÑŸêÿ≥Ÿéÿ®ŸêŸêŸäŸÑŸä.",r:"ŸÖÿ≤ŸÖŸàÿ± 119: 105"}
];

const prayers = [
    "Ÿäÿßÿ±ÿ® Ÿäÿ≥Ÿàÿπ ÿßŸÑŸÖÿ≥Ÿäÿ≠.. ÿßÿ±ÿ≠ŸÖŸÜŸä ÿ£ŸÜÿß ÿßŸÑÿÆÿßÿ∑ÿ¶",
    "Ÿäÿß ÿ±ÿ®Ÿä Ÿäÿ≥Ÿàÿπ ÿßŸÑŸÖÿ≥Ÿäÿ≠.. ÿ£ÿπŸÜŸëŸä",
    "Ÿäÿß ÿ±ÿ®Ÿä Ÿäÿ≥Ÿàÿπ ÿßŸÑŸÖÿ≥Ÿäÿ≠.. ÿßÿ≥ÿ™ÿ± ÿπŸÑŸäŸë",
    "Ÿäÿß ÿ±ÿ®Ÿä Ÿäÿ≥Ÿàÿπ ÿßŸÑŸÖÿ≥Ÿäÿ≠.. ÿ£ŸÜŸÇÿ∞ŸÜŸä",
    "Ÿäÿß ÿ±ÿ®Ÿä Ÿäÿ≥Ÿàÿπ ÿßŸÑŸÖÿ≥Ÿäÿ≠.. ÿ£ŸÖŸÑÿ£ ŸÇŸÑÿ®Ÿä ÿ®ÿ≠ÿ®ŸÉ"
];

let currentMood = "üòå";
let pCount = 0;
let quizTimerInterval;
let allQuizQuestions = [];
let selectedQuizStudentName = "";

// ===== THEME =====
function toggleTheme() {
    const body = document.body;
    const btn = document.getElementById('themeBtn');
    if (body.getAttribute('data-theme') === 'dark') {
        body.removeAttribute('data-theme');
        btn.innerText = "‚òÄÔ∏è ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÅÿßÿ™ÿ≠";
        localStorage.setItem('theme','light');
    } else {
        body.setAttribute('data-theme','dark');
        btn.innerText = "üåô ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿØÿßŸÉŸÜ";
        localStorage.setItem('theme','dark');
    }
}

// ===== LOGIN =====
function checkAccess() {
    if (document.getElementById('passInputUser').value === "jesus") {
        localStorage.setItem('session_login_time', Date.now());
        localStorage.setItem('session_login_type', 'user');
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        startApp();
        showRandomVerse();
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        
        // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ¢ÿÆÿ± ÿßÿ≥ŸÖ ŸÖÿ≠ŸÅŸàÿ∏
        setTimeout(() => {
            const savedUserName = localStorage.getItem('selected_user_name');
            if (savedUserName) {
                console.log('üîî ÿ®ÿØÿ° ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', savedUserName);
                startPendingConfirmationsListener(savedUserName);
            }
        }, 1000);
    } else { alert("ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ± ÿÆÿ∑ÿ£ ‚ùå"); }
}

function openAdmin() {
    const p = prompt("ŸÉŸÑŸÖÿ© ÿ≥ÿ± ÿßŸÑÿÆÿØÿßŸÖ:");
    if (p === "admin123") {
        localStorage.setItem('session_login_time', Date.now());
        localStorage.setItem('session_login_type', 'admin');
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'block';
        loadAdminData();
    }
}

// ===== ADMIN =====
function loadAdminData() {
    db.ref("prayer_reports").limitToLast(10).on("value", snap => {
        const list = document.getElementById('prayerResultsList');
        list.innerHTML = "";
        snap.forEach(child => {
            const d = child.val();
            list.innerHTML += `<div class="prayer-result-item"><b>${d.makhdom}:</b> ÿµŸÑŸâ ${d.duration} <br><small>${d.time}</small></div>`;
        });
    });
    
    // ÿ™ÿ≠ŸÖŸäŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑÿ™ÿ¥ÿ¨Ÿäÿπ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
    db.ref("prayer_encouragement").once("value", snap => {
        const encouragement = snap.val();
        if (encouragement) {
            document.getElementById('prayerEncouragementInput').value = encouragement;
        }
    });
}

function updateAdminAlert() {
    const val = document.getElementById('newAdminAlert').value;
    db.ref("admin_announcement").set(val);
    alert("ÿ™ŸÖ ÿßŸÑŸÜÿ¥ÿ± ‚úÖ");
}

function updatePrayerEncouragement() {
    const val = document.getElementById('prayerEncouragementInput').value.trim();
    if (!val) return alert("ÿßŸÉÿ™ÿ® ŸÉŸÑŸÖÿ© ÿ™ÿ¥ÿ¨Ÿäÿπ!");
    db.ref("prayer_encouragement").set(val);
    alert("ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÉŸÑŸÖÿ© ÿ®ŸÜÿ¨ÿßÿ≠! üíù");
}

// ===== VERSE =====
function showRandomVerse() {
    const now = Date.now();
    const savedVerse = localStorage.getItem('daily_verse_data');
    const twelveHours = 12 * 60 * 60 * 1000; // 12 ÿ≥ÿßÿπÿ© ÿ®ÿßŸÑŸÖŸäŸÑŸä ÿ´ÿßŸÜŸäÿ©
    
    if (savedVerse) {
        const verseData = JSON.parse(savedVerse);
        const timePassed = now - verseData.timestamp;
        
        // ŸÑŸà ŸÖÿ± ÿ£ŸÇŸÑ ŸÖŸÜ 12 ÿ≥ÿßÿπÿ©ÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ¢Ÿäÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
        if (timePassed < twelveHours) {
            document.getElementById('dailyVerse').innerText = `"${verseData.text}"`;
            document.getElementById('verseRef').innerText = `‚úù ${verseData.ref}`;
            return;
        }
    }
    
    // ŸÑŸà ŸÖŸÅŸäÿ¥ ÿ¢Ÿäÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ£Ÿà ÿπÿØŸâ 12 ÿ≥ÿßÿπÿ©ÿå ÿßÿÆÿ™ÿ± ÿ¢Ÿäÿ© ÿ¨ÿØŸäÿØÿ©
    const v = bibleVerses[Math.floor(Math.random() * bibleVerses.length)];
    document.getElementById('dailyVerse').innerText = `"${v.t}"`;
    document.getElementById('verseRef').innerText = `‚úù ${v.r}`;
    
    // ÿßÿ≠ŸÅÿ∏ ÿßŸÑÿ¢Ÿäÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÖÿπ ÿßŸÑŸàŸÇÿ™
    localStorage.setItem('daily_verse_data', JSON.stringify({
        text: v.t,
        ref: v.r,
        timestamp: now
    }));
}

// ===== START APP =====
function startApp() {
    if (localStorage.getItem('chat_user_name')) document.getElementById('userName').value = localStorage.getItem('chat_user_name');

    db.ref("admin_announcement").on("value", snap => {
        const text = snap.val();
        document.getElementById('adminAlert').style.display = (text && text.trim() !== "") ? 'block' : 'none';
        document.getElementById('alertText').innerText = text;
    });

    // ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ™ÿ¥ÿ¨Ÿäÿπ ÿπŸÜ ÿßŸÑÿµŸÑÿßÿ©
    db.ref("prayer_encouragement").on("value", snap => {
        const encouragement = snap.val();
        const box = document.getElementById('prayerEncouragementBox');
        const text = document.getElementById('prayerEncouragementText');
        
        if (encouragement && encouragement.trim() !== "") {
            text.innerText = encouragement;
            box.style.display = 'block';
        } else {
            box.style.display = 'none';
        }
    });

    db.ref("settings/quizEnabled").on("value", snap => {
        document.getElementById('quizSection').style.display = snap.val() === true ? "block" : "none";
    });

    db.ref("settings/libVisible").on("value", snap => {
        document.getElementById('librarySection').style.display = snap.val() !== false ? "block" : "none";
    });

    db.ref("media_library").on("value", snap => {
        const d = snap.val();
        if (d) {
            document.getElementById('hymnLink').href = d.hymn || "#";
            document.getElementById('pdfLink').href = d.pdf || "#";
            document.getElementById('videoLink').href = d.video || "#";
        }
    });

    listenToAdminPrayers();

    db.ref("points_data").on("value", snap => {
        const data = snap.val();
        if (data) {
            localStorage.setItem('offline_points_data', JSON.stringify(data));
            updateLeaderboardUI(data);
        }
    });

    db.ref("chat").limitToLast(15).on("value", snap => {
        const box = document.getElementById('chatBox');
        box.innerHTML = "";
        snap.forEach(c => {
            const msg = c.val();
            const isAdmin = msg.sender.includes("ÿ£/") || msg.sender.includes("ÿ£ŸÖŸäŸÜ");
            box.innerHTML += `<div class="chat-msg ${isAdmin ? 'admin-msg' : ''}"><b>${msg.sender}:</b> ${msg.text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    });

    db.ref("psychology/private_chats/" + psySessionID).on("value", snap => {
        const box = document.getElementById('psyLocalChat');
        box.innerHTML = "";
        snap.forEach(m => {
            const msg = m.val();
            box.innerHTML += `<div style="margin-bottom:4px; color:${msg.sender === "ÿ£ŸÜÿß" ? "#ec4899" : "#fbbf24"};"><b>${msg.sender}:</b> ${msg.text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    });
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ÿ¥ÿ¨Ÿäÿπ
    setTimeout(() => {
        checkEncouragementMessages();
    }, 2000);
}

// ===== LEADERBOARD =====
function updateLeaderboardUI(data) {
    const selectQuiz = document.getElementById('userNameListQuiz');
    const selectPrayer = document.getElementById('prayerUserName');
    const selectAttendance = document.getElementById('attendanceNameSelect');
    const selectName = document.getElementById('nameSelect');
    const list = document.getElementById('leaderboard');
    if (!list) return;

    const curQ = selectQuiz ? selectQuiz.value : "";
    const curP = selectPrayer ? selectPrayer.value : "";
    const curA = selectAttendance ? selectAttendance.value : "";
    const curN = selectName ? selectName.value : "";

    if (selectQuiz) selectQuiz.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ --</option>';
    if (selectPrayer) selectPrayer.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ ÿßŸÑÿ´ŸÑÿßÿ´Ÿä --</option>';
    if (selectAttendance) selectAttendance.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ --</option>';
    if (selectName) selectName.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ ÿßŸÑÿ´ŸÑÿßÿ´Ÿä --</option>';

    list.innerHTML = "";
    Object.values(data).sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
        if (selectQuiz) selectQuiz.innerHTML += `<option value="${p.name}">${p.name}</option>`;
        if (selectPrayer) selectPrayer.innerHTML += `<option value="${p.name}">${p.name}</option>`;
        if (selectAttendance) selectAttendance.innerHTML += `<option value="${p.name}">${p.name}</option>`;
        if (selectName) selectName.innerHTML += `<option value="${p.name}">${p.name}</option>`;
    });

    if (selectQuiz) selectQuiz.value = curQ;
    if (selectPrayer) selectPrayer.value = curP;
    if (selectAttendance) {
        selectAttendance.value = curA;
        // ÿ•ÿ∂ÿßŸÅÿ© event listener ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ
        selectAttendance.addEventListener('change', function() {
            if (this.value) {
                setTimeout(() => checkPendingConfirmations(), 500);
                // ÿ®ÿØÿ° ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±ÿ©
                startPendingConfirmationsListener(this.value);
            }
        });
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑŸÅŸàÿ±Ÿä ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿßÿ≥ŸÖ ŸÖÿ≠ŸÅŸàÿ∏
        if (curA) {
            setTimeout(() => {
                checkPendingConfirmations();
                startPendingConfirmationsListener(curA);
            }, 1000);
        }
    }
    if (selectName) selectName.value = curN;

    Object.values(data).sort((a,b) => b.score - a.score).forEach(p => {
        // Get breakdown from Firebase instead of localStorage
        const breakdown = p.breakdown || {};
        const quizPoints = breakdown.quiz || 0;
        const prayerPoints = breakdown.prayer || 0;
        const attendancePoints = breakdown.attendance || 0;
        
        // Calculate max for scaling
        const maxPoints = Math.max(quizPoints, prayerPoints, attendancePoints, 1);
        const quizHeight = (quizPoints / maxPoints) * 100;
        const prayerHeight = (prayerPoints / maxPoints) * 100;
        const attendanceHeight = (attendancePoints / maxPoints) * 100;
        
        let clr = p.score >= 70 ? 'bg-high' : (p.score >= 40 ? 'bg-mid' : 'bg-low');
        
        list.innerHTML += `<div class="card" onclick="toggleCardView(this)">
            <div class="card-default-view">
                <div class="bar-wrap"><div class="bar ${clr}" style="height:${Math.min(p.score,100)}%"></div></div>
                <div style="font-weight:800; color:#fbbf24; font-size:15px;">${p.score}</div>
                <div style="font-size:11px; color:#cbd5e0;">${p.name}</div>
            </div>
            
            <div class="card-details-view">
                <div class="mini-bars-container">
                    <div class="mini-bar-col">
                        <div class="mini-bar quiz" style="height:${quizHeight}%"></div>
                        <div class="mini-bar-label">üìñ</div>
                        <div class="mini-bar-value">${quizPoints}</div>
                    </div>
                    <div class="mini-bar-col">
                        <div class="mini-bar prayer" style="height:${prayerHeight}%"></div>
                        <div class="mini-bar-label">üôè</div>
                        <div class="mini-bar-value">${prayerPoints}</div>
                    </div>
                    <div class="mini-bar-col">
                        <div class="mini-bar attendance" style="height:${attendanceHeight}%"></div>
                        <div class="mini-bar-label">‚õ™</div>
                        <div class="mini-bar-value">${attendancePoints}</div>
                    </div>
                </div>
                <div style="font-weight:800; color:#fbbf24; font-size:15px; margin-top:4px;">${p.score}</div>
                <div style="font-size:11px; color:#cbd5e0;">${p.name}</div>
            </div>
        </div>`;
    });
}

// ===== SHOW POINTS BREAKDOWN =====
function showPointsBreakdown(name, totalScore) {
    // Get breakdown from Firebase
    db.ref("points_data").once("value", snap => {
        let breakdown = {};
        snap.forEach(child => {
            if (child.val().name === name) {
                breakdown = child.val().breakdown || {};
            }
        });
        
        const quizPoints = breakdown.quiz || 0;
        const prayerPoints = breakdown.prayer || 0;
        const attendancePoints = breakdown.attendance || 0;
        
        // Calculate max for scaling
        const maxPoints = Math.max(quizPoints, prayerPoints, attendancePoints, 1);
        
        // Calculate heights as percentages
        const quizHeight = (quizPoints / maxPoints) * 100;
        const prayerHeight = (prayerPoints / maxPoints) * 100;
        const attendanceHeight = (attendancePoints / maxPoints) * 100;
        
        const modal = document.getElementById('pointsModal');
        document.getElementById('modalName').textContent = name;
        document.getElementById('modalTotalScore').textContent = totalScore;
        
        // Set bar heights with animation
        setTimeout(() => {
            document.getElementById('quizBar').style.height = quizHeight + '%';
            document.getElementById('prayerBar').style.height = prayerHeight + '%';
            document.getElementById('attendanceBar').style.height = attendanceHeight + '%';
        }, 100);
        
        // Update values
        document.getElementById('quizPoints').textContent = quizPoints;
        document.getElementById('prayerPoints').textContent = prayerPoints;
        document.getElementById('attendancePoints').textContent = attendancePoints;
        
        modal.style.display = 'flex';
    });
}

function closePointsModal() {
    const modal = document.getElementById('pointsModal');
    modal.style.display = 'none';
    
    // Reset heights
    document.getElementById('quizBar').style.height = '0%';
    document.getElementById('prayerBar').style.height = '0%';
    document.getElementById('attendanceBar').style.height = '0%';
}


// ===== ADMIN PRAYER HINTS =====
function listenToAdminPrayers() {
    db.ref("admin_prayer_hints").on("value", (snapshot) => {
        const data = snapshot.val() || {};
        document.getElementById('admin_agpeya_hint').innerText = data.agpeya || "ÿµŸÑŸêŸë ŸÖÿ≤ŸÖŸàÿ±ÿßŸã ŸÖŸÜ ÿßŸÑÿ£ÿ¨ÿ®Ÿäÿ©..";
        document.getElementById('admin_thanks_hint').innerText = data.thanks || "ÿßÿ¥ŸÉÿ± ÿßŸÑŸÑŸá ÿπŸÑŸâ ŸÉŸÑ ÿ≠ÿßŸÑ..";
        document.getElementById('admin_forgive_hint').innerText = data.forgive || "ÿßÿ∑ŸÑÿ® ÿ™Ÿàÿ®ÿ© ŸÜŸÇŸäÿ©..";
        document.getElementById('admin_heart_hint').innerText = data.heart || "ÿßÿ¨ÿπŸÑ ŸÇŸÑÿ®ŸÉ Ÿäÿ¥ÿ™ÿπŸÑ ÿ®ÿ≠ÿ® ÿßŸÑŸÖÿ≥Ÿäÿ≠..";
        document.getElementById('admin_union_hint').innerText = data.union || "ÿßÿ∑ŸÑÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ Ÿàÿßÿ≠ÿØÿßŸã ŸÖÿπŸá..";
        document.getElementById('admin_verse_hint').innerText = data.verse || "ÿ¥ÿßÿ±ŸÉŸÜÿß ÿ¢Ÿäÿ© ŸÑŸÖÿ≥ÿ™ŸÉ ÿßŸÑŸäŸàŸÖ..";
    });
}

// ===== MUTUAL PRAYER (ALTAR) =====
async function sendMutualPrayer() {
    const name = document.getElementById('prayerUserName').value;
    const durationValue = document.getElementById('prayerDuration').value.trim();
    const agpeya = document.getElementById('agpeyaText').value.trim();
    const thanks = document.getElementById('prayThank').value.trim();
    const forgive = document.getElementById('prayForgive').value.trim();
    const verse = document.getElementById('bibleVerseText').value.trim();

    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ≥ŸÖ
    if (!name) return alert("ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ ÿßŸÑÿ´ŸÑÿßÿ´Ÿä ‚ù§Ô∏è");
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿØÿ©
    if (!durationValue) return alert("ÿ≠ÿØÿØ ŸÖÿØÿ© ÿßŸÑÿµŸÑÿßÿ© ÿ®ÿßŸÑÿØŸÇÿßÿ¶ŸÇ ‚è±Ô∏è");
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ© ÿßŸÑÿ£ÿ¨ÿ®Ÿäÿ©
    if (!agpeya) return alert("ÿßŸÉÿ™ÿ® ÿµŸÑÿßÿ© ŸÖŸÜ ÿßŸÑÿ£ÿ¨ÿ®Ÿäÿ© üìñ");
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ© ÿßŸÑÿ¥ŸÉÿ±
    if (!thanks) return alert("ÿßŸÉÿ™ÿ® ÿ¥ŸÉÿ±ŸÉ ŸÑÿ±ÿ®ŸÜÿß üôè");
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ© ÿßŸÑŸÖÿ∫ŸÅÿ±ÿ©
    if (!forgive) return alert("ÿßŸÉÿ™ÿ® ÿ∑ŸÑÿ® ÿßŸÑŸÖÿ∫ŸÅÿ±ÿ© ŸàÿßŸÑÿÆÿ∂Ÿàÿπ üíô");
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ¢Ÿäÿ©
    if (!verse) return alert("ÿßŸÉÿ™ÿ® ÿ¢Ÿäÿ© ŸÖŸÜ ÿßŸÑŸÉÿ™ÿßÿ® ÿßŸÑŸÖŸÇÿØÿ≥ üìú");

    const todayDate = new Date().toISOString().split('T')[0]; // ŸÅŸàÿ±ŸÖÿßÿ™ ŸÖŸàÿ≠ÿØ YYYY-MM-DD
    const userId = getUserId(name);

    // ========== ÿßŸÑÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firebase ÿ£ŸàŸÑÿßŸã ==========
    try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ¢ÿÆÿ± ÿ™ÿßÿ±ŸäÿÆ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÅŸä Firebase
        const userLastSubmitRef = db.ref(`users/${userId}/last_prayer_submit_date`);
        const lastSubmitSnapshot = await userLastSubmitRef.once('value');
        const lastSubmitDate = lastSubmitSnapshot.val();
        
        if (lastSubmitDate === todayDate) {
            return alert("ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖÿ∞ÿ®ÿ≠ ÿßŸÑŸäŸàŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÖŸÜ ÿ¨Ÿáÿßÿ≤ ÿ¢ÿÆÿ±! ŸÜŸÜÿ™ÿ∏ÿ±ŸÉ ÿ∫ÿØÿßŸã ÿ®ŸÉŸÑ ÿ≠ÿ® ‚ù§Ô∏è");
        }

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑŸÖÿ≤ÿØŸàÿ¨: ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑŸäŸàŸÖ
        const todayReportsSnapshot = await db.ref("prayer_reports")
            .orderByChild('makhdom')
            .equalTo(name)
            .once('value');
        
        if (todayReportsSnapshot.exists()) {
            let alreadySubmittedToday = false;
            todayReportsSnapshot.forEach(child => {
                const reportData = child.val();
                if (reportData.submitDate === todayDate) {
                    alreadySubmittedToday = true;
                }
            });
            
            if (alreadySubmittedToday) {
                return alert("ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖÿ∞ÿ®ÿ≠ ÿßŸÑŸäŸàŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ! ŸÜŸÜÿ™ÿ∏ÿ±ŸÉ ÿ∫ÿØÿßŸã ÿ®ŸÉŸÑ ÿ≠ÿ® ‚ù§Ô∏è");
            }
        }

        // ========== ŸÉŸÑ ÿ≠ÿßÿ¨ÿ© ÿ™ŸÖÿßŸÖÿå ŸÜÿ®ÿØÿ£ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ==========
        const report = {
            makhdom: name,
            userId: userId,
            submitDate: todayDate,
            time: new Date().toLocaleString(),
            duration: durationValue + " ÿØŸÇŸäŸÇÿ©",
            metania: { done: document.getElementById('metaniaDone').checked, count: document.getElementById('metaniaCount').value || 0 },
            agpeya: agpeya,
            thanks: thanks,
            forgive: forgive,
            heart: document.getElementById('prayHeart').value,
            union: document.getElementById('prayUnion').value,
            verse: verse
        };

        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
        await db.ref("prayer_reports").push(report);
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿßÿ±ŸäÿÆ ÿ¢ÿÆÿ± ÿ•ÿ±ÿ≥ÿßŸÑ ŸÅŸä Firebase (ÿßŸÑÿ≠ŸÖÿßŸäÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©)
        await userLastSubmitRef.set(todayDate);
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜŸÇÿßÿ∑
        const pointsSnapshot = await db.ref("points_data").once("value");
        pointsSnapshot.forEach(child => {
            if (child.val().name === name) {
                const currentScore = child.val().score || 0;
                const currentBreakdown = child.val().breakdown || {};
                
                const newBreakdown = {
                    quiz: currentBreakdown.quiz || 0,
                    prayer: (currentBreakdown.prayer || 0) + 5,
                    attendance: currentBreakdown.attendance || 0
                };
                
                child.ref.update({ 
                    score: currentScore + 5,
                    breakdown: newBreakdown
                });
            }
        });
        
        // ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ™ÿßŸÑŸäÿ©
        trackPrayerStreak(name);
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage ŸÉŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
        localStorage.setItem('last_prayer_submit_date', todayDate);
        
        // ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠
        alert("ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸÜÿ¨ÿßÿ≠ Ÿäÿß " + name + "! ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© Ÿ• ÿØÿ±ÿ¨ÿßÿ™ ŸÑŸÖŸäÿ≤ÿßŸÜŸÉ üéÅ");
        
        // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ≠ŸÇŸàŸÑ
        document.querySelectorAll('#mutualPrayerSection textarea, #mutualPrayerSection input:not([type="checkbox"])').forEach(el => el.value = "");
        document.getElementById('metaniaDone').checked = false;
        
        // ÿßÿ≠ÿ™ŸÅÿßŸÑ
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.8 } });
        
    } catch (error) {
        console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖÿ∞ÿ®ÿ≠:", error);
        alert("ÿ≠ÿµŸÑ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ. ÿ≠ÿßŸàŸÑ ÿ™ÿßŸÜŸä ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ! üôè");
    }
}

// ========== ÿØÿßŸÑÿ© ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ™ÿßŸÑŸäÿ© ŸÑŸÑÿµŸÑÿßÿ© ==========
function trackPrayerStreak(userName) {
    const userId = getUserId(userName);
    const todayDate = new Date().toISOString().split('T')[0]; // ŸÅŸàÿ±ŸÖÿßÿ™ ŸÖŸàÿ≠ÿØ
    const yesterdayDate = new Date(Date.now() - 86400000).toISOString().split('T')[0]; // ŸÅŸàÿ±ŸÖÿßÿ™ ŸÖŸàÿ≠ÿØ
    
    // ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ™ÿßÿ®ÿπ ŸÖŸÜ Firebase
    db.ref(`users/${userId}/prayer_streak`).once('value', snapshot => {
        let streakData = snapshot.val() || { 
            currentStreak: 0, 
            longestStreak: 0, 
            lastPrayerDate: null 
        };
        
        // ŸÅÿ≠ÿµ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿµŸÑÿßÿ© ŸÖÿ™ÿ™ÿßŸÑŸäÿ©
        if (streakData.lastPrayerDate === yesterdayDate) {
            // ŸäŸàŸÖ ŸÖÿ™ÿ™ÿßŸÑŸä
            streakData.currentStreak++;
        } else if (streakData.lastPrayerDate !== todayDate) {
            // ÿ®ÿØÿßŸäÿ© ÿ¨ÿØŸäÿØÿ© ÿ£Ÿà ÿßŸÜŸÇÿ∑ÿßÿπ
            streakData.currentStreak = 1;
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ£ÿ∑ŸàŸÑ ÿ≥ŸÑÿ≥ŸÑÿ©
        if (streakData.currentStreak > streakData.longestStreak) {
            streakData.longestStreak = streakData.currentStreak;
        }
        
        streakData.lastPrayerDate = todayDate;
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
        db.ref(`users/${userId}/prayer_streak`).set(streakData);
        
        // ÿ•ÿπÿ∑ÿßÿ° ÿ¥ÿßÿ±ÿßÿ™ Ÿàÿ™ÿ¥ÿ¨Ÿäÿπ
        checkPrayerBadges(userName, streakData.currentStreak);
    });
}

// ========== ŸÅÿ≠ÿµ Ÿàÿ•ÿπÿ∑ÿßÿ° ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑÿµŸÑÿßÿ© ==========
function checkPrayerBadges(userName, streak) {
    const userId = getUserId(userName);
    
    // ÿ¥ÿßÿ±ÿßÿ™ ÿ≠ÿ≥ÿ® ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ™ÿßŸÑŸäÿ©
    const badges = [
        { days: 3, id: 'prayer-3days', title: 'ŸÖÿµŸÑŸä 3 ÿ£ŸäÿßŸÖ', icon: 'üôè', type: 'bronze', message: 'ÿ±ÿßÿ¶ÿπ! 3 ÿ£ŸäÿßŸÖ ŸÖÿ™ÿ™ÿßŸÑŸäÿ© ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ©! üôè' },
        { days: 7, id: 'prayer-week', title: 'ÿ£ÿ≥ÿ®Ÿàÿπ ŸÉÿßŸÖŸÑ', icon: '‚≠ê', type: 'silver', message: 'ŸÖÿ®ÿ±ŸàŸÉ! ÿ£ÿ≥ÿ®Ÿàÿπ ŸÉÿßŸÖŸÑ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ©! ‚≠ê' },
        { days: 14, id: 'prayer-2weeks', title: 'ÿ£ÿ≥ÿ®ŸàÿπŸäŸÜ ŸÖÿ™ŸàÿßÿµŸÑŸäŸÜ', icon: 'üåü', type: 'silver', message: 'ŸÖŸÖÿ™ÿßÿ≤! ÿ£ÿ≥ÿ®ŸàÿπŸäŸÜ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±ÿ©! üåü' },
        { days: 21, id: 'prayer-21days', title: 'ŸÖÿ≠ÿßÿ±ÿ® ÿµŸÑÿßÿ©', icon: 'üí™', type: 'gold', message: 'ÿ£ŸÜÿ™ ŸÖÿ≠ÿßÿ±ÿ® ÿ≠ŸÇŸäŸÇŸä! 21 ŸäŸàŸÖ ÿµŸÑÿßÿ©! üí™' },
        { days: 30, id: 'prayer-month', title: 'ÿ¥Ÿáÿ± ŸÉÿßŸÖŸÑ', icon: 'üèÜ', type: 'gold', message: 'ÿ•ŸÜÿ¨ÿßÿ≤ ÿπÿ∏ŸäŸÖ! ÿ¥Ÿáÿ± ŸÉÿßŸÖŸÑ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ©! üèÜ' },
        { days: 50, id: 'prayer-50days', title: 'ÿßŸÑÿÆŸÖÿ≥ŸäŸÜ ÿßŸÑŸÖŸÇÿØÿ≥ÿ©', icon: '‚ú®', type: 'gold', message: 'ŸÖÿ∞ŸáŸÑ! 50 ŸäŸàŸÖ ŸÖÿ™ÿ™ÿßŸÑŸä! ‚ú®' },
        { days: 100, id: 'prayer-100days', title: 'ŸÇÿØŸäÿ≥ ÿßŸÑÿµŸÑÿßÿ©', icon: 'üëë', type: 'gold', message: 'ÿ£ŸÜÿ™ ŸÇÿØŸäÿ≥ ÿ≠ŸÇŸäŸÇŸä! 100 ŸäŸàŸÖ ÿµŸÑÿßÿ©! üëë' }
    ];
    
    badges.forEach(badge => {
        if (streak === badge.days) {
            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ¥ÿßÿ±ÿ©
            addBadgeForUser(userId, badge.id, badge.title, badge.type, badge.icon);
            
            // ÿ•ÿ∂ÿßŸÅÿ© XP ŸÖŸÉÿßŸÅÿ£ÿ©
            const bonusXP = badge.days * 2;
            addXPForUser(userId, bonusXP, `${badge.days} ŸäŸàŸÖ ÿµŸÑÿßÿ© ŸÖÿ™ÿ™ÿßŸÑŸäÿ©`);
            
            // ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ¥ÿ¨Ÿäÿπ ŸÖÿÆÿµÿµÿ©
            showPrayerEncouragement(userName, badge.message, streak);
            
            // ŸÉŸàŸÜŸÅŸäÿ™Ÿä ÿÆÿßÿµ
            if (typeof confetti !== 'undefined') {
                confetti({
                    particleCount: 200,
                    spread: 100,
                    origin: { y: 0.6 },
                    colors: ['#fbbf24', '#f59e0b', '#d97706']
                });
            }
        }
    });
    
    // ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ™ÿ¥ÿ¨Ÿäÿπ ŸäŸàŸÖŸäÿ©
    if (streak > 0 && streak < 3) {
        setTimeout(() => {
            showPrayerEncouragement(userName, `ŸäŸàŸÖ ${streak} ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ©! ÿßÿ≥ÿ™ŸÖÿ± Ÿäÿß ${userName.split(' ')[0]}! üí™`, streak);
        }, 2000);
    }
}

// ========== ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ¥ÿ¨Ÿäÿπ ŸÑŸÑÿµŸÑÿßÿ© ==========
function showPrayerEncouragement(userName, message, streak) {
    const encouragementHTML = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: linear-gradient(135deg, #667eea, #764ba2); 
                    padding: 35px; border-radius: 30px; 
                    box-shadow: 0 20px 60px rgba(0,0,0,0.4); 
                    z-index: 10001; max-width: 90%; width: 400px;
                    animation: popupAppear 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);"
             id="prayerEncouragementPopup">
            <div style="font-size: 64px; text-align: center; margin-bottom: 15px; animation: bounce 1s infinite;">üî•</div>
            <div style="font-size: 24px; font-weight: 900; color: white; text-align: center; margin-bottom: 15px; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                ${streak} ${streak === 1 ? 'ŸäŸàŸÖ' : streak === 2 ? 'ŸäŸàŸÖÿßŸÜ' : 'ÿ£ŸäÿßŸÖ'} ŸÖÿ™ÿ™ÿßŸÑŸäÿ©! üéâ
            </div>
            <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); 
                        padding: 20px; border-radius: 20px; color: white; 
                        font-size: 16px; line-height: 1.8; margin: 15px 0; 
                        border: 2px solid rgba(255,255,255,0.2); text-align: center;">
                ${message}
            </div>
            <div style="color: rgba(255,255,255,0.9); font-size: 14px; text-align: center; margin-top: 15px;">
                "ÿµŸéŸÑŸèŸëŸàÿß ÿ®ŸêŸÑÿßŸé ÿßŸÜŸíŸÇŸêÿ∑ŸéÿßÿπŸç" - 1 ÿ™ÿ≥ÿßŸÑŸàŸÜŸäŸÉŸä 5: 17
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closePrayerEncouragement()" 
                        style="background: rgba(255,255,255,0.3); color: white; border: none; 
                               padding: 12px 30px; border-radius: 30px; font-weight: 800; 
                               cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 15px; 
                               transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá! üôè
                </button>
            </div>
        </div>
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); 
                    backdrop-filter: blur(5px); z-index: 10000;" 
             id="prayerEncouragementOverlay" 
             onclick="closePrayerEncouragement()"></div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', encouragementHTML);
}

function closePrayerEncouragement() {
    const popup = document.getElementById('prayerEncouragementPopup');
    const overlay = document.getElementById('prayerEncouragementOverlay');
    if (popup) popup.remove();
    if (overlay) overlay.remove();
}

// ===== QUIZ =====

// ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸàÿßŸÑÿ≠ŸÅÿ∏ ŸÑŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
async function checkIfQuizSubmitted(quizId) {
    if (!currentUserId) {
        console.error('User ID not found');
        return false;
    }
    
    try {
        const snapshot = await db.ref(`quiz_submissions/${quizId}/${currentUserId}`).once('value');
        return snapshot.exists();
    } catch (error) {
        console.error('Error checking quiz submission:', error);
        return false;
    }
}

async function saveQuizSubmission(quizId, answers, score, max, finalPoints) {
    if (!currentUserId || !currentUserName) {
        alert('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
        return false;
    }
    
    try {
        const todayDate = new Date().toISOString().split('T')[0];
        await db.ref(`quiz_submissions/${quizId}/${currentUserId}`).set({
            userName: currentUserName,
            userId: currentUserId,
            submitDate: todayDate,
            answers: answers,
            score: score,
            max: max,
            finalPoints: finalPoints,
            timestamp: Date.now(),
            submittedAt: new Date().toLocaleString()
        });
        return true;
    } catch (error) {
        console.error('Error saving quiz submission:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
        return false;
    }
}

async function showAlreadySubmittedQuizMessage(quizId) {
    try {
        const snapshot = await db.ref(`quiz_submissions/${quizId}/${currentUserId}`).once('value');
        if (snapshot.exists()) {
            const data = snapshot.val();
            alert(`‚õî ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ≠ŸÑ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© ŸÖÿ≥ÿ®ŸÇÿßŸã!\n\nüìä ÿØÿ±ÿ¨ÿ™ŸÉ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©: ${data.score}/${data.max}\nüéØ ÿßŸÑŸÜŸÇÿßÿ∑: ${data.finalPoints}\n\n‚ùå ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ≠ŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.`);
        } else {
            alert('‚õî ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ≠ŸÑ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© ŸÖÿ≥ÿ®ŸÇÿßŸã!\n\n‚ùå ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ≠ŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
        }
    } catch (error) {
        alert('‚õî ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ≠ŸÑ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© ŸÖÿ≥ÿ®ŸÇÿßŸã!\n\n‚ùå ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ≠ŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
    }
}

async function startQuiz() {
    selectedQuizStudentName = document.getElementById('userNameListQuiz').value;
    if (!selectedQuizStudentName) return alert("ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã");
    
    // ÿ™ÿ≠ÿØŸäÿØ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
    const currentQuizId = 'current_quiz_2026';
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ŸÑ ÿßŸÑŸÖÿ≥ÿ®ŸÇ ŸÅŸä Firebase
    const alreadySubmitted = await checkIfQuizSubmitted(currentQuizId);
    
    if (alreadySubmitted) {
        await showAlreadySubmittedQuizMessage(currentQuizId);
        localStorage.setItem('quiz_bound_name', selectedQuizStudentName);
        showFinishedStatus();
        return;
    }
    
    const boundName = localStorage.getItem('quiz_bound_name');
    if (boundName && boundName !== selectedQuizStudentName) {
        return alert(`Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÖÿ≥ÿ¨ŸÑ ÿ®ÿßÿ≥ŸÖ (${boundName}). ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ≠ŸÑ ŸÑÿ≤ŸÖŸäŸÑ ÿ¢ÿÆÿ±!`);
    }
    db.ref("bible_quiz/submissions").orderByChild("userName").equalTo(selectedQuizStudentName).once("value", snap => {
        if (snap.exists()) {
            alert("ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ≠ŸÑ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© ŸÖÿ≥ÿ®ŸÇÿßŸã!");
            localStorage.setItem('quiz_bound_name', selectedQuizStudentName);
            showFinishedStatus();
        } else {
            localStorage.setItem('quiz_bound_name', selectedQuizStudentName);
            loadQuiz();
        }
    });
}

function loadQuiz() {
    db.ref("settings/quizTimer").once("value", snapTime => {
        let timerMinutes = snapTime.val() || 5;
        let durationInSeconds = timerMinutes * 60;
        db.ref("bible_quiz/questions").once("value", snapQ => {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = ""; allQuizQuestions = []; let i = 0;
            snapQ.forEach(child => {
                const q = child.val(); allQuizQuestions.push({...q, id: child.key});
                let html = `<div class="question-card"><p><b>ÿ≥${i+1}: ${q.text}</b> <small style="color:var(--text-secondary);">(${q.points||1} ÿØÿ±ÿ¨ÿ©)</small></p>`;
                if (q.type === 'choice' || q.type === 'truefalse') {
                    (q.options || []).forEach(opt => { if(opt) html += `<label class="option-label"><input type="radio" name="quiz_q_${i}" value="${opt}"> ${opt}</label>`; });
                } else if (q.type === 'essay') {
                    html += `<textarea id="quiz_ans_${i}" onpaste="return false;" oninput="updateCharCount(${i})" placeholder="ÿßŸÉÿ™ÿ® ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ ŸáŸÜÿß..." style="height:100px; width:100%; border-radius:12px;"></textarea><div style="text-align:left; font-size:12px; color:var(--text-secondary);"><span id="charCount_${i}">0</span> ÿ≠ÿ±ŸÅ</div>`;
                } else {
                    html += `<input type="text" id="quiz_ans_${i}" placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©...">`;
                }
                container.innerHTML += html + `</div>`; i++;
            });
            document.getElementById('quizSetup').style.display = 'none';
            document.getElementById('quizArea').style.display = 'block';
            startCountdown(durationInSeconds);
        });
    });
}

function startCountdown(duration) {
    let secondsLeft = duration;
    if (quizTimerInterval) clearInterval(quizTimerInterval);
    quizTimerInterval = setInterval(() => {
        let mins = Math.floor(secondsLeft / 60);
        let secs = secondsLeft % 60;
        const display = document.getElementById('timeLeft');
        if (display) display.innerText = (mins<10?"0":"")+mins+":"+(secs<10?"0":"")+secs;
        if (secondsLeft <= 0) { clearInterval(quizTimerInterval); submitQuiz(); }
        secondsLeft--;
    }, 1000);
}

async function submitQuiz() {
    if (quizTimerInterval) clearInterval(quizTimerInterval);
    let correctAnswers = 0, totalQuestions = 0, submittedAnswers = [];
    allQuizQuestions.forEach((q, idx) => {
        let ans = "", isCorrect = false;
        totalQuestions++;
        if (q.type === 'choice' || q.type === 'truefalse') {
            const sel = document.querySelector(`input[name="quiz_q_${idx}"]:checked`);
            ans = sel ? sel.value : "";
            if (q.correctAnswer && ans === q.correctAnswer) { correctAnswers++; isCorrect = true; }
        } else if (q.type === 'essay') {
            ans = document.getElementById(`quiz_ans_${idx}`).value.trim();
            if (ans.length >= 50) { correctAnswers++; isCorrect = true; }
            else if (ans.length >= 20) { correctAnswers += 0.7; }
        } else {
            ans = document.getElementById(`quiz_ans_${idx}`).value;
            if (q.correctAnswer && ans.trim().toLowerCase() === q.correctAnswer.trim().toLowerCase()) { correctAnswers++; isCorrect = true; }
        }
        submittedAnswers.push({question: q.text, userAnswer: ans});
    });

    const wrongAnswers = totalQuestions - Math.floor(correctAnswers);
    let finalPoints = 3;
    if (wrongAnswers === 0) finalPoints = 5;
    else if (wrongAnswers === 1) finalPoints = 4;

    const currentQuizId = 'current_quiz_2026';
    
    // ÿ≠ŸÅÿ∏ ŸÅŸä ŸÜÿ∏ÿßŸÖ ŸÖŸÜÿπ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±
    const saved = await saveQuizSubmission(
        currentQuizId, 
        submittedAnswers, 
        Math.floor(correctAnswers), 
        totalQuestions, 
        finalPoints
    );
    
    if (!saved) {
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ. ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑŸÜŸÇÿßÿ∑.');
        return;
    }

    await db.ref("bible_quiz/submissions").push({ userName: selectedQuizStudentName, score: Math.floor(correctAnswers), max: totalQuestions, finalPoints, answers: submittedAnswers, time: new Date().toLocaleString() });
    db.ref("points_data").once("value", snap => {
        snap.forEach(child => { 
            if (child.val().name === selectedQuizStudentName) {
                const currentScore = child.val().score || 0;
                const currentBreakdown = child.val().breakdown || {};
                
                // Update breakdown in Firebase
                const newBreakdown = {
                    quiz: (currentBreakdown.quiz || 0) + finalPoints,
                    prayer: currentBreakdown.prayer || 0,
                    attendance: currentBreakdown.attendance || 0
                };
                
                child.ref.update({ 
                    score: currentScore + finalPoints,
                    breakdown: newBreakdown,
                    lastUpdate: Date.now()
                });
            }
        });
    });
    
    // ========== ŸÜÿ∏ÿßŸÖ ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© ==========
    checkQuizBadges(selectedQuizStudentName, Math.floor(correctAnswers), totalQuestions, wrongAnswers);
    
    showFinishedStatus(Math.floor(correctAnswers), totalQuestions, finalPoints);
}

// ========== ŸÅÿ≠ÿµ Ÿàÿ•ÿπÿ∑ÿßÿ° ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© ==========
function checkQuizBadges(userName, score, total, wrong) {
    const userId = getUserId(userName);
    const percentage = (score / total) * 100;
    
    // ÿ¥ÿßÿ±ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ÿØÿßÿ°
    if (wrong === 0 && total >= 5) {
        // ŸÖÿ´ÿßŸÑŸä!
        addBadgeForUser(userId, 'quiz-perfect', 'ÿ•ÿ¨ÿßÿ®ÿ© ŸÖÿ´ÿßŸÑŸäÿ©', 'gold', 'üèÜ');
        addXPForUser(userId, 50, 'ÿ•ÿ¨ÿßÿ®ÿ© ŸÖÿ´ÿßŸÑŸäÿ© ŸÅŸä ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©!');
        showQuizEncouragement(userName, 'üèÜ ÿ•ÿ¨ÿßÿ®ÿ© ŸÖÿ´ÿßŸÑŸäÿ©! ŸÉŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿµÿ≠Ÿäÿ≠ÿ©! ÿ£ŸÜÿ™ ŸÜÿ¨ŸÖ! üåü', 'perfect');
    } else if (wrong === 1 && total >= 5) {
        // ŸÖŸÖÿ™ÿßÿ≤
        addBadgeForUser(userId, 'quiz-excellent', 'ŸÖŸÖÿ™ÿßÿ≤ ÿ¨ÿØÿßŸã', 'silver', '‚≠ê');
        addXPForUser(userId, 30, 'ÿ£ÿØÿßÿ° ŸÖŸÖÿ™ÿßÿ≤ ŸÅŸä ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©!');
        showQuizEncouragement(userName, '‚≠ê ŸÖŸÖÿ™ÿßÿ≤ ÿ¨ÿØÿßŸã! ÿÆÿ∑ÿ£ Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑! ÿ£ŸÜÿ™ ÿ±ÿßÿ¶ÿπ! üí™', 'excellent');
    } else if (percentage >= 70) {
        // ÿ¨ŸäÿØ ÿ¨ÿØÿßŸã
        addBadgeForUser(userId, 'quiz-good', 'ÿ£ÿØÿßÿ° ÿ¨ŸäÿØ', 'bronze', 'üëç');
        addXPForUser(userId, 20, 'ÿ£ÿØÿßÿ° ÿ¨ŸäÿØ ŸÅŸä ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©!');
        showQuizEncouragement(userName, 'üëç ÿ£ÿØÿßÿ° ÿ¨ŸäÿØ! ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿßŸÑÿ™ÿπŸÑŸÖ! üìö', 'good');
    } else {
        // ŸÖÿ¥ÿßÿ±ŸÉÿ©
        addBadgeForUser(userId, 'quiz-participant', 'ŸÖÿ¥ÿßÿ±ŸÉ ŸÜÿ¥ÿ∑', 'blue', 'üíô');
        addXPForUser(userId, 10, 'ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© ŸÅŸä ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©');
        showQuizEncouragement(userName, 'üíô ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©! ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ŸàÿßŸÑÿ™ÿπŸÑŸÖ! üìñ', 'participant');
    }
    
    // ÿ™ÿ™ÿ®ÿπ ÿπÿØÿØ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿßÿ™
    trackQuizParticipation(userId, userName);
}

// ========== ÿ™ÿ™ÿ®ÿπ ÿπÿØÿØ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿßÿ™ ==========
function trackQuizParticipation(userId, userName) {
    db.ref(`users/${userId}/quiz_count`).once('value', snapshot => {
        let quizCount = (snapshot.val() || 0) + 1;
        db.ref(`users/${userId}/quiz_count`).set(quizCount);
        
        // ÿ¥ÿßÿ±ÿßÿ™ ÿ≠ÿ≥ÿ® ÿπÿØÿØ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿßÿ™
        const milestones = [
            { count: 5, id: 'quiz-5times', title: '5 ŸÖÿ≥ÿßÿ®ŸÇÿßÿ™', icon: 'üìö', type: 'bronze', xp: 25 },
            { count: 10, id: 'quiz-10times', title: '10 ŸÖÿ≥ÿßÿ®ŸÇÿßÿ™', icon: 'üìñ', type: 'silver', xp: 50 },
            { count: 20, id: 'quiz-20times', title: '20 ŸÖÿ≥ÿßÿ®ŸÇÿ©', icon: 'üéì', type: 'gold', xp: 100 },
            { count: 50, id: 'quiz-50times', title: 'ÿπÿßŸÑŸÖ ÿßŸÑŸÉÿ™ÿßÿ®', icon: 'üë®‚Äçüéì', type: 'gold', xp: 200 }
        ];
        
        milestones.forEach(milestone => {
            if (quizCount === milestone.count) {
                addBadgeForUser(userId, milestone.id, milestone.title, milestone.type, milestone.icon);
                addXPForUser(userId, milestone.xp, `${milestone.count} ŸÖÿ≥ÿßÿ®ŸÇÿ©!`);
                
                setTimeout(() => {
                    showQuizEncouragement(
                        userName, 
                        `${milestone.icon} ŸÖÿ®ÿ±ŸàŸÉ! ÿ£ŸÉŸÖŸÑÿ™ ${milestone.count} ŸÖÿ≥ÿßÿ®ŸÇÿ©! ÿ£ŸÜÿ™ ÿπÿßŸÑŸÖ ÿ≠ŸÇŸäŸÇŸä ŸÅŸä ÿßŸÑŸÉÿ™ÿßÿ® ÿßŸÑŸÖŸÇÿØÿ≥! üéâ`, 
                        'milestone'
                    );
                }, 3000);
                
                if (typeof confetti !== 'undefined') {
                    setTimeout(() => {
                        confetti({
                            particleCount: 150,
                            spread: 80,
                            origin: { y: 0.6 }
                        });
                    }, 3000);
                }
            }
        });
    });
}

// ========== ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ¥ÿ¨Ÿäÿπ ŸÑŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© ==========
function showQuizEncouragement(userName, message, type) {
    const icons = {
        'perfect': 'üèÜ',
        'excellent': '‚≠ê',
        'good': 'üëç',
        'participant': 'üíô',
        'milestone': 'üéâ'
    };
    
    const colors = {
        'perfect': 'linear-gradient(135deg, #fbbf24, #f59e0b)',
        'excellent': 'linear-gradient(135deg, #e5e7eb, #9ca3af)',
        'good': 'linear-gradient(135deg, #f59e0b, #d97706)',
        'participant': 'linear-gradient(135deg, #3b82f6, #2563eb)',
        'milestone': 'linear-gradient(135deg, #667eea, #764ba2)'
    };
    
    const encouragementHTML = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: ${colors[type] || colors.participant}; 
                    padding: 35px; border-radius: 30px; 
                    box-shadow: 0 20px 60px rgba(0,0,0,0.4); 
                    z-index: 10001; max-width: 90%; width: 400px;
                    animation: popupAppear 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);"
             id="quizEncouragementPopup">
            <div style="font-size: 64px; text-align: center; margin-bottom: 15px; animation: bounce 1s infinite;">
                ${icons[type] || 'üíô'}
            </div>
            <div style="font-size: 24px; font-weight: 900; color: white; text-align: center; margin-bottom: 15px; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                ${userName.split(' ')[0]}ÿå ÿ£ÿ≠ÿ≥ŸÜÿ™! üéâ
            </div>
            <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); 
                        padding: 20px; border-radius: 20px; color: white; 
                        font-size: 16px; line-height: 1.8; margin: 15px 0; 
                        border: 2px solid rgba(255,255,255,0.2); text-align: center;">
                ${message}
            </div>
            <div style="color: rgba(255,255,255,0.9); font-size: 14px; text-align: center; margin-top: 15px;">
                "ÿßÿ¨Ÿíÿ™ŸéŸáŸêÿØŸí ÿ£ŸéŸÜŸí ÿ™ŸèŸÇŸêŸäŸÖŸé ŸÜŸéŸÅŸíÿ≥ŸéŸÉŸé ŸÑŸÑŸáŸê ŸÖŸèÿ≤ŸéŸÉŸãŸëŸâ" - 2 ÿ™ŸäŸÖŸàÿ´ÿßŸàÿ≥ 2: 15
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeQuizEncouragement()" 
                        style="background: rgba(255,255,255,0.3); color: white; border: none; 
                               padding: 12px 30px; border-radius: 30px; font-weight: 800; 
                               cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 15px; 
                               transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    ÿ¥ŸÉÿ±ÿßŸã! üôè
                </button>
            </div>
        </div>
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); 
                    backdrop-filter: blur(5px); z-index: 10000;" 
             id="quizEncouragementOverlay" 
             onclick="closeQuizEncouragement()"></div>
    `;
    
    // ÿπÿ±ÿ∂ ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ™ŸäŸÜ ŸÖŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©
    setTimeout(() => {
        document.body.insertAdjacentHTML('beforeend', encouragementHTML);
    }, 2000);
}

function closeQuizEncouragement() {
    const popup = document.getElementById('quizEncouragementPopup');
    const overlay = document.getElementById('quizEncouragementOverlay');
    if (popup) popup.remove();
    if (overlay) overlay.remove();
}

// ========== ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ¥ÿßÿ±ÿßÿ™ Ÿà XP ==========
function addBadgeForUser(userId, badgeId, title, type, icon) {
    db.ref(`users/${userId}/badges/${badgeId}`).set({
        title: title,
        type: type,
        icon: icon,
        earnedAt: Date.now()
    });
}

function addXPForUser(userId, amount, reason) {
    db.ref(`users/${userId}/progress`).once('value', snapshot => {
        const data = snapshot.val() || { xp: 0, level: 1, xpForNextLevel: 100 };
        data.xp += amount;
        
        // ŸÅÿ≠ÿµ ÿßŸÑÿßÿ±ÿ™ŸÇÿßÿ°
        while (data.xp >= data.xpForNextLevel) {
            data.level++;
            data.xp -= data.xpForNextLevel;
            data.xpForNextLevel = Math.floor(data.xpForNextLevel * 1.5);
        }
        
        db.ref(`users/${userId}/progress`).set(data);
    });
}

function showFinishedStatus(score, max, finalPoints) {
    document.getElementById('quizSetup').style.display = 'none';
    document.getElementById('quizArea').style.display = 'none';
    document.getElementById('quizDone').style.display = 'block';
    if (score !== undefined) {
        const wrongCount = max - score;
        let pointsMsg = "";
        if (wrongCount === 0) pointsMsg = " - ŸÖÿ®ÿ±ŸàŸÉ! ÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ 5 ŸÜŸÇÿßÿ∑ üéâ";
        else if (wrongCount === 1) pointsMsg = " - ÿ¨ŸäÿØ! ÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ 4 ŸÜŸÇÿßÿ∑ ‚ú®";
        else pointsMsg = " - ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©! ÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ 3 ŸÜŸÇÿßÿ∑ üëç";
        document.getElementById('finalQuizScore').innerText = `ÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ ${score} ŸÖŸÜ ${max}${pointsMsg}`;
    }
}

function updateCharCount(idx) {
    const area = document.getElementById(`quiz_ans_${idx}`);
    const counter = document.getElementById(`charCount_${idx}`);
    if (area && counter) counter.innerText = area.value.length;
}

// ===== CHAT =====
function sendChat() {
    const inp = document.getElementById('chatInput');
    const name = document.getElementById('userName').value || "ŸÖÿÆÿØŸàŸÖ";
    if (inp.value.trim()) { db.ref("chat").push({sender: name, text: inp.value}); inp.value = ""; }
}

// ===== PSYCHOLOGY =====
function setMood(el, m) {
    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active'); currentMood = m;
}

function sendMoodOnly() {
    db.ref("psychology/confessions").push({
        sender: document.getElementById('psyNameInput').value || "ÿßÿ®ŸÜ ÿßŸÑÿ∑ÿßÿπÿ©",
        mood: currentMood,
        need: document.getElementById('psyNeed').value,
        text: "ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ŸÅŸÇÿ∑",
        time: new Date().toLocaleString()
    });
    alert("ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ™ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠ ‚ù§Ô∏è");
}

function sendPsyChat() {
    const inp = document.getElementById('psyChatInput');
    if (inp.value.trim()) {
        db.ref("psychology/private_chats/" + psySessionID).push({ sender: "ÿ£ŸÜÿß", text: inp.value.trim() });
        inp.value = "";
    }
}

function clearPsyChat() {
    if (confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü")) db.ref("psychology/private_chats/" + psySessionID).remove();
}

// ===== PRAYER SESSION (33) =====
function startPrayerSession() {
    document.getElementById('prayerTimer').style.display = 'block';
    pCount = 0; updatePrayerDisplay();
}

function countPrayer() {
    pCount++; updatePrayerDisplay();
    if (window.navigator.vibrate) window.navigator.vibrate(40);
    if (pCount >= 33) { alert("ÿµŸÑÿßÿ© ŸÖŸÇÿ®ŸàŸÑÿ©! üôè‚ú®"); document.getElementById('prayerTimer').style.display = 'none'; }
}

function updatePrayerDisplay() {
    document.getElementById('pCountText').innerText = pCount;
    document.getElementById('activePrayer').innerText = prayers[pCount % prayers.length];
}

// ===== QUESTION =====
function sendQuestion() {
    const txt = document.getElementById('quesMsg').value.trim();
    if (txt) {
        db.ref("psychology/questions").push({ sender: "ŸÖÿÆÿØŸàŸÖ", text: txt, time: new Date().toLocaleString() });
        alert("ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ‚úÖ"); document.getElementById('quesMsg').value = "";
    }
}

// ===== JIHAD BALANCE =====
function toggleJihadSection(isChecked) {
    const area = document.getElementById('jihadArea');
    const toggle = document.getElementById('jihadMasterToggle');
    if (isChecked) {
        let savedPin = localStorage.getItem('jihad_pin');
        if (!savedPin) {
            let newPin = prompt("ÿßŸÉÿ™ÿ® ÿ±ŸÇŸÖ ÿ≥ÿ±Ÿä ÿ¨ÿØŸäÿØ ŸÑŸÖŸäÿ≤ÿßŸÜ ÿßŸÑÿ¨ŸáÿßÿØ:");
            if (newPin && newPin.trim()) { localStorage.setItem('jihad_pin', newPin.trim()); area.style.display = 'block'; }
            else toggle.checked = false;
        } else {
            if (prompt("ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿ≥ÿ±Ÿä:") === savedPin) area.style.display = 'block';
            else { alert("ÿÆÿ∑ÿ£! ‚úï"); toggle.checked = false; }
        }
    } else area.style.display = 'none';
}

function changeJihadPin() {
    if (prompt("ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿ≠ÿßŸÑŸä:") === localStorage.getItem('jihad_pin')) {
        let n = prompt("ÿßŸÑÿ¨ÿØŸäÿØ:");
        if (n) localStorage.setItem('jihad_pin', n);
    }
}

function jihadCh(id, d) {
    let s = document.getElementById(id);
    let v = parseInt(s.innerText);
    if (v + d >= 0) s.innerText = v + d;
}

function jihadSave() {
    let ps = 0; 
    let ns = 0;
    
    // Get individual negative scores for analysis
    const negativeScores = {
        'ÿ¥ÿ™ŸäŸÖÿ©': parseInt(document.getElementById('jn1').innerText),
        'ŸÉÿ∞ÿ®': parseInt(document.getElementById('jn2').innerText),
        'ŸÉŸÑÿßŸÖ ÿ±ÿØŸäÿ°': parseInt(document.getElementById('jn3').innerText),
        'ÿ∫ÿ∂ÿ®': parseInt(document.getElementById('jn4').innerText),
        'ŸÅŸÉÿ± ÿ≥ŸÑÿ®Ÿä': parseInt(document.getElementById('jn5').innerText)
    };
    
    document.querySelectorAll('.jihad-p-score').forEach(s => ps += parseInt(s.innerText));
    document.querySelectorAll('.jihad-n-score').forEach(s => ns += parseInt(s.innerText));
    
    let total = ps + ns;
    let pP = total === 0 ? 0 : Math.round((ps/total)*100);
    
    // Get history
    let h = JSON.parse(localStorage.getItem('spiritual_vFullDetail') || "[]");
    
    // Analyze improvement
    let improvementMsg = "";
    let encouragementMsg = "";
    let focusArea = "";
    
    // Find highest negative area to focus on
    let maxNegative = 0;
    let maxNegativeName = "";
    for (let key in negativeScores) {
        if (negativeScores[key] > maxNegative) {
            maxNegative = negativeScores[key];
            maxNegativeName = key;
        }
    }
    
    // Check if improving from yesterday
    if (h.length > 0) {
        const lastScore = h[0].p;
        const improvement = pP - lastScore;
        
        if (improvement > 0) {
            improvementMsg = `\nüéâ ÿ±ÿßÿ¶ÿπ! ÿ™ÿ≠ÿ≥ŸÜÿ™ ${improvement}% ÿπŸÜ ÿ¢ÿÆÿ± ŸÖÿ±ÿ©!`;
            encouragementMsg = "ŸÖÿßÿ¥Ÿä ŸÅŸä ÿßŸÑÿ∑ÿ±ŸäŸÇ ÿßŸÑÿµÿ≠! ÿ±ÿ®ŸÜÿß ŸÖÿπÿßŸÉ ŸàŸÅÿ±ÿ≠ÿßŸÜ ÿ®ŸäŸÉ ‚ù§Ô∏è";
        } else if (improvement === 0) {
            improvementMsg = `\nüìä ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ŸÉÿ¢ÿÆÿ± ŸÖÿ±ÿ©`;
            encouragementMsg = "ÿÆŸÑŸäŸÜÿß ŸÜÿ≠ÿßŸàŸÑ ŸÜÿ®ŸÇŸâ ÿ£ÿ≠ÿ≥ŸÜ ŸÉŸÑ ŸäŸàŸÖ ÿ¥ŸàŸäÿ© ÿ¥ŸàŸäÿ© üí™";
        } else {
            improvementMsg = `\nüìâ ÿßŸÜÿÆŸÅÿ∂ÿ™ ${Math.abs(improvement)}% ÿπŸÜ ÿ¢ÿÆÿ± ŸÖÿ±ÿ©`;
            encouragementMsg = "ŸÖÿ¥ ŸÖÿ¥ŸÉŸÑÿ©! ŸÉŸÑŸÜÿß ÿ®ŸÜÿ∫ŸÑÿ∑.. ÿßŸÑŸÖŸáŸÖ ŸÜŸÇŸàŸÖ ŸàŸÜŸÉŸÖŸÑ üåü";
        }
    }
    
    // Suggest focus area
    if (maxNegative > 0) {
        focusArea = `\n\nüéØ ÿ±ŸÉÿ≤ ÿπŸÑŸâ: ${maxNegativeName} (${maxNegative} ŸÖÿ±ÿ©)\nÿ≠ÿßŸàŸÑ ÿ™ŸÇŸÑŸÑŸáÿß ÿ£ŸÉÿ™ÿ± ÿßŸÑŸÖÿ±ÿ© ÿßŸÑÿ¨ÿßŸäÿ©!`;
    }
    
    // Save new record
    h.unshift({ 
        id: Date.now(), 
        date: new Date().toLocaleDateString('ar-EG'), 
        p: pP, 
        n: (100-pP),
        negatives: negativeScores
    });
    
    // Keep only last 7 days
    if (h.length > 7) {
        h = h.slice(0, 7);
    }
    
    localStorage.setItem('spiritual_vFullDetail', JSON.stringify(h));
    
    // Show detailed message
    alert(`‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏!\n\nüìä ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©: ${pP}% ÿ•Ÿäÿ¨ÿßÿ®Ÿä${improvementMsg}\n\nüí¨ ${encouragementMsg}${focusArea}`);
    
    // Update display without reloading
    jihadDisplay();
    
    // Reset scores to zero
    document.querySelectorAll('.jihad-p-score, .jihad-n-score').forEach(s => s.innerText = '0');
    
    // Show confetti
    if (typeof confetti !== 'undefined') {
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    }
}

function jihadPrepareLink(event, type) {
    event.preventDefault();
    let h = JSON.parse(localStorage.getItem('spiritual_vFullDetail') || "[]");
    if (h.length === 0) return alert("ÿ≥ÿ¨ŸÑ ÿ£ŸàŸÑÿßŸã!");
    let msg = "ŸÖŸÑÿÆÿµ ÿ¨ŸáÿßÿØŸä:\n" + h.slice(0,3).map(d => `${d.date}: ${d.p}% ÿ•Ÿäÿ¨ÿßÿ®Ÿä`).join('\n');
    if (type === 'wa') window.open("https://wa.me/?text=" + encodeURIComponent(msg));
    else navigator.clipboard.writeText(msg).then(() => alert("ŸÜÿ≥ÿÆ ‚úÖ"));
}

function jihadDel(id) {
    if (confirm("ÿ≠ÿ∞ŸÅÿü")) {
        let h = JSON.parse(localStorage.getItem('spiritual_vFullDetail') || "[]").filter(x => x.id !== id);
        localStorage.setItem('spiritual_vFullDetail', JSON.stringify(h));
        jihadDisplay();
    }
}

function jihadDisplay() {
    let h = JSON.parse(localStorage.getItem('spiritual_vFullDetail') || "[]");
    const l = document.getElementById('jihadHList');
    
    if (!l) return;
    
    let html = `<div style="font-weight:700; margin-bottom:12px; color:var(--text-secondary); font-size:16px;">üìú ÿ≥ÿ¨ŸÑ ÿ¨ŸáÿßÿØŸÉ ÿßŸÑÿ±Ÿàÿ≠Ÿä (ÿ¢ÿÆÿ± 7 ÿ£ŸäÿßŸÖ)</div>`;
    
    // Show improvement trend if there's data
    if (h.length >= 2) {
        const trend = h[0].p - h[1].p;
        let trendIcon = trend > 0 ? "üìà" : trend < 0 ? "üìâ" : "‚û°Ô∏è";
        let trendText = trend > 0 ? "ÿ®ÿ™ÿ™ÿ≠ÿ≥ŸÜ!" : trend < 0 ? "ŸÖÿ≠ÿ™ÿßÿ¨ ÿ™ÿ±ŸÉŸäÿ≤ ÿ£ŸÉÿ™ÿ±" : "ÿ´ÿßÿ®ÿ™";
        let trendColor = trend > 0 ? "var(--success)" : trend < 0 ? "var(--danger)" : "var(--warning)";
        
        html += `<div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); padding:12px; border-radius:12px; margin-bottom:12px; text-align:center;">
            <div style="font-size:24px; margin-bottom:6px;">${trendIcon}</div>
            <div style="font-weight:700; color:${trendColor}; font-size:15px;">${trendText}</div>
            <div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">
                ${trend > 0 ? `+${trend}` : trend}% ÿπŸÜ ÿ¢ÿÆÿ± ŸÖÿ±ÿ©
            </div>
        </div>`;
    }
    
    // Show each record with details
    h.forEach((x, index) => {
        let improvementBadge = "";
        if (index > 0 && h[index - 1]) {
            const diff = x.p - h[index - 1].p;
            if (diff > 0) improvementBadge = `<span style="color:var(--success); font-size:11px; margin-right:8px;">‚Üë +${diff}%</span>`;
            else if (diff < 0) improvementBadge = `<span style="color:var(--danger); font-size:11px; margin-right:8px;">‚Üì ${diff}%</span>`;
        }
        
        // Find focus area for this day
        let focusNote = "";
        if (x.negatives) {
            let maxNeg = 0;
            let maxNegName = "";
            for (let key in x.negatives) {
                if (x.negatives[key] > maxNeg) {
                    maxNeg = x.negatives[key];
                    maxNegName = key;
                }
            }
            if (maxNeg > 0) {
                focusNote = `<div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">üéØ ÿ±ŸÉÿ≤ ÿπŸÑŸâ: ${maxNegName}</div>`;
            }
        }
        
        html += `<div class="jihad-history-item" style="position:relative;">
            <div>
                <strong>${x.date}</strong>: 
                <span style="color:var(--success); font-weight:700;">${x.p}% ÿ•Ÿäÿ¨ÿßÿ®Ÿä</span>
                ${improvementBadge}
                ${focusNote}
            </div>
            <button class="jihad-del-btn" onclick="jihadDel(${x.id})">üóëÔ∏è</button>
        </div>`;
    });
    
    l.innerHTML = html;
}

function jihadShowResults() {
    const resultsDiv = document.getElementById('jihadHList');
    if (resultsDiv.style.display === 'none') {
        resultsDiv.style.display = 'block';
        jihadDisplay();
    } else {
        resultsDiv.style.display = 'none';
    }
}

// ===== ATTENDANCE =====
// ========== ŸÜÿ∏ÿßŸÖ ŸÖŸÜÿπ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ± ÿßŸÑŸäŸàŸÖŸä ==========
// ÿØÿßŸÑÿ© ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿµŸÖÿ© ŸÅÿ±ŸäÿØÿ© ŸÑŸÑÿ¨Ÿáÿßÿ≤ (ŸÑÿß ÿ™ÿ™ÿ∫Ÿäÿ± ÿ≠ÿ™Ÿâ ÿ®ÿπÿØ ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠)
function getDeviceFingerprintForAttendance() {
    const navigatorInfo = [
        navigator.userAgent,
        navigator.language,
        navigator.platform,
        screen.width,
        screen.height,
        screen.colorDepth,
        new Date().getTimezoneOffset(),
        navigator.hardwareConcurrency || 'unknown',
        navigator.deviceMemory || 'unknown'
    ].join('###');
    
    let hash = 0;
    for (let i = 0; i < navigatorInfo.length; i++) {
        const char = navigatorInfo.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    
    return 'device_' + Math.abs(hash).toString(36);
}

// ÿØÿßŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸäŸàŸÖŸä ŸÅŸä Firebase
async function checkDailyAttendanceLimit(type, name) {
    const deviceId = getDeviceFingerprintForAttendance();
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    
    return new Promise((resolve) => {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿßŸÑÿßÿ≥ŸÖ ŸàÿßŸÑŸäŸàŸÖ
        db.ref('daily_attendance_locks/' + type + '/' + today)
            .orderByChild('name')
            .equalTo(name)
            .once('value', nameSnapshot => {
                if (nameSnapshot.exists()) {
                    // ÿßŸÑÿßÿ≥ŸÖ ÿ≥ÿ¨ŸÑ ÿßŸÑŸäŸàŸÖ
                    resolve({ 
                        blocked: true, 
                        reason: `‚ùå ÿßŸÑÿßÿ≥ŸÖ "${name}" ÿ≥ÿ¨ŸÑ ÿ≠ÿ∂Ÿàÿ± ${type} ÿßŸÑŸÜŸáÿßÿ±ÿØŸá ÿ®ÿßŸÑŸÅÿπŸÑ!\nŸÖŸäŸÜŸÅÿπÿ¥ ÿ™ÿ≥ÿ¨ŸÑ ŸÖÿ±ÿ™ŸäŸÜ ÿ≠ÿ™Ÿâ ŸÑŸà ŸÖŸÜ ÿ¨Ÿáÿßÿ≤ ÿ™ÿßŸÜŸä.` 
                    });
                } else {
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤
                    db.ref('daily_attendance_locks/' + type + '/' + today)
                        .orderByChild('deviceId')
                        .equalTo(deviceId)
                        .once('value', deviceSnapshot => {
                            if (deviceSnapshot.exists()) {
                                // ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿ≥ÿ¨ŸÑ ÿßŸÑŸäŸàŸÖ
                                let registeredName = '';
                                deviceSnapshot.forEach(child => {
                                    registeredName = child.val().name;
                                });
                                resolve({ 
                                    blocked: true, 
                                    reason: `‚ùå ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿØŸá ÿ≥ÿ¨ŸÑ ÿßŸÑŸÜŸáÿßÿ±ÿØŸá ÿ®ÿßÿ≥ŸÖ "${registeredName}"!\nŸÖŸäŸÜŸÅÿπÿ¥ ÿ™ÿ≥ÿ¨ŸÑ ŸÑÿ¥ÿÆÿµ ÿ™ÿßŸÜŸä ŸÖŸÜ ŸÜŸÅÿ≥ ÿßŸÑÿ¨Ÿáÿßÿ≤.` 
                                });
                            } else {
                                // ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ - ŸÖÿ≥ŸÖŸàÿ≠
                                resolve({ blocked: false });
                            }
                        });
                }
            });
    });
}

// ÿØÿßŸÑÿ© ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÅŸä Firebase
async function recordDailyAttendance(type, name) {
    const deviceId = getDeviceFingerprintForAttendance();
    const today = new Date().toISOString().split('T')[0];
    const timestamp = Date.now();
    
    const recordData = {
        name: name,
        deviceId: deviceId,
        timestamp: timestamp,
        datetime: new Date().toISOString()
    };
    
    return db.ref('daily_attendance_locks/' + type + '/' + today).push(recordData);
}

async function submitAttendance(type, inputId) {
    const name = document.getElementById('attendanceNameSelect').value;
    const today = new Date().toISOString().split('T')[0]; // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÜŸÅÿ≥ ÿßŸÑŸÅŸàÿ±ŸÖÿßÿ™
    const serviceWarning = document.getElementById('serviceWarning');
    const massWarning = document.getElementById('massWarning');

    if (!name) return alert("ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã!");

    // ÿ•ÿÆŸÅÿßÿ° ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ±
    if (serviceWarning) serviceWarning.style.display = 'none';
    if (massWarning) massWarning.style.display = 'none';

    let day = '';
    let massTime = '';
    let priestName = '';

    if (type === 'ŸÇÿØÿßÿ≥') {
        // ÿßŸÑŸÇÿØÿßÿ≥: ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
        const todayDate = new Date();
        const days = ['ÿßŸÑÿ£ÿ≠ÿØ', 'ÿßŸÑÿßÿ™ŸÜŸäŸÜ', 'ÿßŸÑÿ™ŸÑÿßÿ™', 'ÿßŸÑÿ£ÿ±ÿ®ÿπ', 'ÿßŸÑÿÆŸÖŸäÿ≥', 'ÿßŸÑÿ¨ŸÖÿπÿ©', 'ÿßŸÑÿ≥ÿ®ÿ™'];
        day = days[todayDate.getDay()];
        
        massTime = document.getElementById('massTime')?.value || '';
        priestName = document.getElementById('priestName')?.value.trim() || '';
        
        if (!massTime) {
            alert("ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿßŸÉÿ™ÿ® ÿ≠ÿ∂ÿ±ÿ™ ÿßŸÑŸÇÿØÿßÿ≥ ÿßŸÑÿ≥ÿßÿπÿ© ŸÉÿßŸÖÿü üïê");
            return;
        }
        if (!priestName) {
            alert("ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿßŸÉÿ™ÿ® ÿ£ÿ®ŸàŸÜÿß ŸÖŸäŸÜ ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿü ‚õ™");
            return;
        }
    } else if (type === 'ÿÆÿØŸÖÿ©') {
        // ÿßŸÑÿÆÿØŸÖÿ©: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸäŸàŸÖ ÿßŸÑÿ¨ŸÖÿπÿ©
        const currentDay = new Date().getDay();
        if (currentDay !== 5) { // 5 = ÿßŸÑÿ¨ŸÖÿπÿ©
            if (serviceWarning) {
                serviceWarning.style.display = 'block';
                setTimeout(() => {
                    serviceWarning.style.display = 'none';
                }, 5000);
            }
            return;
        }
        
        day = document.getElementById(inputId).value.trim();
        if (!day) {
            alert("ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿßŸÉÿ™ÿ® ŸäŸàŸÖ ÿ•ŸäŸá!");
            return;
        }
    }

    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿØ ÿßŸÑŸäŸàŸÖŸä ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Firebase
    const limitCheck = await checkDailyAttendanceLimit(type, name);
    if (limitCheck.blocked) {
        return alert(limitCheck.reason);
    }

    // ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ŸÅŸä Firebase ÿ£ŸàŸÑÿßŸã (ÿßŸÑÿ≠ŸÖÿßŸäÿ© ÿßŸÑŸÇŸàŸäÿ©)
    await recordDailyAttendance(type, name);

    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÜŸÇÿßÿ∑ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ
    // ÿßŸÑŸÇÿØÿßÿ≥: ŸÑÿß ŸÜÿ∂ŸäŸÅ ŸÜŸÇÿßÿ∑ ŸáŸÜÿßÿå ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ™Ÿáÿß ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ≤ŸÖŸäŸÑ ŸàÿßŸÑÿ™ÿ£ŸÉŸäÿØ
    // ÿßŸÑÿÆÿØŸÖÿ©: ŸÜÿ∂ŸäŸÅ 5 ŸÜŸÇÿßÿ∑ ŸÖÿ®ÿßÿ¥ÿ±ÿ©
    if (type !== 'ŸÇÿØÿßÿ≥') {
        db.ref("points_data").once("value", snap => {
            snap.forEach(child => {
                if (child.val().name === name) {
                    const currentScore = child.val().score || 0;
                    const currentBreakdown = child.val().breakdown || {};
                    
                    // Update breakdown in Firebase
                    const newBreakdown = {
                        quiz: currentBreakdown.quiz || 0,
                        prayer: currentBreakdown.prayer || 0,
                        attendance: (currentBreakdown.attendance || 0) + 5
                    };
                    
                    child.ref.update({ 
                        score: currentScore + 5,
                        breakdown: newBreakdown
                    });
                }
            });
        });
    }

    // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ©
    const logData = { 
        makhdom: name,
        userId: getUserId(name),
        submitDate: today,
        type, 
        day, 
        submittedAt: new Date().toLocaleString() 
    };
    
    if (type === 'ŸÇÿØÿßÿ≥') {
        logData.massTime = massTime;
        logData.priestName = priestName;
    }
    
    db.ref("attendance_logs").push(logData);
    
    // ÿßŸÑŸÄ localStorage ŸÑŸÑÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÇÿØŸäŸÖ ŸÅŸÇÿ∑
    const lockKey = `lock_${type}_${name}_${today}`;
    localStorage.setItem(lockKey, "true");
    
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÇÿØÿßÿ≥ÿå ÿßŸÅÿ™ÿ≠ ŸÖŸàÿØÿßŸÑ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ≤ŸÖŸäŸÑ
    if (type === 'ŸÇÿØÿßÿ≥') {
        showPeerConfirmationModal(name);
        document.getElementById('massTime').value = "";
        document.getElementById('priestName').value = "";
    } else {
        alert(`ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© Ÿ• ÿØÿ±ÿ¨ÿßÿ™ ÿ≠ÿ∂Ÿàÿ± ${type} ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ`);
        document.getElementById(inputId).value = "";
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
    }
}

// ===== ŸÜÿ∏ÿßŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿßŸÑÿ≤ŸÖŸÑÿßÿ° =====

let currentUser = '';
let currentConfirmationId = '';

// ÿπÿ±ÿ∂ ŸÖŸàÿØÿßŸÑ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ≤ŸÖŸäŸÑ
function showPeerConfirmationModal(userName) {
    currentUser = userName;
    const modal = document.getElementById('peerConfirmationModal');
    const peersList = document.getElementById('peersList');
    
    // ÿ™ŸàŸÑŸäÿØ ŸÖÿπÿ±ŸÅ ŸÅÿ±ŸäÿØ ŸÑÿ∑ŸÑÿ® ÿßŸÑÿ™ÿ£ŸÉŸäÿØ
    currentConfirmationId = `confirm_${userName}_${Date.now()}`;
    
    // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≥ŸÖÿßÿ°
    db.ref("points_data").once("value", snap => {
        const allNames = [];
        snap.forEach(child => {
            const name = child.val().name;
            if (name && name !== userName) {
                allNames.push(name);
            }
        });
        
        // ÿπÿ±ÿ∂ ÿßŸÑÿ£ÿ≥ŸÖÿßÿ°
        peersList.innerHTML = '';
        
        if (allNames.length === 0) {
            peersList.innerHTML = `
                <div style="text-align:center; padding:20px; color:var(--text-secondary);">
                    <p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≤ŸÖŸÑÿßÿ° ŸÖÿ™ÿßÿ≠ŸäŸÜ ÿ≠ÿßŸÑŸäÿßŸã</p>
                </div>
            `;
        } else {
            allNames.forEach(peerName => {
                const peerItem = document.createElement('div');
                peerItem.className = 'peer-item';
                peerItem.innerHTML = `
                    <div class="peer-info">
                        <div class="peer-avatar">${peerName.charAt(0)}</div>
                        <div class="peer-details">
                            <h4>${peerName}</h4>
                            <p>ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ±</p>
                        </div>
                    </div>
                    <div class="peer-action">
                        <span>ÿßÿÆÿ™Ÿäÿßÿ±</span>
                        <span>üëÜ</span>
                    </div>
                `;
                peerItem.onclick = () => selectPeerForConfirmation(peerName);
                peersList.appendChild(peerItem);
            });
        }
        
        modal.style.display = 'block';
    });
    
    // ÿ•ÿ∂ÿßŸÅÿ© 3 ŸÜŸÇÿßÿ∑ ŸÅŸàÿ±ÿßŸã ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ∞Ÿä ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ±
    db.ref("points_data").once("value", snap => {
        snap.forEach(child => {
            if (child.val().name === userName) {
                const currentScore = child.val().score || 0;
                const currentBreakdown = child.val().breakdown || {};
                
                const newBreakdown = {
                    quiz: currentBreakdown.quiz || 0,
                    prayer: currentBreakdown.prayer || 0,
                    attendance: (currentBreakdown.attendance || 0) + 3
                };
                
                child.ref.update({ 
                    score: currentScore + 3,
                    breakdown: newBreakdown
                });
            }
        });
    });
    
    showNotification(`ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© 3 ŸÜŸÇÿßÿ∑! üéâ ÿßÿÆÿ™ÿ± ÿ≤ŸÖŸäŸÑ ŸÑÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∂Ÿàÿ±ŸÉ`);
}

// ÿßÿÆÿ™Ÿäÿßÿ± ÿ≤ŸÖŸäŸÑ ŸÑÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∂Ÿàÿ±
function selectPeerForConfirmation(peerName) {
    // ÿ≠ŸÅÿ∏ ÿ∑ŸÑÿ® ÿßŸÑÿ™ÿ£ŸÉŸäÿØ ŸÅŸä Firebase
    const confirmationRequest = {
        requester: currentUser,
        confirmer: peerName,
        requestId: currentConfirmationId,
        timestamp: Date.now(),
        status: 'pending',
        date: new Date().toISOString().split('T')[0] // ŸÅŸàÿ±ŸÖÿßÿ™ ŸÖŸàÿ≠ÿØ
    };
    
    db.ref("confirmation_requests").push(confirmationRequest);
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≠ÿßŸÑÿ©
    showNotification(`ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿ™ÿ£ŸÉŸäÿØ ÿ•ŸÑŸâ ${peerName} üì®`);
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂ ŸÅŸä ÿßŸÑŸÖŸàÿØÿßŸÑ
    updatePeersListWithPending(peerName);
    
    // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ£ŸÉŸäÿØ
    watchConfirmationStatus();
}

// ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≤ŸÖŸÑÿßÿ° ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±
function updatePeersListWithPending(peerName) {
    const peersList = document.getElementById('peersList');
    const items = peersList.querySelectorAll('.peer-item');
    
    items.forEach(item => {
        const nameInItem = item.querySelector('.peer-details h4').textContent;
        
        if (nameInItem === peerName) {
            item.className = 'peer-item pending';
            item.onclick = null;
            item.innerHTML = `
                <div class="peer-info">
                    <div class="peer-avatar">${peerName.charAt(0)}</div>
                    <div class="peer-details">
                        <h4>${peerName}</h4>
                        <p>ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ÿ£ŸÉŸäÿØ...</p>
                    </div>
                </div>
                <div class="peer-action">
                    <span>‚è≥</span>
                </div>
            `;
        } else {
            item.style.opacity = '0.5';
            item.style.pointerEvents = 'none';
        }
    });
}

// ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ£ŸÉŸäÿØ
function watchConfirmationStatus() {
    db.ref("confirmation_requests").on('value', snap => {
        snap.forEach(child => {
            const req = child.val();
            
            if (req.requestId === currentConfirmationId && req.status === 'confirmed') {
                // ÿ•ÿ∂ÿßŸÅÿ© 3 ŸÜŸÇÿßÿ∑ ÿ•ÿ∂ÿßŸÅŸäÿ© ÿπŸÜÿØ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ
                db.ref("points_data").once("value", pointsSnap => {
                    pointsSnap.forEach(pointsChild => {
                        if (pointsChild.val().name === currentUser) {
                            const currentScore = pointsChild.val().score || 0;
                            const currentBreakdown = pointsChild.val().breakdown || {};
                            
                            const newBreakdown = {
                                quiz: currentBreakdown.quiz || 0,
                                prayer: currentBreakdown.prayer || 0,
                                attendance: (currentBreakdown.attendance || 0) + 3
                            };
                            
                            pointsChild.ref.update({ 
                                score: currentScore + 3,
                                breakdown: newBreakdown
                            });
                        }
                    });
                });
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàÿØÿßŸÑ
                const peersList = document.getElementById('peersList');
                const items = peersList.querySelectorAll('.peer-item');
                
                items.forEach(item => {
                    const nameInItem = item.querySelector('.peer-details h4').textContent;
                    
                    if (nameInItem === req.confirmer) {
                        item.className = 'peer-item confirmed';
                        item.innerHTML = `
                            <div class="peer-info">
                                <div class="peer-avatar">‚úì</div>
                                <div class="peer-details">
                                    <h4>${req.confirmer}</h4>
                                    <p>ÿ™ŸÖ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ! +3 ŸÜŸÇÿßÿ∑ üéâ</p>
                                </div>
                            </div>
                            <div class="peer-action">
                                <span>‚úÖ</span>
                            </div>
                        `;
                    }
                });
                
                showNotification('ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∂Ÿàÿ±ŸÉ! +3 ŸÜŸÇÿßÿ∑ ÿ•ÿ∂ÿßŸÅŸäÿ© üéä');
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                
                // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©
                db.ref("confirmation_requests").off('value');
                
                // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑ ÿ®ÿπÿØ 3 ÿ´ŸàÿßŸÜŸä
                setTimeout(() => {
                    closePeerModal();
                }, 3000);
            }
        });
    });
}

// ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑ
function closePeerModal() {
    const modal = document.getElementById('peerConfirmationModal');
    modal.style.display = 'none';
    db.ref("confirmation_requests").off('value');
}

// ÿπÿ±ÿ∂ ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸÖÿπŸÑŸÇÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä
function checkPendingConfirmations() {
    const currentName = document.getElementById('attendanceNameSelect').value;
    if (!currentName) return;
    
    db.ref("confirmation_requests").once('value', snap => {
        const pendingRequests = [];
        
        snap.forEach(child => {
            const req = child.val();
            if (req.confirmer === currentName && req.status === 'pending') {
                pendingRequests.push({
                    key: child.key,
                    ...req
                });
            }
        });
        
        if (pendingRequests.length > 0) {
            showPendingConfirmationsNotification(pendingRequests);
        }
    });
}

// ŸÖÿ±ÿßŸÇÿ®ÿ© ŸÖÿ≥ÿ™ŸÖÿ±ÿ© ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸàÿßÿ±ÿØÿ© (Real-time)
let confirmationListener = null;

function startPendingConfirmationsListener(userName) {
    if (!userName) return;
    
    // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ÿ•ŸÜ Ÿàÿ¨ÿØÿ™
    if (confirmationListener) {
        db.ref("confirmation_requests").off('value', confirmationListener);
    }
    
    // ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ¨ÿØŸäÿØÿ©
    confirmationListener = db.ref("confirmation_requests").on('value', snap => {
        const pendingRequests = [];
        
        snap.forEach(child => {
            const req = child.val();
            if (req.confirmer === userName && req.status === 'pending') {
                pendingRequests.push({
                    key: child.key,
                    ...req
                });
            }
        });
        
        // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ´ÿßÿ®ÿ™ÿ©
        displayPersistentNotifications(pendingRequests);
    });
}

// ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ´ÿßÿ®ÿ™ÿ©
function displayPersistentNotifications(requests) {
    const container = document.getElementById('persistentNotificationsContainer');
    container.innerHTML = '';
    
    requests.forEach(req => {
        const notifCard = document.createElement('div');
        notifCard.className = 'persistent-notification-card';
        notifCard.id = 'persistent-notif-' + req.key;
        
        notifCard.innerHTML = `
            <div class="persistent-notification-header-row">
                <div class="persistent-notification-title">
                    <span class="pulse-icon">üì©</span>
                    ÿ∑ŸÑÿ® ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∂Ÿàÿ± ŸÇÿØÿßÿ≥
                </div>
            </div>
            <div class="persistent-notification-body">
                <div class="persistent-notification-sender">${req.requester}</div>
                ÿπÿßŸàÿ≤ŸÉ ÿ™ÿ£ŸÉÿØŸÑŸá ÿ•ŸÜŸá ŸÉÿßŸÜ ÿ≠ÿßÿ∂ÿ± ÿßŸÑŸÇÿØÿßÿ≥ ŸÖÿπÿßŸÉ
            </div>
            <div class="persistent-notification-actions">
                <button class="persistent-notif-btn persistent-notif-accept" onclick="respondToPersistentRequest('${req.key}', '${req.requester}', 'confirmed')">
                    ‚úÖ ÿ£ÿ£ŸÉÿØ ÿ≠ÿ∂Ÿàÿ±Ÿá
                </button>
                <button class="persistent-notif-btn persistent-notif-reject" onclick="respondToPersistentRequest('${req.key}', '${req.requester}', 'rejected')">
                    ‚ùå ŸÖŸÉŸÜÿ¥ ŸÖŸàÿ¨ŸàÿØ
                </button>
            </div>
        `;
        
        container.appendChild(notifCard);
    });
    
    // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿ•ÿ¥ÿπÿßÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿ∑ŸÑÿ®ÿßÿ™ ÿ¨ÿØŸäÿØÿ©
    if (requests.length > 0) {
        playNotificationSound();
    }
}

// ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿ∑ŸÑÿ® ŸÖŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ´ÿßÿ®ÿ™
function respondToPersistentRequest(requestKey, requesterName, status) {
    // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®
    db.ref(`confirmation_requests/${requestKey}`).update({
        status: status,
        respondedAt: Date.now()
    });
    
    if (status === 'confirmed') {
        showNotification(`ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∂Ÿàÿ± ${requesterName} ŸÅŸä ÿßŸÑŸÇÿØÿßÿ≥! ‚úÖ`);
        if (typeof confetti !== 'undefined') {
            confetti({ particleCount: 100, spread: 60, origin: { y: 0.7 } });
        }
    } else {
        showNotification('ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ∑ŸÑÿ®');
    }
    
    // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ŸÖŸÜ ÿßŸÑÿ¥ÿßÿ¥ÿ© ŸÖÿπ ÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ
    const notifCard = document.getElementById('persistent-notif-' + requestKey);
    if (notifCard) {
        notifCard.style.animation = 'slideOutUp 0.3s ease';
        setTimeout(() => notifCard.remove(), 300);
    }
}

// ÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿ•ÿ¥ÿπÿßÿ±
function playNotificationSound() {
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUA0PVK3n77BdGAg+ltryxnMpBSh+zPLaizsIGGS57OihUhELTKXh8bllHAU2jdXzzn0vBSqBzvDYijcIGWm98OScTgwNU6vk8bdlHQU5k9jyz3swBSl/zvPaizwIGGa88OOdUQ4OVrLn77RgGgg9m9vwv3ElBTGHzO/TgjgHHW/C7+CWTw0NVrPp67RgGgdBndvywHInBTOHzO/Rgj');
        audio.volume = 0.3;
        audio.play().catch(() => {});
    } catch(e) {}
}

// ÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ± ÿ®ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸÖÿπŸÑŸÇÿ©
function showPendingConfirmationsNotification(requests) {
    const count = requests.length;
    const message = `ŸÑÿØŸäŸÉ ${count} ÿ∑ŸÑÿ®${count > 1 ? 'ÿßÿ™' : ''} ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∂Ÿàÿ± ŸÖÿπŸÑŸÇ${count > 1 ? 'ÿ©' : ''}`;
    
    // ÿ•ŸÜÿ¥ÿßÿ° ÿ•ÿ¥ÿπÿßÿ± ŸÇÿßÿ®ŸÑ ŸÑŸÑŸÜŸÇÿ±
    const notification = document.createElement('div');
    notification.className = 'pending-confirmation-notification';
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: white;
        padding: 15px 20px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(251,191,36,0.4);
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        z-index: 9999;
        animation: slideInRight 0.5s ease;
        max-width: 300px;
    `;
    notification.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:24px;">üîî</span>
            <div>
                <div>${message}</div>
                <div style="font-size:11px; opacity:0.9; margin-top:3px;">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑŸÖÿ±ÿßÿ¨ÿπÿ©</div>
            </div>
        </div>
    `;
    
    notification.onclick = () => {
        showConfirmationRequestsModal(requests);
        notification.remove();
    };
    
    document.body.appendChild(notification);
    
    // ÿµŸàÿ™ ÿ™ŸÜÿ®ŸäŸá (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREbVqzp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREOX6345m4cBjiR2fPJeCYFKH3L8t+TQgoVYLjq7J9OAQZIM+Dvwm0gBTGH0fPTgjMGHm7A7+OZUREcVqrt7KkWhcNTKHZ8cmCKwcZarzu66RQEQ==');
        audio.volume = 0.3;
        audio.play().catch(() => {}); // ÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿµŸàÿ™ ŸÖŸÖŸÜŸàÿπ
    } catch(e) {}
    
    setTimeout(() => {
        notification.remove();
    }, 10000);
}

// ÿπÿ±ÿ∂ ŸÖŸàÿØÿßŸÑ ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ
function showConfirmationRequestsModal(requests) {
    const modal = document.getElementById('peerConfirmationModal');
    const peersList = document.getElementById('peersList');
    const modalHeader = modal.querySelector('.modal-header');
    
    modalHeader.innerHTML = `
        <h3>üìã ÿ∑ŸÑÿ®ÿßÿ™ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∂Ÿàÿ±</h3>
        <p>ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∂Ÿàÿ± ÿ≤ŸÖŸÑÿßÿ¶ŸÉ ŸÖÿπŸÉ ŸÅŸä ÿßŸÑŸÇÿØÿßÿ≥</p>
    `;
    
    peersList.innerHTML = '';
    
    requests.forEach(req => {
        const peerItem = document.createElement('div');
        peerItem.className = 'peer-item';
        peerItem.innerHTML = `
            <div class="peer-info">
                <div class="peer-avatar">${req.requester.charAt(0)}</div>
                <div class="peer-details">
                    <h4>${req.requester}</h4>
                    <p>Ÿäÿ±ŸäÿØ ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∂Ÿàÿ±Ÿá ŸÅŸä ÿßŸÑŸÇÿØÿßÿ≥</p>
                    <div style="font-size:11px; opacity:0.8; margin-top:4px;">
                        ${new Date(req.timestamp).toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'})}
                    </div>
                </div>
            </div>
            <div class="peer-action">
                <span>ÿ™ÿ£ŸÉŸäÿØ</span>
                <span>‚úÖ</span>
            </div>
        `;
        peerItem.onclick = () => confirmPeerAttendance(req.key, req.requester);
        peersList.appendChild(peerItem);
    });
    
    modal.style.display = 'block';
}

// ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∂Ÿàÿ± ÿ≤ŸÖŸäŸÑ
function confirmPeerAttendance(requestKey, requesterName) {
    // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®
    db.ref(`confirmation_requests/${requestKey}`).update({
        status: 'confirmed',
        confirmedAt: Date.now()
    });
    
    // ‚ùå ÿßŸÑŸÖÿ§ŸÉŸêŸëÿØ ŸÑÿß Ÿäÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÜŸÇÿßÿ∑ (ŸÖŸÜÿπÿßŸã ŸÑŸÑÿ™ÿ®ÿßÿØŸÑ)
    // ÿßŸÑŸáÿØŸÅ ŸÖŸÜ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ ŸáŸà ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµÿØŸÇ ŸÅŸÇÿ∑ÿå ŸàŸÑŸäÿ≥ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©
    
    const confirmerName = document.getElementById('attendanceNameSelect').value;
    
    showNotification(`ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∂Ÿàÿ± ${requesterName}! ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÖÿ≥ÿßÿπÿØÿ™ŸÉ üôè`);
    confetti({ particleCount: 100, spread: 60, origin: { y: 0.7 } });
    
    closePeerModal();
}

// ===== SESSION CHECK ON LOAD =====
window.addEventListener('DOMContentLoaded', function() {
    // Restore theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.setAttribute('data-theme','dark');
        document.getElementById('themeBtn').innerText = "üåô ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿØÿßŸÉŸÜ";
    }

    const lastLogin = localStorage.getItem('session_login_time');
    const loginType = localStorage.getItem('session_login_type');

    if (lastLogin) {
        const timePassed = Date.now() - parseInt(lastLogin);
        const hours24 = 24 * 60 * 60 * 1000;
        if (timePassed < hours24) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            if (loginType === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminData();
            }
            startApp();
            showRandomVerse();
            
            // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ¢ÿÆÿ± ÿßÿ≥ŸÖ ŸÖÿ≠ŸÅŸàÿ∏
            const savedUserName = localStorage.getItem('selected_user_name');
            if (savedUserName) {
                console.log('üîî ÿ®ÿØÿ° ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', savedUserName);
                startPendingConfirmationsListener(savedUserName);
            }
            // jihadDisplay removed - will show only when button clicked
        } else {
            localStorage.removeItem('session_login_time');
            localStorage.removeItem('session_login_type');
        }
    }
});

// ===== TOGGLE CARD VIEW =====
function toggleCardView(cardElement) {
    cardElement.classList.toggle('expanded');
}

// ===== ŸÜÿ∏ÿßŸÖ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ÿ¥ÿ¨Ÿäÿπ =====

function checkEncouragementMessages() {
    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ©
    const userName = localStorage.getItem('selected_user_name');
    console.log('üîç Checking messages for:', userName);
    if (!userName) {
        console.log('‚ùå No user name found');
        return;
    }
    
    db.ref("encouragement_messages").orderByChild("to").equalTo(userName)
        .once("value", snap => {
            const unreadMessages = [];
            snap.forEach(child => {
                const msg = child.val();
                console.log('üì® Found message:', msg);
                if (!msg.read) {
                    unreadMessages.push({
                        id: child.key,
                        ...msg
                    });
                }
            });
            
            console.log('üì¨ Total unread messages:', unreadMessages.length);
            
            if (unreadMessages.length > 0) {
                showEncouragementBadge(unreadMessages.length);
                // ÿπÿ±ÿ∂ ÿ£ŸàŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÅŸÇÿ∑
                showEncouragementPopup(unreadMessages[0]);
            } else {
                console.log('‚úÖ No unread messages');
                // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ®ÿßÿØÿ¨ ŸÑŸà ŸÖŸÅŸäÿ¥ ÿ±ÿ≥ÿßÿ¶ŸÑ
                const badge = document.getElementById('encouragementBadge');
                if (badge) badge.style.display = 'none';
            }
        });
}

// ÿØÿßŸÑÿ© ÿ¨ÿØŸäÿØÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©
function showNextEncouragementMessage() {
    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ©
    const userName = localStorage.getItem('selected_user_name');
    if (!userName) return;
    
    db.ref("encouragement_messages").orderByChild("to").equalTo(userName)
        .once("value", snap => {
            const unreadMessages = [];
            snap.forEach(child => {
                const msg = child.val();
                if (!msg.read) {
                    unreadMessages.push({
                        id: child.key,
                        ...msg
                    });
                }
            });
            
            if (unreadMessages.length > 0) {
                showEncouragementBadge(unreadMessages.length);
                showEncouragementPopup(unreadMessages[0]);
            } else {
                // ŸÖŸÅŸäÿ¥ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ™ÿßŸÜŸäÿ© - ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ®ÿßÿØÿ¨
                const badge = document.getElementById('encouragementBadge');
                if (badge) badge.style.display = 'none';
            }
        });
}

function showEncouragementBadge(count) {
    let badge = document.getElementById('encouragementBadge');
    if (!badge) {
        badge = document.createElement('div');
        badge.id = 'encouragementBadge';
        badge.className = 'encouragement-badge';
        badge.onclick = () => {
            // ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿ®ÿßÿØÿ¨ÿå ÿßÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©
            showNextEncouragementMessage();
        };
        document.body.appendChild(badge);
    }
    badge.innerHTML = `<div style="font-size:20px; margin-bottom:2px;">üíå</div><div style="font-size:12px;">${count} ${count === 1 ? 'ÿ±ÿ≥ÿßŸÑÿ©' : 'ÿ±ÿ≥ÿßÿ¶ŸÑ'}</div>`;
    badge.style.display = 'block';
    badge.title = 'ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ';
}

function showEncouragementPopup(message) {
    // ÿ•ÿ≤ÿßŸÑÿ© ÿ£Ÿä ŸÜÿßŸÅÿ∞ÿ© ŸÖŸàÿ¨ŸàÿØÿ©
    const existingPopup = document.querySelector('.encouragement-popup');
    if (existingPopup) existingPopup.remove();
    
    const popup = document.createElement('div');
    popup.className = 'encouragement-popup';
    popup.innerHTML = `
        <button class="close-btn" onclick="closeEncouragementPopup('${message.id}')">‚úï</button>
        <div style="font-size:48px; text-align:center; margin-bottom:10px;">üíô</div>
        <div style="font-size:22px; font-weight:900; color:white; text-align:center; margin-bottom:15px;">
            ÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑÿÆÿØÿßŸÖ
        </div>
        <div class="message-content">${message.message.replace(/\n/g, '<br>')}</div>
        <div class="from-tag">üíù ŸÖŸÜ: ${message.from}</div>
        <div style="text-align:center; margin-top:15px;">
            <button onclick="closeEncouragementPopup('${message.id}')" style="background:rgba(255,255,255,0.25); color:white; border:none; padding:10px 25px; border-radius:25px; font-weight:700; cursor:pointer; font-family:'Cairo',sans-serif; font-size:14px; transition:0.3s;">
                ÿ™ŸÖÿßŸÖÿå ÿ¥ŸÉÿ±Ÿãÿß! üôè
            </button>
        </div>
    `;
    document.body.appendChild(popup);
    
    // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿ™ŸÜÿ®ŸäŸá ŸÑÿ∑ŸäŸÅ
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch(e) {
        // ÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑÿÆÿ∑ÿ£ ŸÑŸà ÿßŸÑÿµŸàÿ™ ŸÖÿ¥ ŸÖÿØÿπŸàŸÖ
    }
    
    // ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÉŸàŸÜŸÅŸäÿ™Ÿä
    if (typeof confetti !== 'undefined') {
        confetti({ particleCount: 80, spread: 60, origin: { y: 0.4 } });
    }
}

function closeEncouragementPopup(messageId) {
    const popup = document.querySelector('.encouragement-popup');
    if (popup) {
        popup.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            popup.remove();
            // ÿπŸÑŸëŸÖ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÉŸÖŸÇÿ±Ÿàÿ°ÿ©
            markMessageAsRead(messageId);
            // ÿßÿ≥ÿ™ŸÜŸâ ŸÜÿµ ÿ´ÿßŸÜŸäÿ© Ÿàÿ®ÿπÿØŸäŸÜ ÿßÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© ŸÑŸà ŸÖŸàÿ¨ŸàÿØÿ©
            setTimeout(() => {
                showNextEncouragementMessage();
            }, 500);
        }, 300);
    }
}

function markMessageAsRead(messageId) {
    db.ref(`encouragement_messages/${messageId}`).update({ read: true });
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ÿßÿØÿ¨
    const userName = localStorage.getItem('selected_user_name');
    if (!userName) return;
    
    db.ref("encouragement_messages").orderByChild("to").equalTo(userName)
        .once("value", snap => {
            let unreadCount = 0;
            snap.forEach(child => {
                if (!child.val().read) unreadCount++;
            });
            
            const badge = document.getElementById('encouragementBadge');
            if (unreadCount === 0) {
                if (badge) badge.style.display = 'none';
            } else {
                showEncouragementBadge(unreadCount);
            }
        });
}

// ÿØÿßŸÑÿ© ŸÑÿ™ÿ£ŸÉŸäÿØ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿßÿ≥ŸÖ
function confirmNameSelection() {
    const nameSelect = document.getElementById('nameSelect');
    const selectedName = nameSelect?.value;
    
    if (!selectedName) {
        alert('ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿßÿÆÿ™ÿ± ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã!');
        return;
    }
    
    // ÿ≠ŸÅÿ∏ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    currentUserName = selectedName;
    currentUserId = getUserId(selectedName);
    
    // ÿ≠ŸÅÿ∏ ÿßŸÑÿßÿ≥ŸÖ
    localStorage.setItem('selected_user_name', selectedName);
    localStorage.setItem('user_id', currentUserId);
    
    // ÿ•ÿÆŸÅÿßÿ° ŸÇÿ≥ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿßÿ≥ŸÖ
    document.getElementById('nameSelectionSection').style.display = 'none';
    
    // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ®
    showWelcomeMessage(selectedName);
    
    // ÿπÿ±ÿ∂ ÿßŸÑÿßÿ≥ŸÖ ŸÅŸä ÿßŸÑŸáŸäÿØÿ±
    displayUserNameInHeader(selectedName);
    
    // ŸÉŸàŸÜŸÅŸäÿ™Ÿä ÿßÿ≠ÿ™ŸÅÿßŸÑŸä
    if (typeof confetti !== 'undefined') {
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    }
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ÿ¥ÿ¨Ÿäÿπ ÿ®ÿπÿØ 2 ÿ´ÿßŸÜŸäÿ©
    setTimeout(checkEncouragementMessages, 2000);
    
    // ÿ®ÿØÿ° ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ ŸÅŸàÿ±ÿßŸã
    startPendingConfirmationsListener(selectedName);
}

// ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ®
function showWelcomeMessage(name) {
    const welcomeSection = document.getElementById('welcomeMessageSection');
    const welcomeText = document.getElementById('welcomeText');
    
    if (welcomeSection && welcomeText) {
        welcomeText.innerHTML = `ÿ£ŸáŸÑÿßŸã Ÿäÿß ${name}! üéâ`;
        welcomeSection.style.display = 'block';
        
        // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ®ÿπÿØ 10 ÿ´ŸàÿßŸÜŸä
        setTimeout(() => {
            welcomeSection.style.animation = 'fadeOutUp 0.8s ease';
            setTimeout(() => {
                welcomeSection.style.display = 'none';
                welcomeSection.style.animation = 'slideDown 0.8s ease'; // ÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿßŸÑÿ£ÿµŸÑŸä
            }, 800);
        }, 10000);
    }
}

// ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿßÿ≥ŸÖ ŸÅŸä ÿßŸÑŸáŸäÿØÿ± ÿ®ÿ¥ŸÉŸÑ ŸÖÿ™ÿ≠ÿ±ŸÉ
function displayUserNameInHeader(name) {
    const userNameDisplay = document.getElementById('userNameDisplay');
    if (userNameDisplay) {
        userNameDisplay.innerHTML = `üë§ ${name}`;
        userNameDisplay.style.display = 'block';
        // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ£ÿ´Ÿäÿ± ÿ∏ŸáŸàÿ±
        userNameDisplay.style.animation = 'slideInRight 0.8s ease, wave 2s ease-in-out 0.8s infinite';
    }
}

// ÿØÿßŸÑÿ© ŸÑÿ™ÿ∫ŸäŸäÿ± ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (Ÿäÿ≠ÿØÿ´ ŸÅŸÇÿ∑ ÿπŸÜÿØ ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠)
function changeUserName() {
    // ÿ•ÿÆŸÅÿßÿ° ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ®
    document.getElementById('welcomeMessageSection').style.display = 'none';
    
    // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿßÿ≥ŸÖ ŸÖŸÜ ÿßŸÑŸáŸäÿØÿ±
    document.getElementById('userNameDisplay').style.display = 'none';
    
    // ÿ•ÿ∏Ÿáÿßÿ± ŸÇÿ≥ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿßÿ≥ŸÖ
    document.getElementById('nameSelectionSection').style.display = 'block';
    
    // ŸÖÿ≥ÿ≠ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏
    localStorage.removeItem('selected_user_name');
}

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿßÿ≥ŸÖ
const nameSelectElement = document.getElementById('nameSelect');
if (nameSelectElement) {
    // ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    const savedName = localStorage.getItem('selected_user_name');
    const savedId = localStorage.getItem('user_id');
    
    if (savedName && savedId) {
        // ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
        currentUserName = savedName;
        currentUserId = savedId;
        
        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿßÿ≥ŸÖ ŸÖÿ≠ŸÅŸàÿ∏ÿå ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ® ŸÖÿ®ÿßÿ¥ÿ±ÿ©
        setTimeout(() => {
            showWelcomeMessage(savedName);
            displayUserNameInHeader(savedName);
            checkEncouragementMessages();
            // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
            initializeNewFeatures();
            
            // ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿßŸÑÿ¨ÿØŸäÿØÿ©
            startCheckingForNewStories();
        }, 1000);
    } else {
        // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ÿßÿ≥ŸÖ ŸÖÿ≠ŸÅŸàÿ∏ÿå ÿ•ÿ∏Ÿáÿßÿ± ŸÇÿ≥ŸÖ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±
        document.getElementById('nameSelectionSection').style.display = 'block';
    }
}

// ========== ÿØŸàÿßŸÑ ÿßŸÑŸÖŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ==========

// ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
function initializeNewFeatures() {
    // ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿßÿ±ÿßÿ™ ŸÅŸÇÿ∑
    setTimeout(() => {
        document.getElementById('badgesSection').style.display = 'block';
    }, 800);
    
    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
    loadUserBadges();
}

// ÿ™ÿ≠ŸÖŸäŸÑ ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
function loadUserBadges() {
    const savedBadges = JSON.parse(localStorage.getItem('userBadges') || '[]');
    const container = document.getElementById('userBadgesContainer');
    const section = document.getElementById('badgesSection');
    
    if (savedBadges.length === 0) {
        // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÇÿ≥ŸÖ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ŸÑŸà ŸÖŸÅŸäÿ¥ ÿ¥ÿßÿ±ÿßÿ™
        section.style.display = 'none';
    } else {
        section.style.display = 'block';
        container.innerHTML = '';
        savedBadges.forEach(badge => {
            const badgeEl = document.createElement('div');
            badgeEl.className = `achievement-badge badge-${badge.type}`;
            badgeEl.innerHTML = `${badge.icon} ${badge.title}`;
            badgeEl.title = badge.description || badge.title;
            container.appendChild(badgeEl);
        });
    }
}

// ÿ•ÿ∂ÿßŸÅÿ© ÿ¥ÿßÿ±ÿ© ÿ¨ÿØŸäÿØÿ©
function addBadge(id, title, type, icon = 'üèÜ', description = '') {
    const savedBadges = JSON.parse(localStorage.getItem('userBadges') || '[]');
    
    // ÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ¥ÿßÿ±ÿ© ŸÖŸàÿ¨ŸàÿØÿ© ÿ®ÿßŸÑŸÅÿπŸÑ
    if (savedBadges.some(b => b.id === id)) {
        return;
    }
    
    const newBadge = { id, title, type, icon, description };
    savedBadges.push(newBadge);
    localStorage.setItem('userBadges', JSON.stringify(savedBadges));
    
    loadUserBadges();
    showNotification(`${icon} ÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ ÿ¥ÿßÿ±ÿ© ÿ¨ÿØŸäÿØÿ©: ${title}!`);
}




// ÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ± ÿ™ŸÅÿßÿπŸÑŸä
function showNotification(message) {
    const notification = document.getElementById('interactiveNotification');
    const notificationText = document.getElementById('notificationText');
    
    notificationText.textContent = message;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.5s ease';
        setTimeout(() => {
            notification.style.display = 'none';
            notification.style.animation = 'notificationSlide 0.5s ease, notificationBounce 2s ease-in-out infinite';
        }, 500);
    }, 3000);
}

// ÿ•ÿ∂ÿßŸÅÿ© ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ÿπŸÜÿØ ÿ£ŸàŸÑ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ
function initializeDefaultBadges() {
    const savedBadges = JSON.parse(localStorage.getItem('userBadges') || '[]');
    
    if (savedBadges.length === 0) {
        // ÿ¥ÿßÿ±ÿ© ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ®
        addBadge('welcome', 'ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ', 'blue', 'üëã', 'ÿßŸÜÿ∂ŸÖŸÖÿ™ ŸÑÿÆÿØŸÖÿ© ÿ•ÿπÿØÿßÿØŸä');
    }
}

// ÿ™ÿ≠ÿØŸäÿ´ ÿØÿßŸÑÿ© confirmNameSelection ŸÑÿ™ÿ¥ŸÖŸÑ ÿßŸÑŸÖŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
const originalConfirmNameSelection = confirmNameSelection;
confirmNameSelection = function() {
    originalConfirmNameSelection();
    
    // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
    setTimeout(() => {
        initializeNewFeatures();
        initializeDefaultBadges();
        loadJournalEntries(); // ÿ™ÿ≠ŸÖŸäŸÑ ŸäŸàŸÖŸäÿßÿ™ ÿßŸÑÿ®ÿ±ŸÉÿßÿ™
        
        // ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        startCheckingForNewStories();
    }, 1500);
};

// ========== ÿØŸàÿßŸÑ ŸäŸàŸÖŸäÿßÿ™ ÿ®ÿ±ŸÉÿßÿ™ ÿ±ÿ®ŸÜÿß ŸÖÿπÿßŸäÿß ==========

let selectedFeeling = '';
let selectedFeelingText = '';
let sharingOption = 'private'; // ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
let lastCheckedStoryTimestamp = 0;
let notificationCheckInterval = null;

// ÿ™ÿ®ÿØŸäŸÑ ÿπÿ±ÿ∂ ŸÇÿ≥ŸÖ ÿßŸÑŸäŸàŸÖŸäÿßÿ™
function toggleJournalSection(isChecked) {
    const section = document.getElementById('blessingsJournalSection');
    const sharedSection = document.getElementById('sharedStoriesSection');
    
    if (isChecked) {
        section.style.display = 'block';
        sharedSection.style.display = 'block';
        loadJournalEntries();
        loadSharedStories();
        
        // ÿπŸÑŸëŸÖ ŸÉŸÑ ÿßŸÑŸÖŸàÿßŸÇŸÅ ŸÉŸÖŸÇÿ±Ÿàÿ°ÿ©
        markAllStoriesAsRead();
        
        // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        updateJournalNotificationBadge(0);
    } else {
        section.style.display = 'none';
        sharedSection.style.display = 'none';
    }
}

// ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿßŸÑÿ¨ÿØŸäÿØÿ©
function startCheckingForNewStories() {
    // ÿ™ÿ≠ŸÖŸäŸÑ ÿ¢ÿÆÿ± ŸàŸÇÿ™ ÿ™ÿ≠ŸÇŸÇ
    lastCheckedStoryTimestamp = parseInt(localStorage.getItem('lastCheckedStoryTime') || '0');
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÉŸÑ 10 ÿ´ŸàÿßŸÜŸä
    notificationCheckInterval = setInterval(() => {
        checkForNewStories();
    }, 10000);
    
    // ÿ™ÿ≠ŸÇŸÇ ŸÅŸàÿ±Ÿä ÿπŸÜÿØ ÿßŸÑÿ®ÿØÿßŸäÿ©
    setTimeout(() => checkForNewStories(), 3000);
}

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿßŸÑÿ¨ÿØŸäÿØÿ©
function checkForNewStories() {
    const userName = localStorage.getItem('selected_user_name');
    if (!userName) return;
    
    db.ref('shared_stories').orderByChild('timestamp').startAt(lastCheckedStoryTimestamp + 1).once('value', snapshot => {
        if (!snapshot.exists()) return;
        
        let newStoriesCount = 0;
        let latestStory = null;
        
        snapshot.forEach(child => {
            const story = child.val();
            // ÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿßŸÑÿÆÿßÿµÿ© ÿ®ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÜŸÅÿ≥Ÿá
            if (story.author !== userName) {
                newStoriesCount++;
                if (!latestStory || story.timestamp > latestStory.timestamp) {
                    latestStory = story;
                }
            }
        });
        
        if (newStoriesCount > 0) {
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ÿßÿØÿ¨
            updateJournalNotificationBadge(newStoriesCount);
            
            // ÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÜÿ®ÿ´ŸÇ ŸÑŸÑŸÖŸàŸÇŸÅ ÿßŸÑÿ£ÿ≠ÿØÿ´
            if (latestStory) {
                showNewStoryNotification(latestStory, newStoriesCount);
            }
        }
    });
}

// ÿ™ÿ≠ÿØŸäÿ´ badge ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
function updateJournalNotificationBadge(count) {
    const badge = document.getElementById('journalNotificationBadge');
    if (!badge) return;
    
    if (count > 0) {
        badge.textContent = count === 1 ? '1 ÿ¨ÿØŸäÿØ' : `${count} ÿ¨ÿØÿØ`;
        badge.style.display = 'inline-block';
    } else {
        badge.style.display = 'none';
    }
}

// ÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ± ŸÖŸàŸÇŸÅ ÿ¨ÿØŸäÿØ
function showNewStoryNotification(story, count) {
    const notification = document.getElementById('newStoryNotification');
    const notificationText = document.getElementById('newStoryNotificationText');
    
    if (!notification || !notificationText) return;
    
    const authorName = story.displayName || 'ÿ¥ÿÆÿµ ŸÖÿπÿßŸÉŸÖ';
    const countText = count > 1 ? ` Ÿà ${count - 1} ŸÖŸàŸÇŸÅ ÿ¢ÿÆÿ±` : '';
    
    notificationText.innerHTML = `
        <strong>${authorName}</strong> ÿ¥ÿßÿ±ŸÉ ŸÖŸàŸÇŸÅ ÿ¨ÿØŸäÿØ${countText}!
        <div style="font-size:12px; margin-top:4px; opacity:0.9;">"${story.title}"</div>
    `;
    
    notification.style.display = 'block';
    
    // ŸÉŸàŸÜŸÅŸäÿ™Ÿä ÿÆŸÅŸäŸÅ
    if (typeof confetti !== 'undefined') {
        confetti({ 
            particleCount: 50, 
            spread: 50, 
            origin: { x: 0.9, y: 0.2 },
            colors: ['#10b981', '#059669', '#34d399']
        });
    }
    
    // ÿ•ÿÆŸÅÿßÿ° ÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ®ÿπÿØ 8 ÿ´ŸàÿßŸÜŸä
    setTimeout(() => {
        closeStoryNotification();
    }, 8000);
}

// ÿ•ÿ∫ŸÑÿßŸÇ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖŸàŸÇŸÅ
function closeStoryNotification() {
    const notification = document.getElementById('newStoryNotification');
    if (notification) {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            notification.style.display = 'none';
            notification.style.animation = 'slideInRight 0.5s ease';
        }, 300);
    }
}

// ŸÅÿ™ÿ≠ ŸÇÿ≥ŸÖ ÿßŸÑŸäŸàŸÖŸäÿßÿ™ ŸÖŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
function openJournalFromNotification() {
    closeStoryNotification();
    
    // ŸÅÿ™ÿ≠ ÿßŸÑÿ≥ŸàŸäÿ™ÿ¥
    const switchInput = document.querySelector('.switch-container input[type="checkbox"]');
    if (switchInput && !switchInput.checked) {
        switchInput.checked = true;
        toggleJournalSection(true);
    }
    
    // ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿßŸÑŸÖÿ¥ÿ™ÿ±ŸÉÿ©
    setTimeout(() => {
        const sharedSection = document.getElementById('sharedStoriesSection');
        if (sharedSection) {
            sharedSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 300);
}

// ÿ™ÿπŸÑŸäŸÖ ŸÉŸÑ ÿßŸÑŸÖŸàÿßŸÇŸÅ ŸÉŸÖŸÇÿ±Ÿàÿ°ÿ©
function markAllStoriesAsRead() {
    db.ref('shared_stories').orderByChild('timestamp').limitToLast(1).once('value', snapshot => {
        if (snapshot.exists()) {
            let latestTimestamp = 0;
            snapshot.forEach(child => {
                latestTimestamp = child.val().timestamp;
            });
            
            lastCheckedStoryTimestamp = latestTimestamp;
            localStorage.setItem('lastCheckedStoryTime', latestTimestamp.toString());
        }
    });
}

// ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸàÿπ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©
function selectSharingOption(option) {
    sharingOption = option;
}

// ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ŸÉÿ™ÿßÿ®ÿ© ŸÖŸàŸÇŸÅ ÿ¨ÿØŸäÿØ
function openJournalEntryModal() {
    document.getElementById('journalEntryModal').style.display = 'block';
    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ
    document.getElementById('journalTitle').value = '';
    document.getElementById('journalContent').value = '';
    document.getElementById('journalVerse').value = '';
    selectedFeeling = '';
    selectedFeelingText = '';
    sharingOption = 'private';
    
    // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿÆŸäÿßÿ± ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
    document.querySelectorAll('input[name="sharing"]').forEach(radio => {
        radio.checked = (radio.value === 'private');
    });
    
    // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿØ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ¥ÿßÿπÿ±
    document.querySelectorAll('.feeling-option').forEach(btn => {
        btn.classList.remove('selected');
    });
}

// ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ŸÉÿ™ÿßÿ®ÿ© ŸÖŸàŸÇŸÅ
function closeJournalEntryModal() {
    document.getElementById('journalEntryModal').style.display = 'none';
}

// ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ¥ÿßÿπÿ±
function selectFeeling(feeling, feelingText) {
    selectedFeeling = feeling;
    selectedFeelingText = feelingText;
    
    // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿØ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
    document.querySelectorAll('.feeling-option').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ≤ÿ± ÿßŸÑŸÖÿÆÿ™ÿßÿ±
    event.target.closest('.feeling-option').classList.add('selected');
}

// ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇŸÅ
function saveJournalEntry() {
    const title = document.getElementById('journalTitle').value.trim();
    const content = document.getElementById('journalContent').value.trim();
    const verse = document.getElementById('journalVerse').value.trim();
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    if (!selectedFeeling) {
        alert('ÿßÿÆÿ™ÿßÿ± ÿ•ÿ≠ÿ≥ÿßÿ≥ŸÉ ÿßŸÑÿ£ŸàŸÑ üí≠');
        return;
    }
    
    if (!title) {
        alert('ÿßŸÉÿ™ÿ® ÿπŸÜŸàÿßŸÜ ŸÑŸÑŸÖŸàŸÇŸÅ üìå');
        return;
    }
    
    if (!content) {
        alert('ÿßŸÉÿ™ÿ® ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸàŸÇŸÅ ‚úçÔ∏è');
        return;
    }
    
    const userName = localStorage.getItem('selected_user_name') || 'ŸÖÿ¨ŸáŸàŸÑ';
    
    // ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿßÿ¶ŸÜ ÿßŸÑŸÖŸàŸÇŸÅ
    const entry = {
        id: Date.now(),
        feeling: selectedFeeling,
        feelingText: selectedFeelingText,
        title: title,
        content: content,
        verse: verse,
        sharing: sharingOption,
        author: userName,
        date: new Date().toLocaleDateString('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }),
        timestamp: Date.now()
    };
    
    // ÿ≠ŸÅÿ∏ ŸÅŸä LocalStorage ÿßŸÑÿÆÿßÿµ
    let entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
    entries.unshift(entry);
    localStorage.setItem('journalEntries', JSON.stringify(entries));
    
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ¥ÿ™ÿ±ŸÉÿå ÿ≠ŸÅÿ∏Ÿá ŸÅŸä Firebase
    if (sharingOption === 'named' || sharingOption === 'anonymous') {
        const sharedEntry = {
            ...entry,
            displayName: sharingOption === 'named' ? userName : 'ÿ¥ÿÆÿµ ŸÖÿπÿßŸÉŸÖ'
        };
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
        db.ref('shared_stories').push(sharedEntry);
    }
    
    // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
    closeJournalEntryModal();
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
    loadJournalEntries();
    if (sharingOption !== 'private') {
        setTimeout(() => loadSharedStories(), 500);
    }
    
    // ŸÉŸàŸÜŸÅŸäÿ™Ÿä ÿßÿ≠ÿ™ŸÅÿßŸÑŸä
    if (typeof confetti !== 'undefined') {
        confetti({ particleCount: 100, spread: 60, origin: { y: 0.6 } });
    }
    
    // ÿ•ÿ¥ÿπÿßÿ±
    const shareMsg = sharingOption === 'private' ? '' : ' Ÿàÿ™ŸÖ ŸÖÿ¥ÿßÿ±ŸÉÿ™Ÿá ŸÖÿπ ÿßŸÑŸÖÿÆÿØŸàŸÖŸäŸÜ üíö';
    showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇŸÅ ÿ®ŸÜÿ¨ÿßÿ≠!' + shareMsg);
    
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ¥ÿßÿ±ÿ© ÿπŸÜÿØ ÿ£ŸàŸÑ ŸÖŸàŸÇŸÅ
    if (entries.length === 1) {
        addBadge('first_journal', 'ÿ£ŸàŸÑ ŸäŸàŸÖŸäÿ©', 'gold', 'üìî', 'ŸÉÿ™ÿ®ÿ™ ÿ£ŸàŸÑ ŸÖŸàŸÇŸÅ ŸÅŸä ŸäŸàŸÖŸäÿßÿ™ŸÉ');
    }
    
    // ÿ¥ÿßÿ±ÿ© ÿπŸÜÿØ ÿ£ŸàŸÑ ŸÖÿ¥ÿßÿ±ŸÉÿ©
    if (sharingOption !== 'private') {
        const sharedCount = entries.filter(e => e.sharing !== 'private').length;
        if (sharedCount === 1) {
            addBadge('first_share', 'ŸÖÿ¥ÿßÿ±ŸÉ ŸÖÿ®ÿßÿ±ŸÉ', 'blue', 'üíö', 'ÿ¥ÿßÿ±ŸÉÿ™ ŸÖŸàŸÇŸÅ ŸÖÿπ ÿßŸÑŸÖÿÆÿØŸàŸÖŸäŸÜ');
        }
    }
    
    // ÿ¥ÿßÿ±ÿ© ÿπŸÜÿØ 5 ŸÖŸàÿßŸÇŸÅ
    if (entries.length === 5) {
        addBadge('five_journals', 'ŸÉÿßÿ™ÿ® ŸÜÿ¥Ÿäÿ∑', 'silver', '‚úçÔ∏è', 'ŸÉÿ™ÿ®ÿ™ 5 ŸÖŸàÿßŸÇŸÅ');
    }
    
    // ÿ¥ÿßÿ±ÿ© ÿπŸÜÿØ 10 ŸÖŸàÿßŸÇŸÅ
    if (entries.length === 10) {
        addBadge('ten_journals', 'ŸÖÿ§ŸÑŸÅ ŸäŸàŸÖŸäÿßÿ™', 'gold', 'üìñ', 'ŸÉÿ™ÿ®ÿ™ 10 ŸÖŸàÿßŸÇŸÅ');
    }
}

// ÿ™ÿ≠ŸÖŸäŸÑ Ÿàÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿßŸÇŸÅ
function loadJournalEntries(filterFeeling = 'all') {
    const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
    const container = document.getElementById('journalEntriesContainer');
    
    if (entries.length === 0) {
        container.innerHTML = `
            <div class="empty-journal" style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                <div style="font-size:70px; margin-bottom:12px; animation: bounce 2s infinite;">üìî</div>
                <p style="font-size:16px; font-weight:600; color:var(--text-primary); margin-bottom:6px;">ŸÑÿ≥Ÿá ŸÖŸÉÿ™ÿ®ÿ™ÿ¥ ÿ£Ÿä ŸÖŸàŸÇŸÅ</p>
                <p style="font-size:13px;">ÿßÿ®ÿØÿ£ ÿØŸÑŸàŸÇÿ™Ÿä ŸàÿßŸÉÿ™ÿ® ÿ£ŸàŸÑ ŸÖŸàŸÇŸÅ ÿ±ÿ®ŸÜÿß ŸàŸÇŸÅ ŸÖÿπÿßŸÉ ŸÅŸäŸá üíù</p>
            </div>
        `;
        return;
    }
    
    // ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ¥ÿßÿπÿ±
    const filteredEntries = filterFeeling === 'all' 
        ? entries 
        : entries.filter(e => e.feeling === filterFeeling);
    
    if (filteredEntries.length === 0) {
        container.innerHTML = `
            <div class="empty-journal" style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                <div style="font-size:50px; margin-bottom:12px;">üîç</div>
                <p style="font-size:15px; font-weight:600; color:var(--text-primary);">ŸÖŸÅŸäÿ¥ ŸÖŸàÿßŸÇŸÅ ÿ®ÿßŸÑŸÖÿ¥ÿßÿπÿ± ÿØŸä</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    filteredEntries.forEach(entry => {
        // ÿ™ÿ≠ÿØŸäÿØ ÿ£ŸäŸÇŸàŸÜÿ© ŸàŸÑŸàŸÜ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©
        let sharingIcon = '';
        let sharingText = '';
        let sharingColor = '';
        
        if (entry.sharing === 'named') {
            sharingIcon = 'üë§';
            sharingText = 'ŸÖÿ¥ÿßÿ±ŸÉ ÿ®ÿßÿ≥ŸÖŸÉ';
            sharingColor = '#10b981';
        } else if (entry.sharing === 'anonymous') {
            sharingIcon = 'üé≠';
            sharingText = 'ŸÖÿ¥ÿßÿ±ŸÉ ŸÉŸÄ "ÿ¥ÿÆÿµ ŸÖÿπÿßŸÉŸÖ"';
            sharingColor = '#3b82f6';
        } else {
            sharingIcon = 'üîí';
            sharingText = 'ÿÆÿßÿµ';
            sharingColor = '#718096';
        }
        
        const card = document.createElement('div');
        card.className = 'journal-entry-card';
        card.innerHTML = `
            <div class="journal-entry-header">
                <div class="journal-entry-feeling">${entry.feelingText.split(' ')[0]}</div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
                    <div class="journal-entry-date">${entry.date}</div>
                    <div style="font-size:11px; font-weight:600; color:${sharingColor};">
                        ${sharingIcon} ${sharingText}
                    </div>
                </div>
            </div>
            <div class="journal-entry-title">${entry.title}</div>
            <div class="journal-entry-content">${entry.content}</div>
            ${entry.verse ? `<div class="journal-entry-verse">üìñ ${entry.verse}</div>` : ''}
            <div class="journal-entry-actions">
                <button class="journal-action-btn journal-delete-btn" onclick="deleteJournalEntry(${entry.id})">
                    üóëÔ∏è ÿßÿ≠ÿ∞ŸÅ
                </button>
            </div>
        `;
        container.appendChild(card);
    });
}

// ÿ≠ÿ∞ŸÅ ŸÖŸàŸÇŸÅ
function deleteJournalEntry(entryId) {
    if (!confirm('ŸÖÿ™ÿ£ŸÉÿØ ÿ•ŸÜŸÉ ÿπÿßŸàÿ≤ ÿ™ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸàŸÇŸÅ ÿØŸáÿü')) {
        return;
    }
    
    let entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
    entries = entries.filter(e => e.id !== entryId);
    localStorage.setItem('journalEntries', JSON.stringify(entries));
    
    loadJournalEntries();
    showNotification('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸàŸÇŸÅ üóëÔ∏è');
}

// ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ¥ÿßÿπÿ±
function filterJournalByFeeling(feeling) {
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
    document.querySelectorAll('.filter-feeling-btn').forEach(btn => {
        btn.classList.remove('filter-active');
    });
    event.target.classList.add('filter-active');
    
    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿßŸÑŸÖŸÅŸÑÿ™ÿ±ÿ©
    loadJournalEntries(feeling);
}

// ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿßŸÇŸÅ ÿßŸÑŸÖÿ¥ÿ™ÿ±ŸÉÿ© ŸÖŸÜ Firebase
function loadSharedStories() {
    const container = document.getElementById('sharedStoriesContainer');
    
    db.ref('shared_stories').orderByChild('timestamp').limitToLast(20).once('value', snapshot => {
        if (!snapshot.exists()) {
            container.innerHTML = `
                <div class="empty-journal" style="text-align:center; padding:30px 20px; color:var(--text-secondary);">
                    <div style="font-size:60px; margin-bottom:12px;">üí¨</div>
                    <p style="font-size:15px; font-weight:600; color:var(--text-primary);">ŸÑÿ≥Ÿá ŸÖÿ≠ÿØÿ¥ ÿ¥ÿßÿ±ŸÉ ŸÖŸàÿßŸÇŸÅŸá</p>
                    <p style="font-size:12px; margin-top:6px;">ŸÉŸÜ ÿ£ŸàŸÑ Ÿàÿßÿ≠ÿØ Ÿäÿ¥ÿßÿ±ŸÉ ŸÖŸàŸÇŸÅ ÿ±ÿ®ŸÜÿß ŸÖÿπÿßŸá üåü</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        const stories = [];
        
        snapshot.forEach(child => {
            stories.push({
                key: child.key,
                ...child.val()
            });
        });
        
        // ÿ™ÿ±ÿ™Ÿäÿ® ŸÖŸÜ ÿßŸÑÿ£ÿ≠ÿØÿ´ ŸÑŸÑÿ£ŸÇÿØŸÖ
        stories.reverse();
        
        stories.forEach(story => {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'shared-story-message';
            messageDiv.innerHTML = `
                <div class="shared-story-header">
                    <div class="shared-story-author">
                        <span class="shared-story-feeling">${story.feelingText.split(' ')[0]}</span>
                        ${story.displayName}
                    </div>
                    <div class="shared-story-date">${formatRelativeTime(story.timestamp)}</div>
                </div>
                <div class="shared-story-title">${story.title}</div>
                <div class="shared-story-content">${story.content}</div>
                ${story.verse ? `<div class="shared-story-verse">üìñ ${story.verse}</div>` : ''}
            `;
            container.appendChild(messageDiv);
        });
        
        // ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ£ÿ≥ŸÅŸÑ (ÿ£ÿ≠ÿØÿ´ ÿ±ÿ≥ÿßŸÑÿ©)
        container.scrollTop = container.scrollHeight;
    });
}

// ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÜÿ≥ÿ®Ÿä
function formatRelativeTime(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'ÿßŸÑÿ¢ŸÜ';
    if (minutes < 60) return `ŸÖŸÜÿ∞ ${minutes} ÿØŸÇŸäŸÇÿ©`;
    if (hours < 24) return `ŸÖŸÜÿ∞ ${hours} ÿ≥ÿßÿπÿ©`;
    if (days < 7) return `ŸÖŸÜÿ∞ ${days} ŸäŸàŸÖ`;
    
    return new Date(timestamp).toLocaleDateString('ar-EG', {
        month: 'short',
        day: 'numeric'
    });
}

// ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸäŸàŸÖŸäÿßÿ™ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
window.addEventListener('load', () => {
    setTimeout(() => {
        loadJournalEntries();
    }, 2000);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ¨ÿ®ÿßÿ±Ÿä ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±ÿ© ŸÑÿ£ŸÖÿ± ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ
db.ref('force_update_trigger').on('value', snapshot => {
    const trigger = snapshot.val();
    const lastUpdate = localStorage.getItem('last_force_update');
    
    if (trigger && trigger.timestamp && String(trigger.timestamp) !== lastUpdate) {
        // ÿ£ŸÖÿ± ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ÿØŸäÿØ ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ!
        
        // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        const updateMsg = document.createElement('div');
        updateMsg.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 30px 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 999999;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.5);
            font-family: 'Cairo', sans-serif;
            font-size: 16px;
            font-weight: 700;
            animation: fadeInScale 0.3s ease;
        `;
        updateMsg.innerHTML = `
            üîÑ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ...<br>
            <small style="font-size:13px; opacity:0.9; font-weight:500;">ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿßŸÜÿ™ÿ∏ÿ±...</small>
        `;
        document.body.appendChild(updateMsg);
        
        // ŸÖÿ≥ÿ≠ ÿßŸÑŸÄ Cache
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
            });
        }
        
        // ÿ≠ŸÅÿ∏ timestamp ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
        localStorage.setItem('last_force_update', String(trigger.timestamp));
        
        // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ©
        setTimeout(() => {
            location.reload(true);
        }, 1000);
    }
});

// CSS Animation
const updateStyle = document.createElement('style');
updateStyle.textContent = `
    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
    }
`;
document.head.appendChild(updateStyle);

</script>
</body>
</html>
